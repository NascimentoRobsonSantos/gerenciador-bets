<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Download de Mídia</title>
    <style>
        :root {
            --bg-color: #18191a;
            --text-color: #e4e6eb;
            --card-bg-color: #242526;
            --border-color: #3a3b3c;
            --btn-download-bg: #cebd26;
            --btn-text-color: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; /* Espaçamento entre o logo e o título */
           /* margin-bottom: 5px;  Margem inferior reduzida */
        }
        .header h2 { font-weight: 200; font-size: 1.2rem; }
        .logo-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .btn-download {
            background-color: #a1941e; /* Cor marrom/dourada do seu logo */
        }

        .btn-whatsapp {
            background-color: #199647; /* Cor verde do WhatsApp */
        }
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 250px;
            margin-bottom: 5px;
        }
        .media-container {
            width: 100%;
            height: auto;
            aspect-ratio: 9 / 16;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-color);
            overflow: hidden;
            position: relative;
        }
        .media-container .media-item {
            width: 100%;
            height: 100%;
            display: none; /* Escondido por padrão */
        }
        .media-container .media-item.active {
            display: block; /* Mostra o item ativo */
        }
        .media-container img, .media-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 25px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-arrow.prev { left: 10px; }
        .carousel-arrow.next { right: 10px; }
        .card-buttons { display: flex; flex-direction: column; gap: 12px; }
        button {
            cursor: pointer; padding: 10px 12px; border-radius: 8px; border: none;
            color: var(--btn-text-color); font-size: 1rem; font-weight: 550;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.7; }
        .btn-download { background-color: var(--btn-download-bg); }
        .loading-overlay-full {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); color: white;
            z-index: 9999; flex-direction: column; justify-content: center; align-items: center;
        }
        .loading-overlay-full.active { display: flex; }
    </style>
</head>
<body>

    <div class="header">
        <img id="pageLogo" src="" alt="Logo" class="logo-image">
        <h2 id="pageTitle">Download de Arquivos</h2>
    </div>

    <div id="downloadCardContainer"></div>
    <div id="loadingOverlayFull" class="loading-overlay-full"><p>Carregando...</p></div>

    <script>
        const API_URLS = {
            GET_SINGLE_POST: "https://webhook.storeprodigital.site/webhook/download-file-media"
        };
        const loadingOverlay = document.getElementById('loadingOverlayFull');

        function showLoading(message = "Carregando...") {
            if (loadingOverlay) {
                loadingOverlay.querySelector('p').textContent = message;
                loadingOverlay.classList.add('active');
            }
        }
        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }

        async function handleDownloadMedia(mediaUrl) {
            if (!mediaUrl) {
                alert('Nenhum arquivo de mídia para baixar.');
                return;
            }

            const fileName = mediaUrl.split('/').pop();
            showLoading("Preparando download...");

            try {
                const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
                
                const response = await fetch(mediaUrl);
                if (!response.ok) throw new Error('Falha ao buscar a mídia.');
                const blob = await response.blob();

                // Se for mobile e a API de compartilhamento existir, usa ela
                if (isMobile && navigator.share) {
                    const file = new File([blob], fileName, { type: blob.type });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Salvar Mídia',
                        });
                        hideLoading();
                        return; // Sucesso no mobile, encerra aqui
                    }
                }

                // Fallback para desktop (ou mobile sem API de share) - FORÇA O DOWNLOAD
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url); // Limpa a memória

            } catch (error) {
                console.error('Erro no download:', error);
                if (error.name !== 'AbortError') {
                alert('Não foi possível iniciar o download. Tente novamente.');
                }
            } finally {
                hideLoading();
            }
        }
        
        function renderSinglePostCard(targetDiv, item) {
            currentItem = item;
            const card = document.createElement('div');
            card.className = 'card';

            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'media-container';
            
            // Inverte a ordem do array media_urls
            const urls = [...(item.media_urls || [])].reverse();
            let currentIndex = 0;

            urls.forEach((url, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'media-item';
                if (index === 0) {
                    itemDiv.classList.add('active');
                }
                if (url.endsWith('.mp4') || url.endsWith('.mov')) {
                    itemDiv.innerHTML = `<video src="${url}" controls></video>`;
                } else {
                    itemDiv.innerHTML = `<img src="${url}" alt="Mídia">`;
                }
                mediaContainer.appendChild(itemDiv);
            });

            if (urls.length > 1) {
                mediaContainer.innerHTML += `
                    <button class="carousel-arrow prev">&#10094;</button>
                    <button class="carousel-arrow next">&#10095;</button>
                `;
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-buttons';
            
            // --- BOTÃO DO GRUPO VIP ADICIONADO AQUI ---
            contentDiv.innerHTML = `
                <button id="btnJoinVip" class="btn-whatsapp">Entrar no Grupo Vip</button>
            `;
            
            card.appendChild(mediaContainer);
            card.appendChild(contentDiv);
            targetDiv.innerHTML = '';
            targetDiv.appendChild(card);

            // Lógica do Carrossel e Botão de Download
            const mediaItems = card.querySelectorAll('.media-item');
            
            function updateDownloadButton() {
                // Encontra o botão de entrar no grupo para não removê-lo
                const vipButton = contentDiv.querySelector('#btnJoinVip');
                contentDiv.innerHTML = ''; // Limpa botões antigos
                
                const currentMediaSrc = mediaItems[currentIndex].querySelector('img, video')?.src;
                if (currentMediaSrc) {
                    const downloadButton = document.createElement('button');
                    downloadButton.id = 'btnDownloadMedia';
                    downloadButton.className = 'btn-download';
                    downloadButton.textContent = 'Baixar Mídia Atual';
                    downloadButton.addEventListener('click', () => handleDownloadMedia(currentMediaSrc));
                    contentDiv.appendChild(downloadButton); // Adiciona o botão de download
                }
                if (vipButton) {
                    contentDiv.appendChild(vipButton); // Readiciona o botão VIP
                }
            }

            if (urls.length > 1) {
                card.querySelector('.prev').addEventListener('click', () => {
                    mediaItems[currentIndex].classList.remove('active');
                    currentIndex = (currentIndex > 0) ? currentIndex - 1 : mediaItems.length - 1;
                    mediaItems[currentIndex].classList.add('active');
                    updateDownloadButton();
                });
                card.querySelector('.next').addEventListener('click', () => {
                    mediaItems[currentIndex].classList.remove('active');
                    currentIndex = (currentIndex < mediaItems.length - 1) ? currentIndex + 1 : 0;
                    mediaItems[currentIndex].classList.add('active');
                    updateDownloadButton();
                });
            }
            
            updateDownloadButton(); // Gera o(s) botão(ões) para o primeiro item
            
            // Listener para o botão do grupo VIP
            document.getElementById('btnJoinVip').addEventListener('click', () => {
                window.open('https://chat.whatsapp.com/EQXc8JagROKEdbpmAwUT20', '_blank');
            });
        }

        async function loadMedia() {
            const container = document.getElementById('downloadCardContainer');
            showLoading();
            try {
                const params = new URLSearchParams(window.location.hash.split('?')[1] || window.location.search);
                const postId = params.get('id');
                const socialMedia = params.get('social_media');


                if (!postId || !socialMedia) throw new Error("Parâmetros inválidos na URL.");

                const endpoint = `${API_URLS.GET_SINGLE_POST}?id=${postId}&social_media=${socialMedia}`;
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error(`Erro ao buscar mídia: ${response.statusText}`);
                
                const item = await response.json();
                if (!item || !item.id) throw new Error("Mídia não encontrada.");

                // --- CORREÇÃO APLICADA AQUI ---
                // Pega o logo e o nome da conta diretamente da resposta da API
                if (item.url_logo) {
                    document.getElementById('pageLogo').src = item.url_logo;
                }
                if (item.account_name) {
                    document.getElementById('pageTitle').textContent = item.account_name;
                }
                
                renderSinglePostCard(container, item);
            } catch (error) {
                container.innerHTML = `<p style="text-align:center; color: #ff8a8a;">${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadMedia();
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.body.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
            document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });
        });
    </script>
</body>
</html>