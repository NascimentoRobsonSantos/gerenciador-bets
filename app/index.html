<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gerenciador de Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset Básico e Variáveis de Tema */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1c1e21;
            --card-bg-color: #ffffff;
            --header-bg-color: #ffffff;
            --border-color: #ddd;
            --input-bg-color: #ffffff;
            --input-border-color: #ccc;
            --hover-bg-color: #e4e6eb;
            --hover-darker-bg-color: #d8dbdf;
            --sidebar-hover-bg: #f0f2f5;
            --active-menu-bg: #e7f3ff;
            --active-menu-text: #1877f2;
            --stats-bg-color: #f0f2f5;
            --stats-border-color: #e0e0e0;
        }

        body.dark-theme {
            --bg-color: #18191a;
            --text-color: #e4e6eb;
            --card-bg-color: #242526;
            --header-bg-color: #242526;
            --border-color: #3a3b3c;
            --input-bg-color: #3a3b3c;
            --input-border-color: #4d4d4d;
            --hover-bg-color: #3a3b3c;
            --hover-darker-bg-color: #4d4d4d;
            --sidebar-hover-bg: #3a3b3c;
            --active-menu-bg: #3a3b3c;
            --active-menu-text: #2d88ff;
            --stats-bg-color: #3a3b3c;
            --stats-border-color: #4d4d4d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- TELAS DE LOGIN E REGISTRO --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .auth-box {
            width: 100%;
            max-width: 400px;
            padding: 30px;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .auth-box h2 {
            margin-bottom: 20px;
        }
        .auth-box .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .auth-box input {
            margin-bottom: 0;
        }
        #login-error, #register-error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 10px;
            min-height: 1.2rem;
            display: block;
        }
        .auth-switch {
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .auth-switch a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        .auth-switch a:hover {
            text-decoration: underline;
        }


        /* --- LAYOUT DA APLICAÇÃO --- */
        .app-container {
            display: none; /* Inicia oculto */
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            background-color: var(--header-bg-color);
            color: var(--text-color);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-left a {
            text-decoration: none;
            color: inherit;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .menu-toggle-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .app-body {
            display: flex;
            flex-grow: 1;
            margin-top: 60px; /* Altura do header */
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background-color: var(--card-bg-color);
            padding: 20px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out, background-color 0.3s, border-color 0.3s;
            z-index: 1002;
        }
        
        body.sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }

        .sidebar-menu .menu-group > .menu-parent {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-color);
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
        }
        .sidebar-menu .menu-group > .menu-parent:hover {
            background-color: var(--sidebar-hover-bg);
        }
        .sidebar-menu .menu-group > .menu-parent::after {
            content: '▼';
            font-size: 0.7rem;
            transition: transform 0.2s ease;
        }
        .sidebar-menu .menu-group > .menu-parent.collapsed::after {
            transform: rotate(-90deg);
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow: hidden;
            max-height: 1000px; /* Altura grande para permitir a animação */
            transition: max-height 0.4s ease-in-out;
        }

        .sidebar-menu ul.collapsed {
            max-height: 0;
        }

        .sidebar-menu .submenu-item {
            padding: 8px 12px 8px 25px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .sidebar-menu .submenu-item:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .sidebar-menu .submenu-item.active {
            background-color: var(--active-menu-bg);
            color: var(--active-menu-text);
            font-weight: 600;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 280px;
            overflow-y: auto;
            height: 100%;
            transition: margin-left 0.3s ease-in-out;
            -webkit-overflow-scrolling: touch; /* Melhora scroll no iOS */
        }
        
        body.sidebar-collapsed .main-content {
            margin-left: 0;
        }
        
        .sidebar-actions {
            margin-top: 20px; /* Adiciona algum espaçamento */
            /* display: block; ou display: flex; flex-direction: column; para vertical */
            display: block; /* Torna o grupo visível sempre */
            padding: 10px; /* Adicione padding para o grupo se precisar */
            border: 1px solid var(--border-color); /* Para visualização */
            border-radius: 8px; /* Para visualização */
            background-color: var(--card-bg-color); /* Para visualização */
        }

        .sidebar-actions ul {
            display: flex;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            gap: 10px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-actions .submenu-item {
            flex-grow: 1; /* Permite que os itens preencham o espaço */
            text-align: center;
            padding: 8px 12px; /* Ajuste o padding para botões */
            /* ... outros estilos de botão existentes ... */
        }

        #existingLinksList {
            max-height: 180px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            padding: 10px; 
            border-radius: 4px; 
            background-color: var(--bg-color); /* USA A VARIÁVEL DE TEMA */
        }

        @media (max-width: 992px) { 
            .main-content { margin-left: 0; }
            .sidebar { transform: translateX(-100%); }
            body.sidebar-collapsed .sidebar {
                transform: translateX(0);
            }
            .settings-container { display: none; }
            .sidebar-actions { display: block; }
            .sidebar-actions ul { flex-direction: column; }
        }

        button {
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            background-color: var(--hover-bg-color);
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: var(--hover-darker-bg-color);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        textarea { min-height: 100px; resize: vertical; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; }
        #contentDisplayArea, #socialAccountsContentArea, #whatsappGroupsContentArea, #companiesContentArea, #usersContentArea, #dashboardContentArea { min-height: 400px; }
        #socialAccountsContentArea, #whatsappGroupsContentArea, #companiesContentArea, #usersContentArea, #dashboardContentArea { display: none; } /* Oculto por padrão */

        .grid-container, .stats-grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        @media (max-width: 1600px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 1300px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1100px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-container, .stats-grid-container { grid-template-columns: 1fr; } }

        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card .media-content { 
            width: 100%; 
            height: auto; 
            aspect-ratio: 5 / 8;
            border-radius: 6px; 
            margin-bottom: 10px; 
            background-color: var(--bg-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            position: relative;
        }
        .card .media-content span { color: #888; font-size: 0.9rem; }
        .card .media-content img, .card .media-content video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-buttons { margin-top: auto; display: flex; flex-direction: column; gap: 8px; }
        .card-buttons button { width: 100%; }

        .play-button-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .play-button-overlay:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .play-button-overlay svg {
            width: 60px;
            height: 60px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .list-item-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; width: 100%; margin-bottom: 10px; }
        .list-item-stats p { 
            margin: 0; 
            padding: 5px; 
            background-color: var(--stats-bg-color); 
            border-radius: 4px; 
            border: 1px solid var(--stats-border-color);
            color: var(--text-color);
            font-size: 0.75rem; 
            text-align: center; 
            word-break: break-word; 
        }
        
        .btn-save { background-color: #28a745; color: white; }
        .btn-save:hover { background-color: #218838; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-link { background-color: #17a2b8; color: white; }
        .btn-link:hover { background-color: #138496; }
        .btn-instagram-post { background-color: #E1306C; color: white; }
        .btn-instagram-post:hover { background-color: #c12c61; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #1EBE57; }
        .btn-copy { background-color: #6c757d; color: white; }
        .btn-copy:hover { background-color: #5a6268; }
        .btn-youtube-upload { background-color: #FF0000; color: white; } 
        .btn-youtube-upload:hover { background-color: #c40000; } 
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 450px; position: relative; }
        .modal-content.modal-lg { max-width: 800px; }
        
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--text-color); }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; background: none; border: none; cursor: pointer; color: #888; }
        .modal-close-btn:hover { color: var(--text-color); }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions .btn-cancel { background-color: #6c757d; color: white; }
        .modal-actions .btn-cancel:hover { background-color: #5a6268; }
        .modal-actions .btn-confirm { background-color: #007bff; color: white; }
        .modal-actions .btn-confirm:hover { background-color: #0056b3; }
        #lista-palavras { margin-bottom: 15px; font-size: 14px; color: var(--text-color); padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; max-height: 100px; overflow-y: auto; }
        #customNumberInputContainer { display: none; margin-top: 10px; }
        .input-container-relative { position: relative; margin-bottom: 10px; }
        .input-com-botao { padding-right: 45px !important; }
        .paste-btn { position: absolute; top: 50%; right: 5px; transform: translateY(-50%); padding: 4px 8px; height: 28px; font-size: 12px; z-index: 2; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .paste-btn:hover { background-color: #e0e0e0; }

        .loading-overlay-full { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); color: white; font-size: 20px; text-align: center; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
        .loading-overlay-full.active { display: flex; }

        #scrollTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000; background-color: #007bff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        #scrollTopBtn:hover { background-color: #0056b3; }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pagination-controls button {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .pagination-controls span {
            font-size: 1rem;
            font-weight: bold;
        }
        #itemsPerPageSelector {
            width: auto;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            border-radius: 0.25rem;
            cursor: pointer;
        }

        @media (max-width: 520px) {
            .pagination-container {
                flex-direction: column;
                gap: 20px;
            }
            #itemsPerPageSelector {
                order: -1; /* Move o seletor para cima */
                width: 100%;
                max-width: 200px;
                text-align: center;
            }
        }

        /* --- ESTILOS PARA TABELAS (WhatsApp e Contas) --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .filters-container {
            background-color: var(--card-bg-color);
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
        }
        .filters-container label {
            font-size: 0.8rem;
        }
        .filters-container input, .filters-container select {
            margin-bottom: 0;
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .data-table th {
            background-color: var(--bg-color);
            font-weight: 600;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background-color: var(--hover-bg-color);
        }
        .data-table td .action-buttons {
            width: 100%;
            justify-content: flex-end;
            gap: 8px; 
            padding-top: 10px;
        }
        .data-table td .action-buttons button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .data-table td a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        .data-table td a:hover {
            text-decoration: underline;
        }
        .data-table td .wpp-image-container {
            cursor: pointer;
        }
        .data-table td img.table-image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            cursor: pointer;
        }
        .data-table .validated-icon {
            color: #28a745;
            font-weight: bold;
        }
        
        /* Modal de Edição/Criação WhatsApp e Post Agendado */
        .edit-modal-body {
            display: flex;
            gap: 20px;
        }
        .edit-modal-form { flex: 2; }
        .edit-modal-form div { margin-bottom: 5px; }
        .edit-modal-form textarea { margin-bottom: 5px; }
        .edit-modal-preview { flex: 1; text-align: center; }
        .edit-modal-preview img, .edit-modal-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            object-fit: contain;
        }

        /* Estilos responsivos para a tabela do WhatsApp */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            .page-header .header-actions {
                display: flex;
                justify-content: flex-end; /* Alinha o(s) botão(ões) à direita */
            }
            .modal-content, .modal-content.modal-lg {
                max-height: 85vh;
                overflow-y: auto;
            }
            .edit-modal-body { flex-direction: column; }
            .list-item-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            .table-container {
                border: none;
                background-color: transparent;
            }
            .data-table thead {
                display: none;
            }
            .data-table, .data-table tbody, .data-table tr, .data-table td {
                display: block;
                width: 100%;
            }
            .data-table tr {
                margin-bottom: 20px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 15px;
                background-color: var(--card-bg-color);
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .data-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                border-bottom: 1px solid var(--hover-bg-color);
                padding: 10px 5px;
                overflow-wrap: break-word; /* Adicione esta linha */
                word-break: break-all;     /* Adicione esta linha */
            }
            .data-table td:last-child {
                border-bottom: none;
            }
            .data-table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                padding-right: 15px;
            }
            .data-table td[data-label="Mensagem"], .data-table td[data-label="Webhook"] {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                text-align: left;
            }
            .data-table td[data-label="Mensagem"]::before, .data-table td[data-label="Webhook"]::before {
                margin-bottom: 5px;
            }
            .data-table td .action-buttons {
                width: 100%;
                display: flex;
                justify-content: flex-end; /* Alinha os botões à direita */
                gap: 8px;
                padding-top: 10px;
            }
            .data-table td[data-label="Mensagem"], .data-table td[data-label="Webhook"] {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                text-align: left;
                /* ADICIONE ESTAS DUAS LINHAS */
                overflow-wrap: break-word;
                word-break: break-all;
            }
        }

        /* Theme Toggle & Settings Dropdown */
        .settings-container {
            position: relative;
        }
        #settingsBtn {
            background: none;
            border: none;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1010;
            width: 250px;
            overflow: hidden;
        }
        .settings-dropdown.show {
            display: block;
        }
        .settings-dropdown button {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            border-radius: 0;
            border: none;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent;
        }
        .settings-dropdown button:hover {
            background-color: var(--hover-bg-color);
        }
        .settings-dropdown button:last-child {
            border-bottom: none;
        }
        #themeToggle {
            width: 50px;
            height: 26px;
            border-radius: 13px;
            background-color: var(--hover-bg-color);
            position: relative;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        #themeToggle .toggle-circle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        body.dark-theme #themeToggle .toggle-circle {
            transform: translateX(24px);
        }

        /* Estilos para preview de multiplas imagens */
        #media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            min-height: 80px;
        }
        .media-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .media-preview-item img, .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        .remove-media-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* --- ESTILOS DO DASHBOARD --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .chart-card {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--active-menu-text);
        }
        .stat-card .label {
            font-size: 1rem;
            color: var(--text-color);
            margin-top: 5px;
        }
        .media-link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
        }

        .media-link-item:last-child {
            border-bottom: none;
        }

        .media-link-item a {
            color: var(--active-menu-text);
            text-decoration: none;
            word-break: break-all; /* Garante que links longos quebrem a linha */
        }

        .media-link-item a:hover {
            text-decoration: underline;
        }

        .media-link-item button {
            flex-shrink: 0; /* Impede que o botão encolha */
            padding: 4px 10px;
            font-size: 0.8rem;
        }

    </style>
</head>

<body>
    <div id="login-container" class="auth-container">
        <div id="login-box" class="auth-box">
            <h2>Login</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="email">E-mail</label>
                    <input type="text" id="email" required>
                </div>
                <div class="input-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Entrar</button>
                <p id="login-error"></p>
                 <p class="auth-switch">Não tem uma conta? <a href="#" id="show-register">Cadastre sua empresa</a></p>
            </form>
        </div>
    </div>

    <div id="register-container" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2>Cadastro de Empresa</h2>
            <form id="register-form">
                <div class="input-group">
                    <label for="reg-name">Nome Completo</label>
                    <input type="text" id="reg-name" required>
                </div>
                <div class="input-group">
                    <label for="reg-email">E-mail</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div class="input-group">
                    <label for="reg-whatsapp">WhatsApp</label>
                    <input type="tel" id="reg-whatsapp" required>
                </div>
                 <div class="input-group">
                    <label for="reg-cnpj-cpf">CNPJ/CPF</label>
                    <input type="text" id="reg-cnpj-cpf" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Cadastrar</button>
                <p id="register-error"></p>
                <p class="auth-switch">Já tem uma conta? <a href="#" id="show-login">Faça login</a></p>
            </form>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <header class="app-header">
            <div class="header-left">
                <button id="menuToggleBtn" class="menu-toggle-btn" title="Alternar menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"></path></svg>
                </button>
                <a href="#/dashboard"><h1>Gerenciador de Posts</h1></a>
            </div>
            <div class="header-right">
                <div class="settings-container">
                    <button id="settingsBtn" class="menu-toggle-btn" title="Configurações">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                        </svg>
                    </button>
                    <div id="settingsDropdown" class="settings-dropdown">
                        </div>
                </div>
            </div>
        </header>
        <div class="app-body">
            <aside id="sidebar" class="sidebar">
            </aside>
            <main class="main-content">
                <div id="dashboardContentArea"></div>
                <div id="contentDisplayArea"></div>
                <div id="socialAccountsContentArea"></div>
                <div id="whatsappGroupsContentArea"></div>
                <div id="companiesContentArea"></div>
                <div id="usersContentArea"></div>
                <div id="paginationContainer" class="pagination-container"></div>
            </main>
        </div>
    </div>

    <div id="modalEditCompany" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditCompany">&times;</button>
            <h3>Editar Dados da Empresa</h3>
            <form id="formEditCompany">
                <input type="hidden" id="editCompanyId">
                <div>
                    <label for="editCompanyName">Nome da Empresa:</label>
                    <input type="text" id="editCompanyName" required>
                </div>
                <div>
                    <label for="editCompanyEmail">E-mail:</label>
                    <input type="email" id="editCompanyEmail" required>
                </div>
                <div>
                    <label for="editCompanyWhatsapp">WhatsApp:</label>
                    <input type="tel" id="editCompanyWhatsapp">
                </div>
                <div>
                    <label for="editCompanyCnpjCpf">CNPJ/CPF:</label>
                    <input type="text" id="editCompanyCnpjCpf">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditCompany">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Dados</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditCompanyModules" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditCompanyModules">&times;</button>
            <h3>Gerenciar Módulos da Empresa</h3>
            <form id="formEditCompanyModules">
                <input type="hidden" id="editCompanyModulesId">
                <p>Empresa: <strong id="editCompanyModulesName"></strong></p>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <label>
                        <input type="checkbox" id="moduleInstagram" style="width:auto; margin-right:5px;"> Instagram
                    </label>
                    <label>
                        <input type="checkbox" id="moduleFacebook" style="width:auto; margin-right:5px;"> Facebook
                    </label>
                    <label>
                        <input type="checkbox" id="moduleThreads" style="width:auto; margin-right:5px;"> Threads
                    </label>
                    <label>
                        <input type="checkbox" id="moduleWhatsapp" style="width:auto; margin-right:5px;"> WhatsApp
                    </label>
                    </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditCompanyModules">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Módulos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals de Contas Sociais -->
    <div id="modalCreateSocialAccount" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalCreateSocialAccount">&times;</button>
            <h3>Criar Nova Conta Social</h3>
            <form id="formCreateSocialAccount">
                <div>
                    <label for="accountType">Rede Social:</label>
                    <select id="accountType" required>
                        <option value="Instagram" selected>Instagram</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Threads">Threads</option>
                    </select>
                </div>
                <div>
                    <label for="accountName">Nome da Conta (para exibição):</label>
                    <input type="text" id="accountName" placeholder="Ex: Carla Indica" required>
                </div>
                <div>
                    <label for="accountOrder">Ordenação (Ex: 1, 2, 3...):</label>
                    <input type="number" id="accountOrder" placeholder="Define a ordem no menu">
                </div>
                <div>
                    <label for="accountToken">Token:</label>
                    <input type="text" id="accountToken" required>
                </div>
                <div>
                    <label for="accountWebhook">Webhook:</label>
                    <input type="text" id="accountWebhook">
                </div>
                <div style="margin-top: 15px;">
                    <input type="checkbox" id="accountValidated" style="width:auto; margin-right:5px;">
                    <label for="accountValidated" style="font-weight:normal; display:inline;">Integração Validada</label>
                </div>
                <button type="button" id="btnOpenFbDev" class="btn-link" style="width: 100%; margin-top: 15px;">Abrir Facebook Developers</button>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCreateSocialAccount">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Conta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditSocialAccount" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditSocialAccount">&times;</button>
            <h3>Editar Conta Social</h3>
            <form id="formEditSocialAccount">
                <input type="hidden" id="editAccountId">
                <div>
                    <label for="editAccountType">Rede Social:</label>
                    <select id="editAccountType" required>
                        <option value="Instagram">Instagram</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Threads">Threads</option>
                    </select>
                </div>
                <div>
                    <label for="editAccountName">Nome da Conta (para exibição):</label>
                    <input type="text" id="editAccountName" placeholder="Ex: Carla Indica" required>
                </div>
                <div>
                    <label for="editAccountOrder">Ordenação (Ex: 1, 2, 3...):</label>
                    <input type="number" id="editAccountOrder" placeholder="Define a ordem no menu">
                </div>
                <div>
                    <label for="editAccountToken">Token:</label>
                    <input type="text" id="editAccountToken" required>
                </div>
                <div>
                    <label for="editAccountWebhook">Webhook:</label>
                    <input type="text" id="editAccountWebhook">
                </div>
                <div style="margin-top: 15px;">
                    <input type="checkbox" id="editAccountValidated" style="width:auto; margin-right:5px;">
                    <label for="editAccountValidated" style="font-weight:normal; display:inline;">Integração Validada</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditSocialAccount">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modals de Links -->
    <div id="modalAddLinks" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalAddLinks">&times;</button>
            <h3>Incluir Links</h3>
            <div id="existingLinksListContainer" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h4>Links Existentes para esta Postagem:</h4>
                <div id="existingLinksList">
                    <p>Carregando links...</p>
                </div>
            </div>
            <form id="formAddLinks">
                <input type="hidden" id="linkFormPostId">
                <div>
                    <label for="linkFormLinkAnuncio">Link do Anúncio:</label>
                    <div class="input-container-relative">
                        <input type="text" id="linkFormLinkAnuncio" class="input-com-botao" required>
                        <button type="button" id="btnPasteLink" class="paste-btn" title="Colar da área de transferência">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1-1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 8 7z"/>
                                <path d="M6.5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="linkFormLoja">Loja:</label>
                    <select id="linkFormLoja" required>
                        <option value="" disabled selected>Selecione uma loja</option>
                        <option value="Shopee">Shopee</option>
                        <option value="Mercado Livre">Mercado Livre</option>
                        <option value="Amazon">Amazon</option>
                    </select>
                </div>
                <div>
                    <label for="linkFormCategoria">Categoria:</label>
                    <input type="text" id="linkFormCategoria">
                </div>
                <div>
                    <label for="linkFormImagem">Imagem do Anúncio (Opcional):</label>
                    <input type="file" id="linkFormImagem" accept="image/*">
                </div>
                <fieldset style="margin-top: 15px; border: 1px solid #eee; padding:10px;">
                    <legend style="font-size:0.9rem; padding:0 5px; width:auto;">Tipo:</legend>
                    <label style="display:inline-block; margin-right:15px; font-weight:normal;"><input type="radio" name="linkFormTipo" value="post" checked> Post</label>
                    <label style="display:inline-block; margin-right:15px; font-weight:normal;"><input type="radio" name="linkFormTipo" value="story"> Story</label>
                    <label style="display:inline-block; margin-right:15px; font-weight:normal;"><input type="radio" name="linkFormTipo" value="reels"> Reels</label>
                    <label style="display:inline-block; font-weight:normal;"><input type="radio" name="linkFormTipo" value="threads"> Threads</label>
                </fieldset>
                <div class="modal-actions">
                    <div style="margin-top: 20px; text-align: center; width:100%; display:flex; justify-content:space-around">
                        <button type="button" id="btnOpenCopyLinkByIdModal" class="btn-copy">Copiar Link por ID</button>
                        <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalAddLinks">Cancelar</button>
                        <button type="submit" class="btn-confirm">Salvar Links</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals Diversos -->
    <div id="modalPalavraComentario" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalPalavraComentario">&times;</button>
            <h3>Nova Palavra para Comentário</h3>
            <div id="lista-palavras-container">
                <strong>Palavras salvas:</strong>
                <div id="lista-palavras">Carregando...</div>
            </div>
            <div>
                <label for="inputNovaPalavra">Digite a nova palavra:</label>
                <input type="text" id="inputNovaPalavra" placeholder="Ex: EU QUERO" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalPalavraComentario">Cancelar</button>
                <button type="button" id="btnSalvarNovaPalavra" class="btn-confirm">Salvar Palavra</button>
            </div>
        </div>
    </div>
    <div id="modalEnviarWhatsApp" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEnviarWhatsApp">&times;</button>
            <h3>Enviar vídeo para WhatsApp</h3>
            <input type="hidden" id="whatsPostId">
            <input type="hidden" id="whatsVideoUrl">
            <div class="whats-options" style="display:flex; flex-direction:column; gap:10px;">
                <button data-number="5511989200952" class="btn-send-direct-whats">Robson</button>
                <button data-number="5511967409954" class="btn-send-direct-whats">Lady</button>
                <button id="btnShowCustomNumberWhats">Outro Número</button>
                <button id="btnCopyVideoLinkWhats">Copiar Link do Vídeo</button>
            </div>
            <div id="customNumberInputContainer">
                <label for="inputCustomNumberWhats">Digite outro número (Ex: 55119...):</label>
                <input type="tel" id="inputCustomNumberWhats" placeholder="55119XXXXXXXX">
                <button id="btnSendCustomNumberWhats" class="btn-confirm" style="width:100%; margin-top:10px;">Enviar</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEnviarWhatsApp">Fechar</button>
            </div>
        </div>
    </div>
    <div id="modalCopyLinkById" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalCopyLinkById">&times;</button>
            <h3>Copiar Link por ID</h3>
            <form id="formCopyLinkById">
                <input type="hidden" id="copyLinkFormPostId">
                <div>
                    <label for="inputCopyLinkId">ID do Link a Copiar:</label>
                    <input type="text" id="inputCopyLinkId" placeholder="Ex: 123" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCopyLinkById">Cancelar</button>
                    <button type="submit" class="btn-confirm">Copiar Link</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalMediaLinks" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalMediaLinks">&times;</button>
            <h3>Links da Mídia</h3>
            <div id="mediaLinksList" style="margin-top: 15px;">
                </div>
            <div class="modal-actions" style="justify-content: flex-end;">
                <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalMediaLinks">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modals de Ofertas WhatsApp -->
    <div id="modalEditWhatsapp" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalEditWhatsapp">&times;</button>
            <h3>Editar Oferta WhatsApp</h3>
            <form id="formEditWhatsapp">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <input type="hidden" id="editWppId">
                        <div>
                            <label for="editWppLoja">Loja:</label>
                            <select id="editWppLoja" required>
                                <option value="Shopee">Shopee</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Amazon">Amazon</option>
                            </select>
                        </div>
                        <div>
                            <label for="editWppMessage">Mensagem:</label>
                            <textarea id="editWppMessage" rows="9" required></textarea>
                        </div>
                        <div>
                            <label for="editWppUrl">URL do Anúncio:</label>
                            <input type="url" id="editWppUrl" required>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label>Pré-visualização da Imagem</label>
                        <img id="editWppImagePreview" src="https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem" alt="Preview da Imagem">
                        <button type="button" id="btnOpenOriginalImage" class="btn-link" style="width:100%; margin-bottom: 10px; display:none;">Abrir Imagem Original</button>
                        <label for="editWppNewImage">Subir Nova Imagem:</label>
                        <input type="file" id="editWppNewImage" accept="image/*">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditWhatsapp">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalCreateWhatsapp" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalCreateWhatsapp">&times;</button>
            <h3>Criar Nova Oferta</h3>
            <form id="formCreateWhatsapp">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <div>
                            <label for="createWppLoja">Loja:</label>
                             <select id="createWppLoja" required>
                                <option value="" disabled selected>Selecione uma loja</option>
                                <option value="Shopee">Shopee</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Amazon">Amazon</option>
                            </select>
                        </div>
                        <div>
                            <label for="createWppMessage">Mensagem:</label>
                            <textarea id="createWppMessage" rows="12" required></textarea>
                        </div>
                        <div>
                            <label for="createWppUrl">URL do Anúncio:</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="url" id="createWppUrl" required style="flex-grow: 1; margin-bottom: 0;">
                                <button type="button" id="btnOpenAdUrl" class="btn-link" style="padding: 5px 10px; font-size: 0.8rem; flex-shrink: 0;">Abrir</button>
                            </div>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label>Pré-visualização da Imagem</label>
                        <img id="createWppImagePreview" src="https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem" alt="Preview da Imagem">
                        <label for="createWppNewImage">Subir Imagem:</label>
                        <input type="file" id="createWppNewImage" accept="image/*">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCreateWhatsapp">Cancelar</button>
                    <button type="submit" class="btn-confirm">Criar Oferta</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalOfferTypeChoice" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalOfferTypeChoice">&times;</button>
            <h3>Como você quer criar a oferta?</h3>
            <div class="modal-actions" style="justify-content: center; gap: 15px;">
                <button id="btnCreateOfferFromLink" class="btn-primary">Gerar por Link</button>
                <button id="btnCreateOfferManually" class="btn-primary">Criar Manualmente</button>
            </div>
        </div>
    </div>
    <div id="modalGenerateFromLink" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalGenerateFromLink">&times;</button>
            <h3>Gerar Oferta a partir de um Link</h3>
            <form id="formGenerateFromLink">
                <div>
                    <label for="generateFromLinkUrl">Link do Anúncio:</label>
                    <div class="input-container-relative">
                        <input type="url" id="generateFromLinkUrl" class="input-com-botao" required>
                        <button type="button" id="btnPasteAndGenerate" class="paste-btn" title="Colar da área de transferência">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1-1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 8 7z"/>
                                <path d="M6.5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="generateFromLinkGroupContainer">
                    <label for="generateFromLinkGroup">Grupo do WhatsApp:</label>
                    <select id="generateFromLinkGroup" required>
                        </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalGenerateFromLink">Cancelar</button>
                    <button type="submit" class="btn-confirm">Gerar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modals de Grupos WhatsApp -->
    <div id="modalWhatsappGroup" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalWhatsappGroup">&times;</button>
            <h3 id="whatsappGroupModalTitle">Criar Novo Grupo</h3>
            <form id="formWhatsappGroup">
                <div>
                    <label for="whatsappGroupName">Nome do Grupo:</label>
                    <input type="text" id="whatsappGroupName" required>
                </div>
                <div>
                    <label for="whatsappGroupOrder">Ordenação:</label>
                    <input type="number" id="whatsappGroupOrder" placeholder="Define a ordem no menu">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalWhatsappGroup">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modalEditWhatsappGroup" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditWhatsappGroup">&times;</button>
            <h3>Editar Grupo</h3>
            <form id="formEditWhatsappGroup">
                <input type="hidden" id="editWhatsappGroupId">
                <div>
                    <label for="editWhatsappGroupName">Nome do Grupo:</label>
                    <input type="text" id="editWhatsappGroupName" required>
                </div>
                <div>
                    <label for="editWhatsappGroupOrder">Ordenação:</label>
                    <input type="number" id="editWhatsappGroupOrder" placeholder="Define a ordem no menu">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditWhatsappGroup">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal de Usuários -->
    <div id="modalUser" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalUser">&times;</button>
            <h3 id="userModalTitle">Criar Novo Login</h3>
            <form id="formUser">
                <input type="hidden" id="userId">
                <div>
                    <label for="userNameInput">Nome:</label>
                    <input type="text" id="userNameInput" required>
                </div>
                <div>
                    <label for="userEmail">E-mail:</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div id="userPasswordField">
                    <label for="userPassword">Senha:</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userIsActiveCheckbox" style="width:auto; margin-right:5px;"> Usuário Ativo
                    </label>
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userAdminCheckbox" style="width:auto; margin-right:5px;"> Administrador
                    </label>
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userDarkThemeCheckbox" style="width:auto; margin-right:5px;"> Tema Escuro
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalUser">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modals de Post Agendado -->
    <div id="modalScheduledPost" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalScheduledPost">&times;</button>
            <h3 id="scheduledPostModalTitle">Criar Nova Postagem</h3>
            <form id="formScheduledPost">
                <input type="hidden" id="scheduledPostId">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <div>
                            <label for="scheduledPostDescription">Descrição:</label>
                            <textarea id="scheduledPostDescription" rows="9" required></textarea>
                        </div>
                        <div>
                            <label for="scheduledPostDateTime">Horário da Postagem:</label>
                            <input type="datetime-local" id="scheduledPostDateTime" step="300" required>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label for="scheduledPostMedia">Imagens/Vídeos:</label>
                        <input type="file" id="scheduledPostMedia" accept="image/*,video/*" multiple>
                        <div id="media-preview-container">
                            <!-- Previews das mídias aparecerão aqui -->
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalScheduledPost">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Postagem</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals de Confirmação e Alerta -->
    <div id="modalAlert" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalAlert">&times;</button>
            <h3 id="modalAlertTitle">Aviso</h3>
            <p id="modalAlertMessage" style="margin-top: 15px;"></p>
            <div class="modal-actions">
                <button id="modalAlertOk" class="btn-confirm modal-close-btn-alternative" data-modal-id="modalAlert">OK</button>
            </div>
        </div>
    </div>
    <div id="modalConfirm" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalConfirmTitle">Confirmação</h3>
            <p id="modalConfirmMessage" style="margin-top: 15px;"></p>
            <div class="modal-actions">
                <button id="modalConfirmCancel" class="btn-cancel">Cancelar</button>
                <button id="modalConfirmOk" class="btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Overlay de Loading -->
    <div id="loadingOverlayFull" class="loading-overlay-full">
        <svg width="50" height="50" viewBox="0 0 50 50">
            <circle cx="25" cy="25" r="20" fill="none" stroke-width="5" stroke="#fff" stroke-linecap="round" transform="rotate(0 25 25)">
                <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                <animate attributeName="stroke-dasharray" values="1,200;89,200;89,200" dur="1.5s" repeatCount="indefinite" />
                <animate attributeName="stroke-dashoffset" values="0;-35;-124" dur="1.5s" repeatCount="indefinite" />
            </circle>
        </svg>
        <p id="loadingOverlayMessage" style="margin-top:15px;">Carregando...</p>
    </div>

    <button id="scrollTopBtn" title="Voltar ao topo">↑</button>

    <!-- Modal para Baixar Novas Postagens -->
    <div id="modalDownloadPosts" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Baixar Novas Postagens</h3>
                <button class="modal-close-btn" data-modal-id="modalDownloadPosts">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formDownloadPosts">
                    <div class="input-group">
                        <label for="downloadType">Tipo de Download:</label>
                        <select id="downloadType" required>
                            <option value="">Selecione...</option>
                            <option value="conta_clone">Link Único</option>
                            <option value="link">Nome da Conta</option>
                        </select>
                    </div>
                    
                    <div class="input-group" id="linkInputGroup" style="display: none;">
                        <label for="downloadLink">Link:</label>
                        <input type="url" id="downloadLink" placeholder="Cole o link aqui...">
                    </div>
                    
                    <div class="input-group" id="contaInputGroup" style="display: none;">
                        <label for="downloadConta">Nome da Conta:</label>
                        <input type="text" id="downloadConta" placeholder="Nome da conta...">
                    </div>
                    
                    <div class="input-group">
                        <label for="downloadMediaType">Tipo:</label>
                        <select id="downloadMediaType" required>
                            <option value="">Selecione...</option>
                            <option value="REELS">Reels</option>
                            <option value="FEED">Feed</option>
                            <option value="STORIES">Stories</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="downloadCategory">Categoria:</label>
                        <input type="text" id="downloadCategory" placeholder="Ex: Especial, Normal">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn-confirm">Baixar Postagens</button>
                        <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalDownloadPosts">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- Configuração e Estado Global ---
        const url_base = "https://webhook.storeprodigital.site/webhook";

        const API_URLS = {
            // Endpoints de Contas
            GET_ACCOUNTS: `${url_base}/social_media_accounts`,
            CREATE_ACCOUNT: `${url_base}/social_media_accounts`,
            UPDATE_ACCOUNT: `${url_base}/social_media_accounts`,
            DELETE_ACCOUNT: `${url_base}/social_media_accounts`,
            
            // Endpoints de Mídia
            SCHEDULED_POSTS: `/posts_scheduled`,
            SCHEDULED_POSTS_CRUD: `${url_base}/posts_scheduled`,
            REELS: `/get-all-reels-base-carla`,
            STORIES: `/get-all-stories-base-carla`,
            STORIES_BASE: `/get-all-storys-base-carla`,
            POSTS: `/get-all-pots-base-carla`,
            WHATSAPP: `/post-group-whatsapp`,

            // Endpoints de Midia Threads
            THREADS_FEED: `/threads_feed`,
            THREADS_BASE_POSTS: `/threads_pots_base`,
            POST_THREADS_MANUAL: `post_schedule_threads_manual`,
            FORCE_UPDATE_THREADS: `/get_threads_all_instagram_carla`,

            // Endpoints de Grupos WhatsApp
            WHATSAPP_GROUPS_CRUD: `${url_base}/whatsapp_groups`,

            // Endpoints de Empresa e Usuários
            COMPANIES_CRUD: `${url_base}/companies`,
            COMPANIES_MODULES_CRUD: `${url_base}/companies_modules`,
            USERS_CRUD: `${url_base}/users`,
            
            // Dashboard
            GET_DASHBOARD_METRICS: `${url_base}/dashboard-metrics`,

            // Outros Endpoints
            LOGIN: `${url_base}/login`,
            LOGOUT: `${url_base}/logout`,
            WHATSAPP_ACTION: `${url_base}/post-group-whatsapp`,
            WHATSAPP_CREATE: `${url_base}/criar-post-group-whatsapp`,
            UPDATE_POST: `${url_base}/update-post`,
            REPOST_STORIES: `${url_base}/repost_story_media`,
            DELETE_REEL: `${url_base}/delete-reel`,
            DELETE_POST: `${url_base}/delete-post`,
            DELETE_STORIES: `${url_base}/delete-stories-base`,
            ADD_LINK: `${url_base}/add-links-postagens`,
            ADD_LINK_BASE64: `${url_base}/add-links-postagens-base64`,
            SEND_WHATS: `${url_base}/send-video-numero-whats-gerenciador`,
            UPLOAD_VIDEO: `${url_base}/add-upload-video-post`,
            POST_INSTAGRAM_MANUAL: `${url_base}/post_schedule_manual`,
            GET_COMMENT_KEY: `${url_base}/get-comment-key-post`,
            ADD_COMMENT_KEY: `${url_base}/add-comment-key-post`,
            FORCE_UPDATE_STORIES: `${url_base}/get_stories_all_instagram_carla`,
            FORCE_UPDATE_REELS: `${url_base}/get_reels_all_instagram_carla`,
            GET_LINKS_POSTAGENS: `${url_base}/get-links-postagens-carla`,
            COPY_LINK_BY_ID: `${url_base}/add-copy-links-postagens-carla`,
            DELETE_LINK: `${url_base}/delete-link-postagem`,
            GENERATE_AD_FROM_LINK: `${url_base}/generate-ad-from-link`,
            DOWNLOAD_MEDIA_POSTAGENS: `${url_base}/download-media-postagens`,
        };

        const MEDIA_TYPES = [
            { key: 'scheduled-posts', label: 'Postar', endpoint: API_URLS.SCHEDULED_POSTS },
            { key: 'reels', label: 'Mídias Reels', endpoint: API_URLS.REELS },
            { key: 'stories', label: 'Mídias Stories', endpoint: API_URLS.STORIES },
            { key: 'posts', label: 'Postagens Base', endpoint: API_URLS.POSTS },
            { key: 'stories-base', label: 'Stories Base', endpoint: API_URLS.STORIES_BASE },
            { key: 'scheduled-threads', label: 'Postar', endpoint: API_URLS.SCHEDULED_POSTS_CRUD }, // Para agendamento
            { key: 'threads-feed', label: 'Feed', endpoint: API_URLS.THREADS_FEED },
            { key: 'threads-base-posts', label: 'Postagens Base', endpoint: API_URLS.THREADS_BASE_POSTS },
];
        
        let state = {
            authToken: null,
            companyId: null,
            socialAccounts: [],
            activeAccount: null, 
            activeMediaType: null, 
            items: [],
            filteredItems: [],
            totalItems: 0,
            isLoading: false,
            palavrasSalvasComentario: '',
            currentPage: 1,
            itemsPerPage: 10,
            whatsappLojas: [],
            whatsappGroups: [],
            companies: [],
            users: [],
            newImageBase64: null,
            scheduledPostFiles: [],
            currentUser: null,
            currentView: 'dashboard',   
        };

        // --- Seletores de Elementos do DOM ---
        let loginContainer, registerContainer, appContainer, sidebar, contentDisplayArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea, paginationContainer, loadingOverlay, scrollTopBtn, dashboardContentArea;
        
        let mediaItemsWrapper;

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const existingLinksListDiv = document.getElementById('existingLinksList');
        const modalAddLinks = document.getElementById('modalAddLinks');
        const formAddLinks = document.getElementById('formAddLinks');
        const linkFormPostId = document.getElementById('linkFormPostId');
        const linkFormLinkAnuncio = document.getElementById('linkFormLinkAnuncio');
        const linkFormLoja = document.getElementById('linkFormLoja');
        const linkFormCategoria = document.getElementById('linkFormCategoria');
        const linkFormImagem = document.getElementById('linkFormImagem');
        const modalPalavraComentario = document.getElementById('modalPalavraComentario');
        const listaPalavrasDiv = document.getElementById('lista-palavras');
        const inputNovaPalavra = document.getElementById('inputNovaPalavra');
        const modalEnviarWhatsApp = document.getElementById('modalEnviarWhatsApp');
        const whatsPostIdInput = document.getElementById('whatsPostId');
        const whatsVideoUrlInput = document.getElementById('whatsVideoUrl');
        const customNumberInputContainer = document.getElementById('customNumberInputContainer');
        const inputCustomNumberWhats = document.getElementById('inputCustomNumberWhats');
        const btnOpenCopyLinkByIdModal = document.getElementById('btnOpenCopyLinkByIdModal');
        const modalCopyLinkById = document.getElementById('modalCopyLinkById');
        const formCopyLinkById = document.getElementById('formCopyLinkById');
        const copyLinkFormPostId = document.getElementById('copyLinkFormPostId');
        const inputCopyLinkId = document.getElementById('inputCopyLinkId');
        const modalEditWhatsapp = document.getElementById('modalEditWhatsapp');
        const formEditWhatsapp = document.getElementById('formEditWhatsapp');
        const modalCreateWhatsapp = document.getElementById('modalCreateWhatsapp');
        const formCreateWhatsapp = document.getElementById('formCreateWhatsapp');
        const modalCreateSocialAccount = document.getElementById('modalCreateSocialAccount');
        const formCreateSocialAccount = document.getElementById('formCreateSocialAccount');
        const modalEditSocialAccount = document.getElementById('modalEditSocialAccount');
        const formEditSocialAccount = document.getElementById('formEditSocialAccount');
        const modalScheduledPost = document.getElementById('modalScheduledPost');
        const formScheduledPost = document.getElementById('formScheduledPost');
        const modalWhatsappGroup = document.getElementById('modalWhatsappGroup');
        const formWhatsappGroup = document.getElementById('formWhatsappGroup');
        const modalEditWhatsappGroup = document.getElementById('modalEditWhatsappGroup');
        const formEditWhatsappGroup = document.getElementById('formEditWhatsappGroup');
        const modalUser = document.getElementById('modalUser');
        const formUser = document.getElementById('formUser');

        // --- Funções Utilitárias ---
        function showLoading(message = "Carregando...") {
            state.isLoading = true;
            if (loadingOverlay) {
                loadingOverlay.querySelector('#loadingOverlayMessage').textContent = message;
                loadingOverlay.classList.add('active');
            }
        }

        function hideLoading() {
            state.isLoading = false;
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        // --- ROTEAMENTO ---
        function navigateTo(mainPath, pathParams = [], query = {}) {
            let encodedPathParams = '';
            if (pathParams.length > 0) {
                encodedPathParams = pathParams.map(p => encodeURIComponent(p)).join('/');
            }

            const hashPath = `#/${mainPath}${encodedPathParams ? '/' + encodedPathParams : ''}`;
            const queryString = new URLSearchParams(query).toString();
            const newHash = queryString ? `${hashPath}?${queryString}` : hashPath;

            if (window.location.hash === newHash) {
                if (event && (event.type === 'popstate' || event.target === window)) { // Se é F5 ou back/forward
                    router();
                } else if (mainPath === state.currentView && pathParams[0] === state.activeAccount && pathParams[1] === state.activeMediaType && query.page === state.currentPage) {
                    return;
                } else {
                    router();
                }
                return;
            }

            window.location.hash = newHash;
        }

        async function router() {
            const [hash, queryString] = (window.location.hash || '#/dashboard').split('?');
            const pathParts = hash.slice(2).split('/').filter(p => p);
            const mainPath = pathParts[0] || 'dashboard';
            const params = pathParts.slice(1);

            // **CORREÇÃO:** A variável 'queryParams' precisa ser definida aqui, antes de ser usada.
            const queryParams = new URLSearchParams(queryString || '');
            const newPage = parseInt(queryParams.get('page') || '1', 10);

            // Verifica se a navegação é apenas uma troca de página na mesma tela
            const isJustPagination = mainPath === 'media' &&
                state.currentView === 'media' &&
                params[0] === state.activeAccount &&
                params[1] === state.activeMediaType &&
                newPage !== state.currentPage;

            // Se for apenas paginação, não redesenha a página inteira
            if (isJustPagination) {
                state.currentPage = newPage;
                const mainContentEl = document.querySelector('.main-content');
                if (mainContentEl) mainContentEl.scrollTo({ top: 0, behavior: 'smooth' });
                await fetchData(); // Apenas busca os novos dados
                return; // Sai da função para evitar o redesenho completo
            }

            // --- Lógica para redesenho completo da página (quando muda de seção) ---
            [dashboardContentArea, contentDisplayArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea].forEach(el => {
                if(el) el.style.display = 'none';
            });
            
            state.currentPage = newPage;
            state.currentView = mainPath;

            // Limpa a seleção de conta/mídia se não estivermos na área de mídia
            if (mainPath !== 'media') {
                state.activeAccount = null;
                state.activeMediaType = null;
            }

            switch (mainPath) {
                case 'dashboard':
                    await showDashboardPage();
                    break;
                case 'media':
                    await showMediaContent(params[0] || '', params[1] || '');
                    break;
                case 'settings':
                    const subpage = params[0];
                    switch (subpage) {
                        case 'companies': await showCompaniesPage(); break;
                        case 'users': await showUsersPage(); break;
                        case 'accounts': await showSocialAccountsPage(); break;
                        case 'whatsapp-groups': await showWhatsappGroupsPage(); break;
                        case 'keyword': handleIncluirPalavra(); break;
                        default: await showDashboardPage();
                    }
                    break;
                default:
                    await showDashboardPage();
                    break;
            }

            renderSidebarMenu();
        }

        // --- Handlers de Ações Globais ---
        async function handleIncluirPalavra() {
            showLoading("Buscando palavras...");
            try {
                const res = await fetchWithAuth(API_URLS.GET_COMMENT_KEY);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                state.palavrasSalvasComentario = data.text || '';
                listaPalavrasDiv.innerHTML = data.text ? data.text.replace(/\n/g, '<br>') : "Nenhuma palavra salva.";
            } catch (error) {
                console.error("Erro:", error);
                listaPalavrasDiv.innerHTML = "<em>Erro ao carregar.</em>";
            } finally {
                hideLoading();
            }
            inputNovaPalavra.value = '';
            openModal(modalPalavraComentario);
        }

        function handleRecarregarStories() {
            if (!state.activeAccount || state.activeAccount === 'WhatsApp') {
                showAlert("Por favor, selecione uma conta do Instagram no menu lateral primeiro.");
                return;
            }
            showLoading("Atualizando Stories...");
            const updateEndpoint = `${API_URLS.FORCE_UPDATE_STORIES}?conta_user=${decodeURIComponent(state.activeAccount)}`;
            fetchWithAuth(updateEndpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na atualização forçada de Stories.');
                    showAlert("Atualização de Stories solicitada! A lista será atualizada em breve.");
                    setTimeout(fetchData, 5000);
                })
                .catch(err => showAlert(`Erro: ${err.message}`))
                .finally(hideLoading);
        }

        function handleRecarregarReels() {
            if (!state.activeAccount || state.activeAccount === 'WhatsApp') {
                showAlert("Por favor, selecione uma conta do Instagram no menu lateral primeiro.");
                return;
            }
            showLoading("Atualizando Reels...");
            const updateEndpoint = `${API_URLS.FORCE_UPDATE_REELS}?conta_user=${decodeURIComponent(state.activeAccount)}`;
            fetchWithAuth(updateEndpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na atualização forçada de Reels.');
                    showAlert("Atualização de Reels solicitada! A lista será atualizada em breve.");
                    setTimeout(fetchData, 5000);
                })
                .catch(err => showAlert(`Erro: ${err.message}`))
                .finally(hideLoading);
        }

        // Função auxiliar para fechar a sidebar no mobile
        function closeSidebarIfMobile() {
            if (window.innerWidth <= 992) { // Só executa em telas menores que 992px
                document.body.classList.remove('sidebar-collapsed');
            }
        }

        function renderSidebarMenu() {
            if (!sidebar) return;
            sidebar.innerHTML = '';
            const menuContainer = document.createElement('div');
            menuContainer.className = 'sidebar-menu';

            const currentUserCompany = state.companies.find(c => String(c.id) === String(state.companyId));
            const activeCompanyModules = currentUserCompany ? currentUserCompany.modules : {};

            const sortedAccounts = [...state.socialAccounts].sort((a, b) => (a.ordenacao ?? 999) - (b.ordenacao ?? 999));
            
            const groupedAccounts = sortedAccounts.reduce((acc, account) => {
                const media = account.social_media || 'Outros';
                if (!acc[media]) acc[media] = [];
                acc[media].push(account);
                return acc;
            }, {});

            const moduleMap = { Instagram: 'instagram', Facebook: 'facebook', Threads: 'threads' };

            for (const socialMedia in groupedAccounts) {
                const moduleKey = moduleMap[socialMedia];
                if (moduleKey && !activeCompanyModules[moduleKey]) continue;

                const accounts = groupedAccounts[socialMedia];
                const mediaGroup = document.createElement('div');
                mediaGroup.className = 'menu-group';
                const mediaParent = document.createElement('div');
                mediaParent.className = 'menu-parent';
                mediaParent.textContent = socialMedia;
                const mediaSubmenu = document.createElement('ul');

                const isMediaGroupActive = accounts.some(acc => acc.nome_conta === state.activeAccount);
                if (!isMediaGroupActive) {
                    mediaParent.classList.add('collapsed');
                    mediaSubmenu.classList.add('collapsed');
                }
                
                applySidebarState(mediaParent, socialMedia);

                mediaParent.addEventListener('click', () => {
                    mediaParent.classList.toggle('collapsed');
                    mediaSubmenu.classList.toggle('collapsed');
                    saveSidebarState();
                });

                mediaGroup.appendChild(mediaParent);
                mediaGroup.appendChild(mediaSubmenu);

                accounts.forEach(account => {
                    const accountParent = document.createElement('div');
                    accountParent.className = 'menu-parent submenu-item';
                    accountParent.textContent = account.nome_conta;
                    accountParent.style.paddingLeft = '15px';
                    const accountSubmenu = document.createElement('ul');

                    if (state.activeAccount !== account.nome_conta) {
                        accountParent.classList.add('collapsed');
                        accountSubmenu.classList.add('collapsed');
                    }
                    applySidebarState(accountParent, account.nome_conta);

                    accountParent.addEventListener('click', (e) => {
                        e.stopPropagation();
                        accountParent.classList.toggle('collapsed');
                        accountSubmenu.classList.toggle('collapsed');
                        saveSidebarState();
                    });

                    // LÓGICA CORRIGIDA PARA SEPARAR OS MENUS
                    let mediaTypesForThisAccount = [];
                    if (socialMedia === 'Threads') {
                        // Filtra apenas os tipos de mídia do Threads
                        mediaTypesForThisAccount = MEDIA_TYPES.filter(mt => mt.key.startsWith('threads-') || mt.key === 'scheduled-threads');
                    } else {
                        // Filtra para NÃO incluir os tipos de mídia do Threads para outras redes
                        mediaTypesForThisAccount = MEDIA_TYPES.filter(mt => !mt.key.startsWith('threads-') && mt.key !== 'scheduled-threads');
                    }

                    mediaTypesForThisAccount.forEach(mediaType => {
                        const li = document.createElement('li');
                        li.className = 'submenu-item';
                        li.textContent = mediaType.label;
                        if (state.activeAccount === account.nome_conta && state.activeMediaType === mediaType.key) {
                            li.classList.add('active');
                        }
                        li.addEventListener('click', (e) => {
                            e.stopPropagation();
                            navigateTo('media', [account.nome_conta, mediaType.key]);
                            closeSidebarIfMobile();
                        });
                        accountSubmenu.appendChild(li);
                    });

                    mediaSubmenu.appendChild(accountParent);
                    mediaSubmenu.appendChild(accountSubmenu);
                });
                menuContainer.appendChild(mediaGroup);
            }

            if (activeCompanyModules.whatsapp) {
                const whatsappGroup = document.createElement('div');
                whatsappGroup.className = 'menu-group';
                const whatsappParent = document.createElement('div');
                whatsappParent.className = 'menu-parent';
                whatsappParent.textContent = 'WhatsApp';
                const whatsappSubmenu = document.createElement('ul');
                
                if (state.activeAccount !== 'WhatsApp') {
                    whatsappParent.classList.add('collapsed');
                    whatsappSubmenu.classList.add('collapsed');
                }
                applySidebarState(whatsappParent, 'WhatsApp');

                whatsappParent.addEventListener('click', () => {
                    whatsappParent.classList.toggle('collapsed');
                    whatsappSubmenu.classList.toggle('collapsed');
                    saveSidebarState();
                });

                whatsappGroup.appendChild(whatsappParent);
                whatsappGroup.appendChild(whatsappSubmenu);

                const sortedGroups = [...state.whatsappGroups].sort((a, b) => (a.ordenacao || 999) - (b.ordenacao || 999));

                sortedGroups.forEach(group => {
                    const li = document.createElement('li');
                    li.className = 'submenu-item';
                    li.textContent = `Ofertas - ${group.group_name}`;
                    if (state.activeAccount === 'WhatsApp' && state.activeMediaType === group.group_name) {
                        li.classList.add('active');
                    }
                    li.addEventListener('click', (e) => {
                        e.stopPropagation();
                        navigateTo('media', ['WhatsApp', group.group_name]);
                        closeSidebarIfMobile();
                    });
                    whatsappSubmenu.appendChild(li);
                });
                menuContainer.appendChild(whatsappGroup);
            }
            
            sidebar.appendChild(menuContainer);

            const themeToggleContainer = document.createElement('div');
            themeToggleContainer.style.padding = '20px 0';
            themeToggleContainer.style.textAlign = 'center';
            themeToggleContainer.innerHTML = `<button id="themeToggle" title="Alterar Tema"><div class="toggle-circle"></div></button>`;
            sidebar.appendChild(themeToggleContainer);

            document.getElementById('themeToggle').addEventListener('click', handleThemeToggle);
            if (document.body.classList.contains('dark-theme')) {
                const toggleCircle = document.querySelector('#themeToggle .toggle-circle');
                if(toggleCircle) toggleCircle.style.transform = 'translateX(24px)';
            }
        }

        async function handleThemeToggle() {
            const isDark = document.body.classList.toggle('dark-theme');
            const toggleCircle = document.querySelector('#themeToggle .toggle-circle');
            if(toggleCircle) {
            toggleCircle.style.transform = isDark ? 'translateX(24px)' : 'translateX(2px)';
            }

            if (state.authToken && state.currentUser?.id) {
                try {
                    const payload = { id: state.currentUser.id, dark_theme: isDark };
                    const response = await fetchWithAuth(API_URLS.USERS_CRUD, { method: 'PUT', body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(await response.text());
                    state.currentUser.dark_theme = isDark;
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                } catch (error) {
                    console.error("Erro ao salvar tema:", error);
                    showAlert(`Erro ao salvar tema: ${error.message}`);
                    document.body.classList.toggle('dark-theme'); // Reverte em caso de erro
                }
            }
        }

        function renderItems() {
            if (!mediaItemsWrapper) {
                console.error("mediaItemsWrapper não encontrado!");
                return;
            }

            mediaItemsWrapper.innerHTML = '';

            if (state.activeAccount === 'WhatsApp') {
                renderWhatsappContent(mediaItemsWrapper);
            } else {
                renderCardContent(mediaItemsWrapper);
            }
        }

        function renderCardContent(targetDiv) {
            if (!targetDiv) return;

            // Garante que estamos usando a lista correta (filtrada ou completa)
            const itemsToDisplay = state.filteredItems.length > 0 ? state.filteredItems : state.items;

            if (itemsToDisplay.length === 0 && !state.isLoading) {
                targetDiv.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum item encontrado para esta visualização.</p>';
                return;
            }
            
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-container';

            itemsToDisplay.forEach(item => {
                let card;
                // O 'switch' decide qual tipo de card criar
                switch (state.activeMediaType) {
                    case 'reels':
                        card = createReelCard(item);
                        break;
                    case 'posts':
                        card = createPostCard(item);
                        break;
                    case 'stories':
                    case 'stories-base':
                        card = createStoryCard(item);
                        break;
                    case 'scheduled-posts':
                    case 'scheduled-threads':
                        card = createScheduledPostCard(item);
                        break;
                    case 'threads-feed':
                        card = createThreadsFeedCard(item);
                        break;
                    case 'threads-base-posts':
                        card = createThreadsBasePostCard(item);
                        break;
                    default:
                        console.warn("Tipo de mídia desconhecido para renderização de card:", state.activeMediaType);
                        break;
                }
                
                if (card) {
                    gridContainer.appendChild(card);
                }
            });

            targetDiv.innerHTML = ''; // Limpa o conteúdo antigo
            targetDiv.appendChild(gridContainer);
        }

        async function showScheduledPostsPage() { // Renomeado para showScheduledPostsPage
            // Esconder outras áreas
            [dashboardContentArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea].forEach(el => el.style.display = 'none');
            contentDisplayArea.style.display = 'block'; // Usando contentDisplayArea para posts agendados
            
            contentDisplayArea.innerHTML = ''; // Limpa a área

            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Posts Agendados</h2>`;

            const createBtn = document.createElement('button');
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Postagem';
            createBtn.addEventListener('click', () => handleOpenScheduledPostModal()); 
            headerDiv.appendChild(createBtn);
            contentDisplayArea.appendChild(headerDiv);

            const scheduledPostsItemsWrapper = document.createElement('div');
            scheduledPostsItemsWrapper.id = 'scheduled-posts-items-wrapper';
            contentDisplayArea.appendChild(scheduledPostsItemsWrapper);

            paginationContainer.style.display = 'flex';
            await fetchData();
        }

        function renderScheduledPostsPage(targetDiv) {
            if (!targetDiv) return;
            targetDiv.innerHTML = ''; // Limpa APENAS o contêiner dos itens

            if (state.items.length === 0 && !state.isLoading) {
                targetDiv.innerHTML = '<p>Nenhum item agendado para postar.</p>';
                return;
            }
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-container';
            state.items.forEach(item => {
                if (item && item.id) {
                    const card = createScheduledPostCard(item);
                    if (card) gridContainer.appendChild(card);
                }
            });
            targetDiv.appendChild(gridContainer);
        }


        function renderPaginationControls() {
            if (!paginationContainer) return;
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
            
            // Oculta se não houver páginas ou se estiver carregando
            if (totalPages <= 1 || state.isLoading) {
                paginationContainer.style.display = 'none';
                return;
            }
            paginationContainer.style.display = 'flex';

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'pagination-controls';

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = state.currentPage === 1;
            prevButton.addEventListener('click', () => changePage(state.currentPage - 1));

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${state.currentPage} de ${totalPages || 1}`;

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Próxima';
            nextButton.disabled = state.currentPage === totalPages || totalPages === 0;
            nextButton.addEventListener('click', () => changePage(state.currentPage + 1));

            controlsDiv.appendChild(prevButton);
            controlsDiv.appendChild(pageInfo);
            controlsDiv.appendChild(nextButton);

            const itemsPerPageSelect = document.createElement('select');
            itemsPerPageSelect.id = 'itemsPerPageSelector';
            [10, 50, 100].forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `${num} por página`;
                if (num === state.itemsPerPage) {
                    option.selected = true;
                }
                itemsPerPageSelect.appendChild(option);
            });
            itemsPerPageSelect.addEventListener('change', (event) => {
                state.itemsPerPage = parseInt(event.target.value, 10);
                changePage(1);
            });

            paginationContainer.appendChild(itemsPerPageSelect);
            paginationContainer.appendChild(controlsDiv);
        }
        
        function createSmartMediaElement(item) {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'media-content';
            const placeholder = 'https://placehold.co/400x640/cccccc/ffffff?text=Indisponível';

            const urls = item.media_urls || [item.media_url, item.s3_url_video, item.url_s3_video].filter(Boolean);
            if (!urls || urls.length === 0) {
                mediaContainer.innerHTML = '<span>Mídia indisponível</span>';
                return mediaContainer;
            }

            const videos = urls.filter(url => url.endsWith('.mp4') || url.endsWith('.mov') || url.includes('video'));
            const images = urls.filter(url => url.endsWith('.webp') || url.endsWith('.jpg') || url.endsWith('.jpeg') || url.endsWith('.png') || url.includes('image'));

            if (videos.length > 0) { // Prioriza vídeo
                const videoUrl = videos[0];
                const thumbUrl = images[0] || item.thumbnail_url || item.story_thumbnail || item.url_s3_thumbnail || item.url_s3_video;
                if (thumbUrl) {
                    mediaContainer.innerHTML = `
                        <img src="${thumbUrl}" onerror="this.onerror=null; this.src='${placeholder}';" alt="Thumbnail do vídeo">
                        <div class="play-button-overlay" data-video-url="${videoUrl}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                        </div>`;
                    const playOverlay = mediaContainer.querySelector('.play-button-overlay');
                    playOverlay.addEventListener('click', (e) => {
                        e.stopPropagation();
                        mediaContainer.innerHTML = `<video src="${videoUrl}" controls autoplay></video>`;
                    });
                } else {
                    mediaContainer.innerHTML = `<video src="${videoUrl}" controls></video>`;
                }
            } else if (images.length > 1) { // Carrossel de imagens
                let currentIndex = 0;
                const imageElements = images.map((src, index) => `<img src="${src}" style="display: ${index === 0 ? 'block' : 'none'};" alt="Mídia ${index + 1}">`).join('');
                
                mediaContainer.innerHTML = `
                    ${imageElements}
                    <button class="carousel-btn prev" style="position:absolute; left: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">&#10094;</button>
                    <button class="carousel-btn next" style="position:absolute; right: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">&#10095;</button>
                `;

                const imgs = mediaContainer.querySelectorAll('img');
                const updateCarousel = () => {
                    imgs.forEach((img, index) => {
                        img.style.display = index === currentIndex ? 'block' : 'none';
                    });
                };

                mediaContainer.querySelector('.prev').addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentIndex = (currentIndex > 0) ? currentIndex - 1 : imgs.length - 1;
                    updateCarousel();
                });

                mediaContainer.querySelector('.next').addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentIndex = (currentIndex < imgs.length - 1) ? currentIndex + 1 : 0;
                    updateCarousel();
                });
            } else if (images.length === 1) { // Apenas uma imagem
                mediaContainer.innerHTML = `<img src="${images[0]}" onerror="this.onerror=null; this.src='${placeholder}';" alt="Mídia do post">`;
            } else {
                mediaContainer.innerHTML = '<span>Mídia indisponível</span>';
            }

            return mediaContainer;
        }


        function getPostDescription(post) {
            let descriptionNew = "";
            const ordenacao = post.ordenacao_postagem == null ? post.id : post.ordenacao_postagem;
            const comenta = post.palavra_comenta || state.palavrasSalvasComentario.split('\n')[0] || "QUERO";
            const contaUser = state.activeAccount; // Usa a conta ativa do estado

            // Mantém a lógica original, mas agora baseada na conta ativa
            if (contaUser && contaUser.toLowerCase().includes("baby")) {
                descriptionNew = `💛 Gostou comenta "${comenta}" para receber o LINK no direct 🔥\n\nAnúncio N.º: ${ordenacao}\nConfira sua aba de 'solicitações' no direct, pois a mensagem será enviada automaticamente.\n\n✨ Marque uma mamãe que vai adorar essa novidade!\n🚨 Stories disponíveis por 24 horas\n🎀Siga @carlababyofertas para não perder nenhuma oferta e novidade!\n#dicasmaternidade #maternidadereal #maternidade #amordemãe #maedemenino #maedemenina #brinquedosdebebe #brinquedosdidaticos #brincar #diversao #diversaoemfamília ${post.hashtags || ''}`;
            } else { // Default para "indica" ou qualquer outra conta
                descriptionNew = `💛 Gostou comenta "${comenta}" para LINK no direct 🔥\n\nAnúncio N.º: ${ordenacao}\nNos Stories de hoje 🔥\nNo Grupo de Ofertas-Link na Bio 🔥\nSiga @carlaindicaofertas para mais achadinhos como esse!\n#utilidades #maquiagem #feminina #feminino #mulher #importado #roupa #girl #chique ${post.hashtags || ''}`;
            }
            return descriptionNew;
        }

        function formatMediaDateTime(dateTimeString) {
            if (!dateTimeString) return 'Data indisponível';
            try {
                const date = new Date(dateTimeString);
                if (isNaN(date)) return "Data inválida";
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) { return "Data inválida"; }
        }

        function createReelCard(reel) {
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(reel.media_created_at);
            const mediaElement = createSmartMediaElement(reel);

            card.appendChild(mediaElement);
            
            const formDiv = document.createElement('div');
            formDiv.innerHTML = `
                <label><span style="font-weight:normal; font-size:0.9em;">ID: ${reel.id} | Postado em: ${formattedDateTime}</span></label>
                <div class="list-item-stats">
                    <p><strong>👁️ Views:  </strong> ${reel.views || 0}</p>
                    <p><strong>❤️ Likes:  </strong> ${reel.likes || 0}</p>
                    <p><strong>💬 Coment.:  </strong> ${reel.comments || 0}</p>
                    <p><strong>🎯 Alcance:  </strong> ${reel.reach || 0}</p>
                    <p><strong>💾 Salvos:  </strong> ${reel.saved || 0}</p>
                    <p><strong>↪️ Compart.:  </strong> ${reel.shares || 0}</p>
                </div>
                <label for="caption-${reel.id}">Descrição: </label>
                <textarea id="caption-${reel.id}">${reel.caption || ''}</textarea>
                <div class="card-buttons">
                    <button class="btn-save" data-id="${reel.id}" data-type="${reel.media_product_type || 'REELS'}">Salvar Edição Reel</button>
                    <button class="btn-whatsapp" data-id="${reel.id}" data-video-url="${reel.media_url || ''}">Enviar p/ WhatsApp</button>
                    <button class="btn-copy" data-url="${reel.media_url || ''}">Copiar Link da Mídia</button>
                    <button class="btn-link" data-id="${reel.id}" data-type="reels">Incluir Links</button>
                    ${reel.permalink ? `<button onclick="window.open('${reel.permalink}', '_blank')">Ver Reel no Instagram</button>` : ''}
                    <button class="btn-delete btn-delete-reel" data-id="${reel.id}">Deletar Reel</button>
                </div>
            `;
            card.appendChild(formDiv);

            card.querySelector('.btn-save').addEventListener('click', handleSalvarEdicaoReel);
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal);
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink);
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-delete-reel').addEventListener('click', handleDeleteReel);
            return card;
        }

        function createPostCard(post) { 
            const card = document.createElement('div'); 
            card.className = 'card'; 
            const descriptionNew = getPostDescription(post); 
            const ordenacaoParaExibir = post.ordenacao_postagem == null ? post.id : post.ordenacao_postagem; 
            const mediaElement = createSmartMediaElement(post);
            
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = ` 
                <label>ID: ${post.id}</label> 
                <label for="desc-${post.id}">Descrição:</label> 
                <textarea id="desc-${post.id}">${descriptionNew}</textarea> 
                <label for="ord-${post.id}">Ordenação:</label> 
                <input type="number" id="ord-${post.id}" value="${ordenacaoParaExibir}"> 
                <label for="cat-${post.id}">Categoria:</label> 
                <input type="text" id="cat-${post.id}" value="${post.categoria || ''}"> 
                <div> 
                    <input type="checkbox" id="rev-${post.id}" ${post.check_reviewed ? 'checked' : ''} style="width:auto; margin-right:5px;">
                    <label for="rev-${post.id}" style="font-weight:normal; display:inline;">Revisado</label> 
                </div> 
                <div class="card-buttons"> 
                    <button class="btn-save" data-id="${post.id}">Salvar Edição</button> 
                    <label for="upload-${post.id}" style="margin-top:5px; margin-bottom:0; font-size:0.8rem;">Trocar Vídeo:</label> 
                    <input type="file" id="upload-${post.id}" accept=".mov,.mp4,video/quicktime" data-id="${post.id}" style="padding:5px; font-size:0.85rem;">
                    <button class="btn-whatsapp" data-id="${post.id}" data-video-url="${post.s3_url_video || ''}">Enviar p/ WhatsApp</button> 
                    <button class="btn-link" data-id="${post.id}" data-type="post">Incluir Links</button> 
                    <button class="btn-instagram-post" data-id="${post.id}" ${!post.check_reviewed ? 'disabled' : ''}>Postar este no Instagram</button> 
                    ${post.conta_clone_url_reels ? `<button onclick="window.open('${post.conta_clone_url_reels}', '_blank')">Ver no Instagram Clone</button>` : ''} 
                    <button class="btn-delete" data-id="${post.id}">Excluir Item</button> 
                </div>
                </div>`; 
            card.appendChild(contentDiv);
            card.querySelector('.btn-save').addEventListener('click', handleSalvarEdicaoPost); 
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirPost); 
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal); 
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal); 
            card.querySelector('.btn-instagram-post').addEventListener('click', handlePostarUnicoInstagram); 
            card.querySelector('input[type="file"]').addEventListener('change', handleUploadVideo); 
            return card; 
        } 

        function createScheduledPostCard(post) {
            if (!post || !post.id) return null; // Validação para evitar cards vazios

            const card = document.createElement('div');
            card.className = 'card';
            const mediaElement = createSmartMediaElement(post);

            card.appendChild(mediaElement);
            
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <label>ID: ${post.id || 'N/A'}</label>
                <label>Descrição:</label>
                <textarea readonly>${post.description || 'Sem descrição'}</textarea>
                <p><strong>Agendado para:</strong> ${formatMediaDateTime(post.schedule_time) || 'N/A'}</p>
                <div class="card-buttons">
                    <button class="btn-edit-scheduled-post" data-id="${post.id}">Editar</button>
                    <button class="btn-link" data-id="${post.id}" data-type="reels">Incluir Links</button>
                    <button class="btn-instagram-post" data-id="${post.id}">Postar Agora</button>
                    <button class="btn-delete" data-id="${post.id}" data-media_url="${post.media_url || ''}">Excluir</button>
                </div>`;
            
            card.appendChild(infoDiv);

            card.querySelector('.btn-edit-scheduled-post').addEventListener('click', () => handleOpenScheduledPostModal(post));
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-instagram-post').addEventListener('click', handlePostarUnicoInstagram);
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirPost);
            return card;
        }
        
        function createStoryCard(story) { 
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(story.media_created_at);
            const mediaElement = createSmartMediaElement(story);

            card.appendChild(mediaElement);

            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <label><span style="font-weight:normal; font-size:0.9em;">ID: ${story.id} | Postado em: ${formattedDateTime}</span></label>
                <div class="card-buttons">
                    ${story.url_product ? `<button onclick="window.open('${story.url_product}', '_blank')">Ver Anúncio</button>` : ''}
                    <button class="btn-save" data-id="${story.id}" data-type="${story.media_product_type || 'STORIES'}" data-conta="${story.conta_user_instagram}">Repostar Story</button>
                    <button class="btn-copy" data-url="${story.media_url || ''}">Copiar Link da Mídia</button>
                    <button class="btn-link" data-id="${story.id}" data-type="story">Incluir Links</button>
                    ${story.permalink ? `<button onclick="window.open('${story.permalink}', '_blank')">Ver Story no Instagram</button>` : ''}
                </div>
            `;
            card.appendChild(infoDiv);

            card.querySelector('.btn-save').addEventListener('click', handleRepostStory);
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink);
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            return card;
        } 
        
        function createStoryBaseCard(item) { 
            const card = document.createElement('div'); 
            card.className = 'card'; 
            const mediaElement = createSmartMediaElement(item);
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = ` 
                <label>ID: ${item.id}</label> 
                <div class="card-buttons"> 
                    ${item.url_product ? `<button onclick="window.open('${item.url_product}', '_blank')">Abrir Anúncio</button>` : ''} 
                    <button class="btn-whatsapp" data-id="${item.id}" data-video-url="${item.url_s3_video || ''}">Enviar p/ WhatsApp</button> 
                    <button class="btn-copy" data-url="${item.url_s3_video || ''}">Copiar Link da Mídia</button> 
                    <button class="btn-delete" data-id="${item.id}">Excluir Story Base</button> 
                </div>`; 
            card.appendChild(contentDiv);
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal); 
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink); 
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirStoryBase); 
            return card; 
        } 
        
        function renderExistingLinks(links) {
            existingLinksListDiv.innerHTML = '';
            const validLinks = (links || []).filter(link => link && (link.loja || link.url_production));
            if (validLinks.length === 0) {
                existingLinksListDiv.innerHTML = '<p>Nenhum link existente para esta postagem.</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.style.listStyleType = 'none';
            ul.style.paddingLeft = '0';
            validLinks.forEach(link => {
                const li = document.createElement('li');
                // Estilos para alinhar o conteúdo e o botão
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.marginBottom = '10px';
                li.style.paddingBottom = '10px';
                li.style.borderBottom = '1px dashed var(--border-color)';
                
                li.innerHTML = `
                    <div>
                        <strong>Loja:</strong> ${link.loja || 'N/A'}<br>
                        <strong>Descrição:</strong> ${link.descricao || 'N/A'}<br>
                        <strong>Categoria:</strong> ${link.categoria || 'N/A'}<br>
                        <a href="${link.url_production}" target="_blank" style="color: var(--active-menu-text); word-break: break-all;">${link.url_production || 'N/A'}</a>
                    </div>
                    <button class="btn-delete btn-delete-link" data-link-id="${link.id}" style="width: auto; flex-shrink: 0; margin-left: 10px;">Excluir</button>
                `;
                ul.appendChild(li);
            });
            existingLinksListDiv.appendChild(ul);
        }

        async function handleDeleteLink(event) {
            const linkId = event.target.dataset.linkId;
            if (!linkId) return;

            const confirmed = await showConfirm(`Tem certeza que deseja excluir o Link ID ${linkId}?`);
            if (!confirmed) return;

            showLoading("Excluindo link...");
            try {
                const response = await fetchWithAuth(API_URLS.DELETE_LINK, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: linkId })
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao excluir o link.");

                showAlert("Link excluído com sucesso!");
                await fetchData();
                // Recarrega a lista de links no modal
                const postId = linkFormPostId.value;
                const type = document.querySelector('input[name="linkFormTipo"]:checked')?.value || 'post';
                handleOpenLinkModal({ target: { dataset: { id: postId, type: type } } });

            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // --- Funções de API e Handlers ---
        async function fetchWithAuth(url, options = {}) {
            const headers = { ...options.headers };

            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            if (state.authToken) {
                headers['Authorization'] = `Basic ${state.authToken}`;
            }

            if (state.companyId) {
                if (options.body && typeof options.body === 'string' && options.method !== 'GET') {
                    try {
                        const bodyData = JSON.parse(options.body);
                        bodyData.company_id = state.companyId;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) {
                        console.warn("Could not add company_id to non-JSON body");
                    }
                } else {
                    const urlObj = new URL(url.startsWith('http') ? url : window.location.origin + url);
                    if (!urlObj.searchParams.has('company_id')) {
                       urlObj.searchParams.set('company_id', state.companyId);
                    }
                    url = urlObj.toString();
                }
            }

            const fetchOptions = {
                ...options,
                headers
            };

            try {
                const response = await fetch(url, fetchOptions);

                if (response.status === 401) { 
                    showAlert("A sua sessão expirou ou é inválida. Por favor, faça o login novamente.");
                    handleLogout(); 
                    throw new Error("Sessão expirada.");
                }

                return response;

            } catch (error) {
                throw error;
            }
        }

        async function fetchData() {
            if (state.isLoading) return;
            showLoading("Carregando dados...");
            if (paginationContainer) paginationContainer.style.display = 'none';

            let endpoint = '';
            const params = new URLSearchParams({
                page: state.currentPage,
                limit: state.itemsPerPage
            });

            if (state.currentView === 'media') {
                if (!state.activeAccount || !state.activeMediaType) {
                    hideLoading();
                    return;
                }
                if (state.activeAccount === 'WhatsApp') {
                    endpoint = `${url_base}${API_URLS.WHATSAPP}?grupo=${decodeURIComponent(state.activeMediaType)}&${params.toString()}`;
                } else {
                    const mediaTypeConfig = MEDIA_TYPES.find(m => m.key === state.activeMediaType);
                    if (mediaTypeConfig) {
                        endpoint = `${url_base}${mediaTypeConfig.endpoint}?conta_user=${decodeURIComponent(state.activeAccount)}&${params.toString()}`;
                    }
                }
            } else if (state.currentView === 'settings') {
                // ... (lógica para settings, se necessário)
            }

            if (!endpoint) {
                hideLoading();
                return;
            }
            
            // Cache-busting para garantir dados sempre novos
            const separator = endpoint.includes('?') ? '&' : '?';
            const finalEndpoint = `${endpoint}${separator}_=${new Date().getTime()}`;

            try {
                const res = await fetchWithAuth(finalEndpoint);
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Erro ${res.status}: ${errorText || res.statusText}`);
                }

                const responseText = await res.text();
                const data = responseText ? JSON.parse(responseText) : { data: [], totalItems: 0 };

                state.items = data.data || [];
                state.totalItems = data.totalItems || 0;
                state.filteredItems = [...state.items];

                if (state.activeAccount === 'WhatsApp') {
                    state.whatsappLojas = data.lojas || [];
                }

                renderItems();
            } catch (error) {
                if (!error.message.includes("Sessão expirada")) {
                    showAlert(`Erro ao carregar dados: ${error.message}`);
                }
                if(mediaItemsWrapper) mediaItemsWrapper.innerHTML = '<p style="text-align:center;">Não foi possível carregar os dados.</p>';
            } finally {
                hideLoading();
                renderPaginationControls();
            }
        }

        async function fetchInitialData() {
            await Promise.all([
                fetchSocialAccounts(),
                fetchWhatsappGroups(),
                fetchCompanies()
            ]);
            
            setupEventListeners();
            await router(); // Chama o roteador para carregar a view inicial
        }
        
        function changePage(page) {
            state.currentPage = page;
            const mainContentEl = document.querySelector('.main-content');
            if (mainContentEl) mainContentEl.scrollTo({ top: 0, behavior: 'smooth' });

            const currentHash = window.location.hash.split('?')[0];
            const pathParts = currentHash.slice(2).split('/');
            
            const mainPath = pathParts[0];
            
            const decodedPathParams = pathParts.slice(1).map(p => decodeURIComponent(p));

            navigateTo(mainPath, decodedPathParams, { page });
        }

        // --- Handlers de Ações (Salvar, Excluir, etc) ---
        async function handleSalvarEdicaoPost(event) {
            const postId = event.target.dataset.id;
            const cardElement = event.target.closest('.card');
            if (!cardElement) return;
            const payload = {
                id: postId,
                description: cardElement.querySelector(`#desc-${postId}`).value,
                ordenacao_postagem: parseInt(cardElement.querySelector(`#ord-${postId}`).value),
                categoria: cardElement.querySelector(`#cat-${postId}`).value,
                revisado: cardElement.querySelector(`#rev-${postId}`).checked
            };
            showLoading("Salvando post...");
            try {
                const response = await fetchWithAuth(API_URLS.UPDATE_POST, { method: "PUT", body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(await response.text());
                showAlert('Post atualizado!');
                await fetchData();
            } catch (error) {
                if (!error.message.includes("Sessão expirada")) {
                    showAlert(`Erro: ${error.message}`);
                }
            } finally {
                hideLoading();
            }
        }

        async function handleSalvarEdicaoReel(event) {
            const reelId = event.target.dataset.id;
            const cardElement = event.target.closest('.card');
            if (!cardElement) return;
            const payload = {
                id: reelId,
                caption: cardElement.querySelector(`#caption-${reelId}`).value,
                media_product_type: event.target.dataset.type || 'REELS'
            };
            showLoading("Salvando reel...");
            try {
                const response = await fetchWithAuth(API_URLS.UPDATE_POST, { method: "PUT", body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(await response.text());
                showAlert('Reel atualizado!');
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function handleRepostStory(event) {
            const storyId = event.target.dataset.id;
            const payload = {
                id_story: storyId,
                media_product_type: event.target.dataset.type || 'STORIES',
                conta_user: event.target.dataset.conta
            };
            showLoading("Repostando story...");
            try {
                const response = await fetchWithAuth(API_URLS.REPOST_STORIES, { method: "POST", body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(await response.text());
                showAlert('Story repostado!');
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleExcluirPost(event) {
            const postId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o item ID ${postId}?`);
            if (!confirmed) return;
            showLoading("Excluindo item...");
            const isScheduled = state.activeMediaType === 'scheduled-posts';
            const url = isScheduled ? API_URLS.SCHEDULED_POSTS_CRUD : API_URLS.DELETE_POST;
            try {
                const response = await fetchWithAuth(url, { method: "DELETE", body: JSON.stringify({ id: postId }) });
                if (!response.ok) throw new Error(await response.text());
                showAlert("Item excluído.");
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteReel(event) {
            const reelId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o Reel ID ${reelId}?`);
            if (!confirmed) return;
            showLoading("Excluindo Reel...");
            try {
                const response = await fetchWithAuth(API_URLS.DELETE_REEL, { method: "DELETE", body: JSON.stringify({ id: reelId }) });
                if (!response.ok) throw new Error(await response.text());
                showAlert("Reel excluído.");
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleExcluirStoryBase(event) {
            const storyId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o Story Base ID ${storyId}?`);
            if (!confirmed) return;
            showLoading("Excluindo Story Base...");
            try {
                const response = await fetchWithAuth(API_URLS.DELETE_STORIES, { method: "DELETE", body: JSON.stringify({ id: storyId }) });
                if (!response.ok) throw new Error(await response.text());
                showAlert("Story Base excluído.");
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        } 
        function handleUploadVideo(event) { 
            const postId = event.target.dataset.id; const file = event.target.files[0]; if (!file) return; 
            if (!file.type.includes('video')) { showAlert("Envie um arquivo de vídeo (.mp4, .mov)."); event.target.value = null; return; } 
            if (file.size > 50 * 1024 * 1024) { showAlert("Vídeo grande (Max: 50MB)."); event.target.value = null; return; } 
            showLoading("Enviando vídeo..."); 
            const reader = new FileReader(); 
            reader.onload = async () => { 
                const formData = new FormData(); formData.append("video_base64", reader.result.split(',')[1]); formData.append("id", postId); 
                try { 
                    const response = await fetchWithAuth(API_URLS.UPLOAD_VIDEO, { method: 'POST', body: formData, headers: {'Content-Type': undefined} }); 
                    if (!response.ok) throw new Error(await response.text()); 
                    showAlert("✅ Vídeo enviado!");
                    await fetchData(); // CORRIGIDO
                } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
                finally { hideLoading(); event.target.value = null; } 
            }; 
            reader.readAsDataURL(file); 
        } 
        async function handlePostarUnicoInstagram(event) {
            const postId = event.target.dataset.id;
            const post = state.items.find(p => String(p.id) === String(postId));
            if (!post) {
                showAlert("Post não encontrado.");
                return;
            }

            if (state.activeMediaType === 'posts' && !post.check_reviewed) {
                showAlert("Post precisa ser 'Revisado'.");
                return;
            }

            const confirmed = await showConfirm(`Postar item ID ${post.id} no Instagram (${state.activeAccount})?`);
            if (!confirmed) return;
            
            showLoading("Postando no Instagram...");

            const endpoint = API_URLS.POST_INSTAGRAM_MANUAL;

            const payload = {
                id: postId,
                conta_user: state.activeAccount // <-- CORRIGIDO AQUI
            };

            try {
                const response = await fetchWithAuth(endpoint, { method: 'POST', body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                showAlert(data.message || "✅ Post enviado!");
                await fetchData();
            } catch (error) {
                console.error("Erro:", error);
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        function handleCopyLink(event) { 
            const url = event.target.dataset.url; 
            if (url && navigator.clipboard) { 
                navigator.clipboard.writeText(url).then(() => showAlert("Link copiado!")).catch(() => legacyCopy(url)); 
            } else if (url) { legacyCopy(url); } else { showAlert("Nenhuma URL para copiar."); } 
        } 
        function legacyCopy(text) { 
            const ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.opacity = "0"; 
            document.body.appendChild(ta); ta.focus(); ta.select(); 
            try { if(document.execCommand('copy')) showAlert("Link copiado! (fallback)"); else showAlert("Falha (fallback).");} 
            catch (err) { showAlert("Falha (fallback).");} 
            document.body.removeChild(ta); 
        }
        
        // --- Funções de Modal ---
        function openModal(modalElement) { modalElement.style.display = 'flex'; }
        function closeModal(modalElement) { modalElement.style.display = 'none'; }
        
        function showAlert(message, title = 'Aviso') {
            document.getElementById('modalAlertTitle').textContent = title;
            document.getElementById('modalAlertMessage').textContent = message;
            openModal(document.getElementById('modalAlert'));
        }

        function showConfirm(message, title = 'Confirmação') {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('modalConfirm');
                const okBtn = document.getElementById('modalConfirmOk');
                const cancelBtn = document.getElementById('modalConfirmCancel');
                const closeBtns = confirmModal.querySelectorAll('.modal-close-btn, .modal-close-btn-alternative');

                document.getElementById('modalConfirmTitle').textContent = title;
                document.getElementById('modalConfirmMessage').textContent = message;

                const newOkBtn = okBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                const closeAndResolve = (value) => {
                    closeModal(confirmModal);
                    resolve(value);
                };

                newOkBtn.addEventListener('click', () => closeAndResolve(true));
                newCancelBtn.addEventListener('click', () => closeAndResolve(false));
                closeBtns.forEach(btn => btn.addEventListener('click', () => closeAndResolve(false)));
                confirmModal.addEventListener('click', e => {
                    if (e.target === confirmModal) closeAndResolve(false);
                }, { once: true });


                openModal(confirmModal);
            });
        }

        async function handleOpenLinkModal(event) {
            const itemId = event.target.dataset.id;
            let type = event.target.dataset.type || 'post';
            let apiType = type; // Variável para a chamada da API

            // Consolida os tipos 'threads-feed' e 'threads-base-posts' para 'threads'
            if (type.startsWith('threads-')) {
                apiType = 'threads'; // Usa 'threads' para a API
                type = 'threads';    // E também para selecionar o radio button
            }
            
            linkFormPostId.value = itemId;
            formAddLinks.reset();
            
            const radio = formAddLinks.querySelector(`input[name="linkFormTipo"][value="${type}"]`);
            if (radio) radio.checked = true;
            
            existingLinksListDiv.innerHTML = '<p>Carregando...</p>';
            openModal(modalAddLinks);
            
            try {
                const url = `${API_URLS.GET_LINKS_POSTAGENS}?id_post=${encodeURIComponent(itemId)}&type=${encodeURIComponent(apiType)}`;
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error(await response.text());
                const links = await response.json();
                renderExistingLinks(Array.isArray(links) ? links : []);
            } catch (error) {
                console.error("Erro:", error);
                existingLinksListDiv.innerHTML = `<p style="color:red;">Erro: ${error.message}</p>`;
            }
        }

        function handleOpenMediaLinksModal(event) {
            const itemId = event.target.dataset.id;
            const item = state.items.find(i => i.id == itemId);

            if (!item || !item.media_urls || item.media_urls.length === 0) {
                showAlert("Nenhum link de mídia encontrado para este item.");
                return;
            }

            const modal = document.getElementById('modalMediaLinks');
            const listContainer = document.getElementById('mediaLinksList');
            listContainer.innerHTML = ''; // Limpa a lista anterior

            // Cria um item na lista para cada URL
            item.media_urls.forEach(url => {
                const linkItemDiv = document.createElement('div');
                linkItemDiv.className = 'media-link-item';
                linkItemDiv.innerHTML = `
                    <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>
                    <button class="btn-copy" data-url="${url}">Copiar</button>
                `;
                listContainer.appendChild(linkItemDiv);
            });

            // Adiciona o evento de clique a todos os novos botões de copiar
            listContainer.querySelectorAll('.btn-copy').forEach(btn => {
                btn.addEventListener('click', handleCopyLink);
            });

            openModal(modal);
        }

        formAddLinks.addEventListener('submit', async (event) => { 
            event.preventDefault(); 
            const imageFile = linkFormImagem.files[0]; 
            let url_add_link = API_URLS.ADD_LINK;
            let imageBase64 = null; 
            if (imageFile) { 
                try { 
                    imageBase64 = await toBase64(imageFile); 
                    url_add_link = API_URLS.ADD_LINK_BASE64
                } catch (error) { 
                    console.error("Erro ao converter imagem para Base64:", error); 
                    showAlert("Houve um erro ao processar a imagem."); 
                    return; 
                } 
            } 
            const tipoSel = formAddLinks.querySelector('input[name="linkFormTipo"]:checked'); 
            if (!tipoSel) { 
                showAlert("Por favor, selecione o tipo (Post, Story ou Reels)."); 
                return; 
            } 
            const payload = { 
                id: linkFormPostId.value, 
                link_anuncio: linkFormLinkAnuncio.value.trim(), 
                loja_anuncio: linkFormLoja.value, 
                categoria_anuncio: linkFormCategoria.value.trim(), 
                tipo: tipoSel.value, 
                imagem_anuncio_base64: imageBase64,
                conta_user: decodeURIComponent(state.activeAccount)
            }; 
            if (!payload.link_anuncio || !payload.loja_anuncio) { 
                showAlert("Os campos 'Link do Anúncio' e 'Loja' são obrigatórios."); 
                return; 
            } 
            showLoading("Adicionando link..."); 
            try { 
                const response = await fetchWithAuth(url_add_link, { 
                    method: "POST", 
                    body: JSON.stringify(payload) 
                }); 
                const resText = await response.text(); 
                if (!response.ok) throw new Error(resText); 
                showAlert("Link incluído com sucesso: "); 
                formAddLinks.reset(); 
                await fetchData(); // Atualiza a listagem
                handleOpenLinkModal({ target: { dataset: { id: payload.id, type: payload.tipo } } }); 
            } catch (error) { 
                console.error("Erro ao adicionar link:", error); 
                showAlert(`Erro: ${error.message}`); 
            } finally { 
                hideLoading(); 
            } 
        }); 
        document.getElementById('btnSalvarNovaPalavra').addEventListener('click', async () => { 
            const palavra = inputNovaPalavra.value.trim(); if (!palavra) { showAlert("Digite uma palavra."); return; } 
            showLoading("Salvando palavra..."); 
            try { 
                const response = await fetchWithAuth(API_URLS.ADD_COMMENT_KEY, { method: "POST", body: JSON.stringify({ palavra }) }); 
                if (!response.ok) throw new Error(await response.text()); 
                showAlert("Palavra salva!"); state.palavrasSalvasComentario = palavra; 
                listaPalavrasDiv.innerHTML = palavra.replace(/\n/g, '<br>'); closeModal(modalPalavraComentario); fetchData(); 
            } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
            finally { hideLoading(); } 
        }); 
        function handleOpenWhatsAppModal(event) { 
            const videoUrl = event.target.dataset.videoUrl; 
            if (!videoUrl || videoUrl === "null" || videoUrl === "undefined") { showAlert("URL de vídeo indisponível."); return; } 
            whatsPostIdInput.value = event.target.dataset.id; whatsVideoUrlInput.value = videoUrl; 
            inputCustomNumberWhats.value = ''; customNumberInputContainer.style.display = 'none'; 
            openModal(modalEnviarWhatsApp); 
        } 
        document.querySelectorAll('.btn-send-direct-whats').forEach(b => b.addEventListener('click', e => enviarVideoWhatsApp(e.target.dataset.number))); 
        document.getElementById('btnShowCustomNumberWhats').addEventListener('click', () => { customNumberInputContainer.style.display = customNumberInputContainer.style.display === 'none' ? 'block' : 'none'; }); 
        document.getElementById('btnCopyVideoLinkWhats').addEventListener('click', () => { 
            const url = whatsVideoUrlInput.value; 
            if (url && url !== "null" && url !== "undefined") handleCopyLink({target: {dataset: {url: url}}}); else showAlert("URL de vídeo indisponível."); 
        }); 
        document.getElementById('btnSendCustomNumberWhats').addEventListener('click', () => { 
            const num = inputCustomNumberWhats.value.trim(); 
            if (num && /^\d+$/.test(num)) enviarVideoWhatsApp(num); else showAlert("Número inválido."); 
        }); 
        async function enviarVideoWhatsApp(numero) { 
            if (!numero) { showAlert("Número não fornecido."); return; } 
            const videoUrl = whatsVideoUrlInput.value; 
            if (!videoUrl || videoUrl === "null" || videoUrl === "undefined") { showAlert("URL do vídeo inválida."); return; } 
            const itemId = whatsPostIdInput.value; 
            const payload = {  
                numero,  
                id: itemId, 
                link: videoUrl,  
                type: "video", 
                tab: state.activeMediaType  
            }; 
            if(state.activeMediaType === 'carla-baby-stories-base'){ 
                const item = state.items.find(i => String(i.id) === String(itemId)); 
                if(item) { 
                    payload.url_production = item.url_product; 
                } 
            } 
            showLoading("Enviando para WhatsApp..."); 
            try { 
                const response = await fetchWithAuth(API_URLS.SEND_WHATS, { method: "POST", body: JSON.stringify(payload) }); 
                const resText = await response.text(); if (!response.ok) throw new Error(resText); 
                showAlert("Enviado para WhatsApp com sucesso!"); closeModal(modalEnviarWhatsApp);
                await fetchData(); // Atualiza a listagem 
            } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
            finally { hideLoading(); } 
        }
        btnOpenCopyLinkByIdModal.addEventListener('click', () => { 
            copyLinkFormPostId.value = linkFormPostId.value; inputCopyLinkId.value = ''; openModal(modalCopyLinkById); 
        }); 
        formCopyLinkById.addEventListener('submit', async (event) => { 
            event.preventDefault(); 
            const id_post_original = copyLinkFormPostId.value; 
            const id_copy = inputCopyLinkId.value.trim(); 
            const tipoDoLinkOriginal = formAddLinks.querySelector('input[name="linkFormTipo"]:checked')?.value || 'post'; 
            if (!id_post_original || !id_copy) { 
                showAlert("Preencha o ID da postagem de destino e o ID do link a ser copiado."); 
                return; 
            } 
            if (id_post_original === id_copy) {  
                showAlert("O ID da postagem de destino não pode ser o mesmo do ID do link a copiar."); 
                return; 
            } 
            const payload = { 
                id_post: id_post_original,  
                id_copy: id_copy, 
                type: tipoDoLinkOriginal 
            }; 
            showLoading("Copiando link por ID..."); 
                 try { 
                     const response = await fetchWithAuth(API_URLS.COPY_LINK_BY_ID, { 
                         method: "POST", 
                         body: JSON.stringify(payload) 
                     }); 
                     const responseText = await response.text(); 
                     if (!response.ok) { 
                         throw new Error(`Erro HTTP ao copiar link: ${response.status} - ${responseText}`); 
                     } 
                     let resultMessage = responseText; 
                     try { 
                         const jsonResult = JSON.parse(responseText); 
                         resultMessage = jsonResult.message || responseText; 
                     } catch (e) { 
                         // Deixar resultMessage como responseText 
                     } 
                     showAlert(resultMessage || "✅ Link copiado com sucesso!"); 
                     closeModal(modalCopyLinkById); 
                     if (modalAddLinks.style.display === 'flex' && linkFormPostId.value) { 
                         handleOpenLinkModal({ target: { dataset: { id: linkFormPostId.value, type: tipoDoLinkOriginal } } }); 
                     } 
                 } catch (error) { 
                     console.error("Erro ao copiar link por ID:", error); 
                     showAlert(`Erro ao copiar link: ${error.message}`); 
                 } finally { 
                     hideLoading(); 
                 } 
            });

        // --- Funções para Ofertas WhatsApp ---

        async function showWhatsappContentPage() { // Renomeado para evitar conflito com showMediaContent
            state.activeAccount = 'WhatsApp'; // Garante que a conta ativa é WhatsApp
            state.activeMediaType = state.activeMediaType; // Mantém o sub-tipo (nome do grupo)

            // Esconder outras áreas de conteúdo
            [dashboardContentArea, contentDisplayArea, socialAccountsContentArea, companiesContentArea, usersContentArea].forEach(el => el.style.display = 'none');
            whatsappGroupsContentArea.style.display = 'block'; // Área correta para WhatsApp

            whatsappGroupsContentArea.innerHTML = ''; // Limpa a área do WhatsApp

            // Cria o cabeçalho e filtros para WhatsApp
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';

            const title = document.createElement('h2');
            title.textContent = `Ofertas WhatsApp: ${state.activeMediaType}`; // Título específico
            headerDiv.appendChild(title);

            const filtersDiv = document.createElement('div');
            filtersDiv.className = 'filters-container';
            await fetchWhatsappGroups(); // Garante que os grupos e lojas estão carregados
            const lojasOptions = state.whatsappLojas.map(loja => `<option value="${loja}">${loja}</option>`).join('');
            filtersDiv.innerHTML = `
                <div>
                    <label for="filter-loja">Filtrar por Loja:</label>
                    <select id="filter-loja">
                        <option value="">Todas as Lojas</option>
                        ${lojasOptions}
                    </select>
                </div>
            `;
            headerDiv.appendChild(filtersDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'header-actions';

            const createBtn = document.createElement('button');
            createBtn.id = 'btn-create-offer';
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Oferta';
            createBtn.addEventListener('click', handleCreateOfferModal);
            actionsDiv.appendChild(createBtn);

            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn-primary';
            refreshBtn.textContent = 'Atualizar Lista';
            refreshBtn.addEventListener('click', () => fetchData()); // fetchData já busca o WhatsApp
            actionsDiv.appendChild(refreshBtn);

            headerDiv.appendChild(actionsDiv);
            whatsappGroupsContentArea.appendChild(headerDiv);

            // Cria o contêiner dedicado para a tabela de ofertas do WhatsApp
            const whatsappTableContainer = document.createElement('div');
            whatsappTableContainer.id = 'whatsapp-table-display-container'; // Novo ID
            whatsappGroupsContentArea.appendChild(whatsappTableContainer); // Adiciona ao whatsappGroupsContentArea

            // Listener para o filtro da loja
            filtersDiv.querySelector('select').addEventListener('change', applyWhatsappFilters);

            paginationContainer.style.display = 'flex'; // Paginação para o WhatsApp
            await fetchData(); // Busca as ofertas de WhatsApp (que agora vão para renderWhatsappContent)
        }

        function renderWhatsappContent(targetDiv) {
            if (!targetDiv) return;

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Loja</th>
                        <th>Comissão</th>
                        <th>Mensagem</th>
                        <th>URL</th>
                        <th>Imagem</th>
                        <th>Criado em</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.filteredItems.map(createWhatsappTableRow).join('')}
                </tbody>
            `;
            
            tableContainer.appendChild(table);
            targetDiv.appendChild(tableContainer);

            // Adiciona os event listeners corretamente após a tabela ser inserida no DOM
            table.querySelectorAll('.btn-edit-wpp').forEach(btn => btn.addEventListener('click', handleEditWhatsappPost));
            table.querySelectorAll('.btn-delete-wpp').forEach(btn => btn.addEventListener('click', handleDeleteWhatsappPost));
            table.querySelectorAll('.btn-post-wpp').forEach(btn => btn.addEventListener('click', handlePostWhatsappAd));
        }


        function applyWhatsappFilters() {
            const filterLoja = document.getElementById('filter-loja')?.value || '';

            state.filteredItems = state.items.filter(item => {
                const matchesLoja = !filterLoja || item.loja === filterLoja;
                return matchesLoja;
            });

            renderWhatsappTable();
        }

        function renderWhatsappTable() {
            const container = document.getElementById('whatsapp-table-container');
            if (!container) return;

            if (state.filteredItems.length === 0 && !state.isLoading) { // Use filteredItems
                targetDiv.innerHTML = '<p>Nenhum item encontrado para esta visualização.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Loja</th>
                        <th>Comissão</th> 
                        <th>Mensagem</th>
                        <th>URL</th>
                        <th>Imagem</th>
                        <th>Criado em</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.filteredItems.map(createWhatsappTableRow).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);

            table.querySelectorAll('.btn-edit-wpp, .wpp-image-container').forEach(el => el.addEventListener('click', handleEditWhatsappPost));
            table.querySelectorAll('.btn-delete-wpp').forEach(btn => btn.addEventListener('click', handleDeleteWhatsappPost));
            table.querySelectorAll('.btn-post-wpp').forEach(btn => btn.addEventListener('click', handlePostWhatsappAd));
        }
        
        function createWhatsappTableRow(item) {
            const imageUrl = item.image_base64 || '';
            let imageHtml = 'N/A';
            if (imageUrl) {
                const src = imageUrl.startsWith('http') ? imageUrl : `data:image/jpeg;base64,${imageUrl}`;
                imageHtml = `<div class="wpp-image-container" data-id="${item.id}" title="Ver/Editar Imagem">
                                <img src="${src}" class="table-image-preview" alt="Preview" onerror="this.style.display='none'">
                            </div>`;
            }

            return `
                <tr id="wpp-row-${item.id}" data-item='${JSON.stringify(item)}'>
                    <td data-label="Loja">${item.loja || 'N/A'}</td>
                    <td data-label="Comissão">${item.comission || 'N/A'}</td> <td data-label="Mensagem" style="max-width: 250px; white-space: pre-wrap; word-break: break-word;">${item.message_parte1 || 'N/A'}</td>
                    <td data-label="URL"><a href="${item.url_production}" target="_blank">Link</a></td>
                    <td data-label="Imagem">${imageHtml}</td>
                    <td data-label="Criado em">${formatMediaDateTime(item["Created on"])}</td>
                    <td data-label="Ação">
                        <div class="action-buttons">
                            <button class="btn-edit-wpp btn-primary" data-id="${item.id}">Editar</button>
                            <button class="btn-delete-wpp btn-delete" data-id="${item.id}">Excluir</button>
                            <button class="btn-post-wpp btn-whatsapp" data-id="${item.id}">Postar</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        async function handleEditWhatsappPost(event) {
            const id = event.currentTarget.dataset.id;
            const itemData = state.items.find(item => item.id == id);
            if (!itemData) {
                showAlert("Erro: Item da oferta não encontrado.");
                return;
            }
            state.newImageBase64 = null;

            document.getElementById('editWppId').value = itemData.id;
            document.getElementById('editWppLoja').value = itemData.loja || '';
            document.getElementById('editWppMessage').value = itemData.message_parte1 || '';
            document.getElementById('editWppUrl').value = itemData.url_production || '';
            
            const preview = document.getElementById('editWppImagePreview');
            const btnOpenOriginal = document.getElementById('btnOpenOriginalImage');
            let originalImageUrl = '';

            if (itemData.image_base64 && itemData.image_base64.startsWith('http')) {
                originalImageUrl = itemData.image_base64;
                preview.src = originalImageUrl;
            } else if (itemData.image_base64) {
                originalImageUrl = `data:image/jpeg;base64,${itemData.image_base64}`;
                preview.src = originalImageUrl;
            } else {
                preview.src = 'https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem';
            }

            if (originalImageUrl) {
                btnOpenOriginal.style.display = 'block';
                btnOpenOriginal.onclick = () => window.open(originalImageUrl, '_blank');
            } else {
                btnOpenOriginal.style.display = 'none';
            }
            
            document.getElementById('editWppNewImage').value = '';
            openModal(modalEditWhatsapp);
        }

        async function handleSaveWhatsappEdit(event) {
            event.preventDefault();
            const id = document.getElementById('editWppId').value;
            const accountName = decodeURIComponent(state.activeMediaType);
            
            const payload = {
                id: id,
                loja: document.getElementById('editWppLoja').value,
                message_parte1: document.getElementById('editWppMessage').value,
                url_production: document.getElementById('editWppUrl').value,
                grupo: accountName
            };

            if (state.newImageBase64) {
                payload.new_image_base64 = state.newImageBase64;
            }

            showLoading("Salvando alterações...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erro no servidor' }));
                    throw new Error(errorData.message);
                }
                showAlert('Oferta atualizada com sucesso!');
                closeModal(modalEditWhatsapp);
                await fetchData(); // Await garante que a lista atualize
            } catch (error) {
                showAlert(`Erro ao salvar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteWhatsappPost(event) {
            const id = event.currentTarget.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir a oferta de WhatsApp?`);
            if (!confirmed) return;

            const accountName = decodeURIComponent(state.activeMediaType);
            showLoading("Excluindo oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: id, grupo: accountName })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erro no servidor' }));
                    throw new Error(errorData.message);
                }
                showAlert('Oferta excluída com sucesso!');
                await fetchData(); // Await garante que a lista atualize
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handlePostWhatsappAd(event) {
            const id = event.currentTarget.dataset.id;
            const itemData = state.items.find(item => item.id == id);
            if (!itemData) return;

            const confirmed = await showConfirm(`Tem certeza que deseja POSTAR a oferta?`);
            if (!confirmed) return;
            
            const accountName = decodeURIComponent(state.activeMediaType);
            
            const payload = {
                id: itemData.id,
                loja: itemData.loja,
                message_parte1: itemData.message_parte1,
                url_production: itemData.url_production,
                image_base64: itemData.image_base64,
                grupo: accountName
            };

            showLoading("Postando oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');
                showAlert('Oferta postada com sucesso!');
                await fetchData(); // Adiciona o 'await' para esperar a atualização
            } catch (error) {
                showAlert(`Erro ao postar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleCreateOfferModal() {
            // Verifica se estamos em uma página do WhatsApp para pegar o nome do grupo
            const preselectedGroup = (state.activeAccount === 'WhatsApp') ? state.activeMediaType : null;

            // Abre o modal de escolha inicial
            openModal(document.getElementById('modalOfferTypeChoice'));

            // Adiciona os listeners aos botões, passando o grupo pré-selecionado
            document.getElementById('btnCreateOfferFromLink').onclick = () => {
                closeModal(document.getElementById('modalOfferTypeChoice'));
                openGenerateFromLinkModal(preselectedGroup); // Passa o grupo para a próxima função
            };
            
            document.getElementById('btnCreateOfferManually').onclick = () => {
                closeModal(document.getElementById('modalOfferTypeChoice'));
                handleOpenCreateWhatsappModal();
            };
        }

        function openGenerateFromLinkModal(preselectedGroup = null) {
            const modal = document.getElementById('modalGenerateFromLink');
            const form = document.getElementById('formGenerateFromLink');
            const groupSelect = document.getElementById('generateFromLinkGroup');
            
            form.reset();
            groupSelect.innerHTML = ''; // Limpa opções antigas

            // Popula o select com os grupos do WhatsApp
            if (state.whatsappGroups.length > 0) {
                // --- CORREÇÃO APLICADA AQUI ---
                // Ordena os grupos com base no campo 'ordenacao' antes de criar as opções
                const sortedGroups = [...state.whatsappGroups].sort((a, b) => (a.ordenacao || 999) - (b.ordenacao || 999));

                sortedGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.group_name;
                    option.textContent = group.group_name;
                    groupSelect.appendChild(option);
                });
                // --- FIM DA CORREÇÃO ---

                // Seleciona o grupo correto
                if (preselectedGroup) {
                    groupSelect.value = preselectedGroup;
                } else {
                    groupSelect.selectedIndex = 0; // Seleciona o primeiro da lista (agora ordenada) como padrão
                }
            } else {
                // Caso não haja grupos, exibe uma mensagem
                const option = document.createElement('option');
                option.textContent = 'Nenhum grupo encontrado';
                option.disabled = true;
                groupSelect.appendChild(option);
            }
            
            openModal(modal);
        }

        async function handleGenerateAdFromLink(event) {
            if (event) event.preventDefault();
            const urlInput = document.getElementById('generateFromLinkUrl');
            const groupSelect = document.getElementById('generateFromLinkGroup');
            const url = urlInput.value.trim();
            const grupo = groupSelect.value;

            if (!url || !grupo) {
                showAlert("Por favor, preencha o link e selecione um grupo.");
                return;
            }

            showLoading("Gerando anúncio a partir do link...");
            try {
                const response = await fetchWithAuth(API_URLS.GENERATE_AD_FROM_LINK, {
                    method: "POST",
                    body: JSON.stringify({ url: url, grupo: grupo })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erro ao gerar anúncio.' }));
                    throw new Error(errorData.message);
                }
                await response.json();
                
                showAlert('Oferta gerada com sucesso! A lista será atualizada.');
                closeModal(document.getElementById('modalGenerateFromLink'));
                
                if (state.activeAccount !== 'WhatsApp' || state.activeMediaType !== grupo) {
                    navigateTo('media', ['WhatsApp', grupo]);
                } else {
                    await fetchData();
                }
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleCreateOfferSubmit(event) {
            event.preventDefault();
            const accountName = decodeURIComponent(state.activeMediaType);

            const payload = {
                loja: document.getElementById('createWppLoja').value,
                message_parte1: document.getElementById('createWppMessage').value,
                url_production: document.getElementById('createWppUrl').value,
                image_base64: state.newImageBase64,
                conta_user: accountName
            };

            showLoading("Criando nova oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_CREATE, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erro no servidor' }));
                    throw new Error(errorData.message);
                }
                showAlert('Nova oferta criada com sucesso!');
                closeModal(modalCreateWhatsapp);
                await fetchData(); // CORRIGIDO
            } catch (error) {
                showAlert(`Erro ao criar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function populateGroupSelect(selectElement, groups, selectedValue = '') {
            selectElement.innerHTML = '<option value="">Selecione um grupo</option>';
            if (groups && groups.length > 0) {
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.group_name;
                    option.textContent = group.group_name;
                    if (group.group_name === selectedValue) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            }
        }

        // --- Funções de Gerenciamento de Contas ---
        async function showMediaContent(account, type) {
            state.activeAccount = account;
            state.activeMediaType = type;
            const decodedAccountName = decodeURIComponent(account);

            // Limpa as áreas de conteúdo
            [dashboardContentArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea].forEach(el => {
                if (el) el.style.display = 'none';
            });
            contentDisplayArea.style.display = 'block';
            contentDisplayArea.innerHTML = ''; // Limpa a área principal

            // Cria os elementos do cabeçalho
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            const pageTitle = document.createElement('h2');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'header-actions';
            
            // Define o título da página
            const mediaLabel = MEDIA_TYPES.find(mt => mt.key === type)?.label || type;
            const titleText = (decodedAccountName === 'WhatsApp') 
                ? `Ofertas - ${decodeURIComponent(type)}` 
                : `${decodedAccountName} - ${mediaLabel}`;
            pageTitle.textContent = titleText;
            document.title = titleText;

            headerDiv.appendChild(pageTitle); // Adiciona o título primeiro

            // Lógica condicional para filtros e botões de ação
            if (decodedAccountName === 'WhatsApp') {
                const filtersDiv = document.createElement('div');
                filtersDiv.className = 'filters-container';
                const lojasOptions = (state.whatsappLojas || []).map(loja => `<option value="${loja}">${loja}</option>`).join('');
                filtersDiv.innerHTML = `
                    <div>
                        <label for="filter-loja">Filtrar por Loja:</label>
                        <select id="filter-loja">
                            <option value="">Todas as Lojas</option>
                            ${lojasOptions}
                        </select>
                    </div>`;
                headerDiv.appendChild(filtersDiv);

                const createOfferBtn = document.createElement('button');
                createOfferBtn.className = 'btn-primary';
                createOfferBtn.textContent = 'Criar Oferta';
                createOfferBtn.addEventListener('click', handleCreateOfferModal);
                actionsDiv.appendChild(createOfferBtn);

                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'btn-primary';
                refreshBtn.textContent = 'Atualizar Lista';
                refreshBtn.addEventListener('click', fetchData);
                actionsDiv.appendChild(refreshBtn);

                        } else if (type.startsWith('threads-')) { // Lógica para Threads
                const filtersDiv = document.createElement('div');
                filtersDiv.className = 'filters-container';
                filtersDiv.innerHTML = `
                    <div>
                        <label for="filter-threads-category">Filtrar por Categoria:</label>
                        <select id="filter-threads-category"><option value="">Todas</option></select>
                    </div>`;
                headerDiv.appendChild(filtersDiv);

                // Adiciona botão "Recarregar novos Threads" apenas na página FEED
                if (type === 'threads-feed') {
                    const btnReloadThreads = document.createElement('button');
                    btnReloadThreads.className = 'btn-primary';
                    btnReloadThreads.textContent = '🔄 Recarregar novos Threads';
                    btnReloadThreads.addEventListener('click', handleRecarregarThreads);
                    actionsDiv.appendChild(btnReloadThreads);
                }
                
                // Adiciona botão "Baixar novas Postagens" apenas na página Postagens Base
                if (type === 'threads-base-posts') {
                    const btnDownloadPosts = document.createElement('button');
                    btnDownloadPosts.className = 'btn-primary';
                    btnDownloadPosts.textContent = '📥 Baixar novas Postagens';
                    btnDownloadPosts.addEventListener('click', handleOpenDownloadPostsModal);
                    actionsDiv.appendChild(btnDownloadPosts);
                }
                
            } else { // Lógica para Instagram (Reels, Stories, etc.)
                if (type === 'reels') {
                    const btnReloadReels = document.createElement('button');
                    btnReloadReels.className = 'btn-primary';
                    btnReloadReels.textContent = '🔄 Recarregar Novos Reels';
                    btnReloadReels.addEventListener('click', handleRecarregarReels);
                    actionsDiv.appendChild(btnReloadReels);
                } else if (type === 'stories' || type === 'stories-base') {
                    const btnReloadStories = document.createElement('button');
                    btnReloadStories.className = 'btn-primary';
                    btnReloadStories.textContent = '🔄 Recarregar Novos Stories';
                    btnReloadStories.addEventListener('click', handleRecarregarStories);
                    actionsDiv.appendChild(btnReloadStories);
                } else if (type === 'posts') {
                    // Adiciona botão "Baixar novas Postagens" apenas na página Postagens Base do Instagram
                    const btnDownloadPosts = document.createElement('button');
                    btnDownloadPosts.className = 'btn-primary';
                    btnDownloadPosts.textContent = '📥 Baixar novas Postagens';
                    btnDownloadPosts.addEventListener('click', handleOpenDownloadPostsModal);
                    actionsDiv.appendChild(btnDownloadPosts);
                }
            }

            headerDiv.appendChild(actionsDiv);
            contentDisplayArea.appendChild(headerDiv);

            mediaItemsWrapper = document.createElement('div');
            mediaItemsWrapper.id = 'media-items-wrapper';
            contentDisplayArea.appendChild(mediaItemsWrapper);
            
            if(paginationContainer) paginationContainer.style.display = 'flex';

            await fetchData(); // Busca os dados para a view atual
            
            // Popula o filtro de categoria do Threads APÓS os dados serem carregados
            if (type.startsWith('threads-')) {
                const categoryFilterSelect = document.getElementById('filter-threads-category');
                if (categoryFilterSelect) {
                    const categories = [...new Set(state.items.map(item => item.media_category).filter(Boolean))];
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilterSelect.appendChild(option);
                    });
                    categoryFilterSelect.addEventListener('change', applyThreadsFilters);
                }
            }
            // Popula o filtro de loja do WhatsApp APÓS os dados serem carregados
            if (decodedAccountName === 'WhatsApp') {
                const lojaFilterSelect = document.getElementById('filter-loja');
                if (lojaFilterSelect) {
                    lojaFilterSelect.addEventListener('change', applyWhatsappFilters);
                }
            }
        }

        
        async function showSocialAccountsPage() {
            socialAccountsContentArea.style.display = 'block';
            renderSocialAccountsPage(); // Renderiza a estrutura da página
            await fetchData(); // Busca os dados para preencher a tabela
        }

        async function fetchSocialAccounts() {
            try {
                const response = await fetchWithAuth(API_URLS.GET_ACCOUNTS);
                if (!response.ok) throw new Error("Não foi possível carregar as contas.");
                const result = await response.json();
                state.socialAccounts = result?.data || [];
            } catch (error) {
                if (!error.message.includes("Sessão expirada")) {
                    showAlert(`Erro ao carregar contas: ${error.message}`);
                }
                state.socialAccounts = [];
            }
        }

        async function fetchWhatsappGroups() {
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD);
                if (!response.ok) throw new Error("Não foi possível carregar os grupos.");
                const result = await response.json();
                state.whatsappGroups = result?.data || [];
            } catch (error) {
                if (!error.message.includes("Sessão expirada")) {
                    showAlert(`Erro ao carregar grupos do WhatsApp: ${error.message}`);
                }
                state.whatsappGroups = [];
            }
        }

        async function fetchCompanies() {
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_CRUD);
                if (!response.ok) throw new Error("Não foi possível carregar as empresas.");
                const result = await response.json();
                state.companies = result?.data || [];
            } catch (error) {
                if (!error.message.includes("Sessão expirada")) {
                    showAlert(`Erro ao carregar empresas: ${error.message}`);
                }
                state.companies = [];
            }
        }

        function renderSocialAccountsPage() { // Renomeado para renderizar a ESTRUTURA
            socialAccountsContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Contas de Redes Sociais</h2>
                    <div class="header-actions">
                        <button id="btn-create-account" class="btn-primary">Criar Rede Social</button>
                    </div>
                </div>
                <div class="table-container" id="social-accounts-table-container">
                    <p>Carregando contas...</p>
                </div>`;
            
            document.getElementById('btn-create-account').addEventListener('click', () => {
                formCreateSocialAccount.reset();
                openModal(modalCreateSocialAccount);
            });
            
            if (state.socialAccounts.length > 0) {
                renderSocialAccountsTable();
            }
        }

        async function handleCreateSocialAccount(event) {
            event.preventDefault();
            const payload = {
                social_media: document.getElementById('accountType').value,
                nome_conta: document.getElementById('accountName').value.trim(),
                ordenacao: parseInt(document.getElementById('accountOrder').value, 10) || null,
                token: document.getElementById('accountToken').value.trim(),
                webhook: document.getElementById('accountWebhook').value.trim(),
                validated: document.getElementById('accountValidated').checked
            };

            if (!payload.nome_conta || !payload.token) {
                showAlert("Nome da conta e Token são obrigatórios.");
                return;
            }

            showLoading("Salvando conta...");
            try {
                const response = await fetchWithAuth(API_URLS.CREATE_ACCOUNT, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar a conta.");

                showAlert("Conta salva com sucesso!");
                closeModal(modalCreateSocialAccount);
                await fetchSocialAccounts(); // Recarrega as contas
                renderSocialAccountsPage(); // Atualiza a tabela de contas
                renderSidebarMenu(); // Atualiza o menu
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function handleEditAccountModal(accountId) {
            const account = state.socialAccounts.find(acc => (acc.id || acc.nome_conta) == accountId);
            if (!account) {
                showAlert("Conta não encontrada.");
                return;
            }

            document.getElementById('editAccountId').value = account.id || account.nome_conta;
            document.getElementById('editAccountType').value = account.social_media;
            document.getElementById('editAccountName').value = account.nome_conta;
            document.getElementById('editAccountOrder').value = account.ordenacao || '';
            document.getElementById('editAccountToken').value = account.token;
            document.getElementById('editAccountWebhook').value = account.webhook || '';
            document.getElementById('editAccountValidated').checked = account.validated;

            openModal(modalEditSocialAccount);
        }

        async function handleUpdateSocialAccount(event) {
            event.preventDefault();
            const accountId = document.getElementById('editAccountId').value;
            const payload = {
                id: accountId,
                social_media: document.getElementById('editAccountType').value,
                nome_conta: document.getElementById('editAccountName').value.trim(),
                ordenacao: parseInt(document.getElementById('editAccountOrder').value, 10) || null,
                token: document.getElementById('editAccountToken').value.trim(),
                webhook: document.getElementById('editAccountWebhook').value.trim(),
                validated: document.getElementById('editAccountValidated').checked
            };

            showLoading("Atualizando conta...");
            try {
                const response = await fetchWithAuth(API_URLS.UPDATE_ACCOUNT, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Conta atualizada com sucesso!");
                closeModal(modalEditSocialAccount);
                await fetchSocialAccounts();
                renderSocialAccountsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao atualizar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteSocialAccount(accountId) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir a conta? Esta ação não pode ser desfeita.`);
            if (!confirmed) return;

            showLoading("Excluindo conta...");
            try {
                const response = await fetchWithAuth(API_URLS.DELETE_ACCOUNT, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: accountId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Conta excluída com sucesso!");
                await fetchSocialAccounts();
                renderSocialAccountsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function showWhatsappGroupsPage() {
            whatsappGroupsContentArea.style.display = 'block';
            renderWhatsappGroupsPage(); // Renderiza a estrutura
            await fetchData(); // Busca os dados
        }

        function renderWhatsappGroupsPage() {
            whatsappGroupsContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Grupos do WhatsApp</h2>
                    <div class="header-actions">
                        <button id="btn-create-group" class="btn-primary">Criar Grupo</button>
                    </div>
                </div>
                <div class="table-container" id="whatsapp-groups-table-container">
                    <p>Carregando grupos...</p>
                </div>`;
            document.getElementById('btn-create-group').addEventListener('click', () => {
                formWhatsappGroup.reset();
                document.getElementById('whatsappGroupModalTitle').textContent = 'Criar Novo Grupo';
                openModal(modalWhatsappGroup);
            });
            if(state.whatsappGroups.length > 0) {
                renderWhatsappGroupsTable();
            }
        }

        async function handleWhatsappGroupFormSubmit(event) {
            event.preventDefault();
            const payload = {
                name: document.getElementById('whatsappGroupName').value.trim(),
                ordenacao: parseInt(document.getElementById('whatsappGroupOrder').value, 10) || null,
            };
            if (!payload.name) {
                showAlert("O nome do grupo é obrigatório.");
                return;
            }
            
            showLoading("Salvando grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar o grupo.");

                showAlert("Grupo salvo com sucesso!");
                closeModal(modalWhatsappGroup);
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function handleEditWhatsappGroupModal(group) {
            if (!group) return;
            document.getElementById('editWhatsappGroupId').value = group.id;
            document.getElementById('editWhatsappGroupName').value = group.group_name;
            document.getElementById('editWhatsappGroupOrder').value = group.ordenacao || '';
            openModal(modalEditWhatsappGroup);
        }
        
        async function handleUpdateWhatsappGroup(event) {
            event.preventDefault();
            const groupId = document.getElementById('editWhatsappGroupId').value;
            const payload = {
                id: groupId,
                name: document.getElementById('editWhatsappGroupName').value.trim(),
                ordenacao: parseInt(document.getElementById('editWhatsappGroupOrder').value, 10) || null,
            };

            showLoading("Atualizando grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Grupo atualizado com sucesso!");
                closeModal(modalEditWhatsappGroup);
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao atualizar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteWhatsappGroup(groupId) {
             const confirmed = await showConfirm(`Tem certeza que deseja excluir este grupo?`);
            if (!confirmed) return;

            showLoading("Excluindo grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: groupId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Grupo excluído com sucesso!");
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function showCompaniesPage() {
            companiesContentArea.style.display = 'block';
            renderCompaniesPage(); // Renderiza a estrutura
            await fetchData(); // Busca os dados
        }

        function handleEditCompanyDataModal(company) {
            document.getElementById('editCompanyId').value = company.id;
            document.getElementById('editCompanyName').value = company.name || '';
            document.getElementById('editCompanyEmail').value = company.email || '';
            document.getElementById('editCompanyWhatsapp').value = company.whatsapp || '';
            document.getElementById('editCompanyCnpjCpf').value = company.cnpj_cpf || '';

            openModal(document.getElementById('modalEditCompany'));
        }

        async function handleSaveCompanyData(event) {
            event.preventDefault();
            const companyId = document.getElementById('editCompanyId').value;
            const payload = {
                id: companyId,
                name: document.getElementById('editCompanyName').value.trim(),
                email: document.getElementById('editCompanyEmail').value.trim(),
                whatsapp: document.getElementById('editCompanyWhatsapp').value.trim(),
                cnpj_cpf: document.getElementById('editCompanyCnpjCpf').value.trim()
            };

            showLoading("Salvando dados da empresa...");
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar dados da empresa.");

                showAlert("Dados da empresa atualizados com sucesso!");
                closeModal(document.getElementById('modalEditCompany'));
                renderCompaniesPage();
            } catch (error) {
                showAlert(`Erro ao salvar dados da empresa: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function renderCompaniesPage() {
            companiesContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Gerenciamento de Empresas</h2>
                </div>
                <div class="table-container" id="companies-table-container">
                    <p>Carregando empresas...</p>
                </div>`;
            if(state.companies.length > 0) {
                renderCompaniesTable();
            }
        }

        function formatCompanyModules(modules) {
            if (!modules) return 'N/A';
            const activeModules = [];
            for (const key in modules) {
                if (modules[key]) {
                    activeModules.push(key.charAt(0).toUpperCase() + key.slice(1)); // Capitaliza a primeira letra
                }
            }
            return activeModules.length > 0 ? activeModules.join(', ') : 'Nenhum';
        }

        function handleEditCompanyModulesModal(company) {
            document.getElementById('editCompanyModulesId').value = company.id;
            document.getElementById('editCompanyModulesName').textContent = company.name;

            document.getElementById('moduleInstagram').checked = company.modules?.instagram || false;
            document.getElementById('moduleFacebook').checked = company.modules?.facebook || false;
            document.getElementById('moduleThreads').checked = company.modules?.threads || false;
            document.getElementById('moduleWhatsapp').checked = company.modules?.whatsapp || false;

            openModal(document.getElementById('modalEditCompanyModules'));
        }

        async function handleSaveCompanyModules(event) {
            event.preventDefault();
            const companyId = document.getElementById('editCompanyModulesId').value;
            const payload = {
                id: companyId,
                modules: {
                    instagram: document.getElementById('moduleInstagram').checked,
                    facebook: document.getElementById('moduleFacebook').checked,
                    threads: document.getElementById('moduleThreads').checked,
                    whatsapp: document.getElementById('moduleWhatsapp').checked,
                }
            };

            showLoading("Salvando módulos...");
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_MODULES_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar módulos.");

                showAlert("Módulos da empresa atualizados com sucesso!");
                closeModal(document.getElementById('modalEditCompanyModules'));
                await fetchCompanies();
                renderCompaniesPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao salvar módulos: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function showUsersPage() {
            usersContentArea.style.display = 'block';
            renderUsersPage(); // Renderiza a estrutura
            await fetchData(); // Busca os dados
        }

        function renderUsersPage() {
            usersContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Logins de Usuários</h2>
                    <div class="header-actions">
                        <button id="btn-create-user" class="btn-primary">Criar Login</button>
                    </div>
                </div>
                <div class="table-container" id="users-table-container">
                    <p>Carregando usuários...</p>
                </div>`;
            document.getElementById('btn-create-user').addEventListener('click', () => {
                formUser.reset();
                document.getElementById('userId').value = '';
                document.getElementById('userModalTitle').textContent = 'Criar Novo Login';
                document.getElementById('userPasswordField').style.display = 'block';
                openModal(modalUser);
            });
            if(state.users.length > 0) {
                renderUsersTable();
            }
        }

        function handleEditUserModal(user) {
            document.getElementById('userModalTitle').textContent = 'Editar Login';
            document.getElementById('userId').value = user.id;
            userNameInput.value = user.name || '';
            document.getElementById('userEmail').value = user.email || '';
            userPasswordField.style.display = 'none';
            document.getElementById('userPassword').removeAttribute('required');
            userIsActiveCheckbox.checked = user.is_active || false;
            userAdminCheckbox.checked = user.admin || false;
            userDarkThemeCheckbox.checked = user.dark_theme || false;

            openModal(modalUser);
        }
        
        async function handleUserFormSubmit(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const isEditing = !!userId;

            const payload = {
                name: userNameInput.value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                is_active: userIsActiveCheckbox.checked,
                admin: userAdminCheckbox.checked,
                dark_theme: userDarkThemeCheckbox.checked,
                company_id: state.companyId
            };

            let method = 'POST';
            let url = API_URLS.USERS_CRUD;

            if (isEditing) {
                payload.id = userId;
                method = 'PUT';
            } else {
                payload.password = document.getElementById('userPassword').value;
                if (!payload.password) {
                    showAlert("A senha é obrigatória para novos logins.");
                    return;
                }
            }

            showLoading(isEditing ? "Salvando alterações do login..." : "Criando login...");
            try {
                const response = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || (isEditing ? "Erro ao salvar o login." : "Erro ao criar o login."));

                showAlert(isEditing ? "Login atualizado com sucesso!" : "Login criado com sucesso!");
                closeModal(modalUser);
                renderUsersPage();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
                document.getElementById('userPassword').setAttribute('required', 'true');
            }
        }

        async function handleDeleteUser(userId) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir este login?`);
            if (!confirmed) return;

            showLoading("Excluindo login...");
            try {
                const response = await fetchWithAuth(API_URLS.USERS_CRUD, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: userId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Login excluído com sucesso!");
                renderUsersPage();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        // --- Funções de Login e Inicialização ---

        function handleLogout() {
            if(state.authToken) {
                fetchWithAuth(API_URLS.LOGOUT, { method: 'POST' }).catch(err => console.error("Falha ao notificar backend sobre logout:", err));
            }

            state.authToken = null;
            state.companyId = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('companyId');
            localStorage.removeItem('currentUser');
            
            window.location.hash = ''; // Limpa o hash para voltar à página de login
            window.location.reload();
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            showLoading("Autenticando...");

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const payload = {
                email: email,
                password: password
            };

            try {
                const response = await fetch(API_URLS.LOGIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json().catch(() => ({
                    message: `Erro no servidor: ${response.statusText}`
                }));

                if (response.ok && responseData.token && responseData.company_id && responseData.user) {
                    localStorage.setItem('authToken', responseData.token);
                    localStorage.setItem('companyId', responseData.company_id);
                    localStorage.setItem('currentUser', JSON.stringify(responseData.user));

                    window.location.hash = '#/dashboard'; // Redireciona para o dashboard
                    window.location.reload();
                } else {
                    loginError.textContent = responseData.message || 'E-mail ou senha inválidos.';
                }
            } catch (error) {
                console.error("Erro de rede durante o login:", error);
                loginError.textContent = 'Erro de conexão. Tente novamente.';
            } finally {
                hideLoading();
            }
}

        
        async function handleRegisterCompany(event) {
            event.preventDefault();
            registerError.textContent = '';
            showLoading("Cadastrando empresa...");
            
            const payload = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                whatsapp: document.getElementById('reg-whatsapp').value,
                cnpj_cpf: document.getElementById('reg-cnpj-cpf').value
            };

            try {
                const response = await fetch(API_URLS.COMPANIES_CRUD, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(responseData.message || "Erro ao cadastrar empresa.");
                }
                showAlert("Empresa cadastrada com sucesso! Você será redirecionado para o login.", "Sucesso");
                setTimeout(() => {
                    loginContainer.style.display = 'flex';
                    registerContainer.style.display = 'none';
                }, 2000);

            } catch (error) {
                registerError.textContent = error.message;
            } finally {
                hideLoading();
            }
        }

        async function fetchInitialData() {
            sidebar = document.getElementById('sidebar');
            dashboardContentArea = document.getElementById('dashboardContentArea');
            contentDisplayArea = document.getElementById('contentDisplayArea');
            socialAccountsContentArea = document.getElementById('socialAccountsContentArea');
            whatsappGroupsContentArea = document.getElementById('whatsappGroupsContentArea');
            companiesContentArea = document.getElementById('companiesContentArea');
            usersContentArea = document.getElementById('usersContentArea');
            paginationContainer = document.getElementById('paginationContainer');
            loadingOverlay = document.getElementById('loadingOverlayFull');
            scrollTopBtn = document.getElementById('scrollTopBtn');

            await Promise.all([
                fetchSocialAccounts(),
                fetchWhatsappGroups(),
                fetchCompanies()
            ]);
            
            setupEventListeners();
            await router(); // Chama o roteador para carregar a view inicial
        }

        function renderSocialAccountsTable() {
            const container = document.getElementById('social-accounts-table-container');
            if (!container) return;

            const sortedAccounts = [...state.socialAccounts].sort((a, b) => (a.ordenacao ?? 999) - (b.ordenacao ?? 999));

            if (sortedAccounts.length === 0) {
                container.innerHTML = '<p>Nenhuma conta social cadastrada.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ordenação</th>
                        <th>Nome da Conta</th>
                        <th>Rede Social</th>
                        <th>Webhook</th>
                        <th>Validada</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedAccounts.map(acc => `
                        <tr data-account-id="${acc.id || acc.nome_conta}">
                            <td data-label="Ordenação">${acc.ordenacao || 'N/A'}</td>
                            <td data-label="Nome">${acc.nome_conta}</td>
                            <td data-label="Rede Social">${acc.social_media}</td>
                            <td data-label="Webhook" style="word-break: break-all;">${acc.webhook || 'N/A'}</td>
                            <td data-label="Validada" class="validated-icon">${acc.validated ? '✔️' : '❌'}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-primary btn-edit-account">Editar</button>
                                    <button class="btn-delete-account btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderWhatsappGroupsTable() {
            const container = document.getElementById('whatsapp-groups-table-container');
            if (!container) return;
            const sortedGroups = [...state.whatsappGroups].sort((a, b) => (a.ordenacao || 999) - (b.ordenacao || 999));

            if (sortedGroups.length === 0) {
                container.innerHTML = '<p>Nenhum grupo cadastrado.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ordenação</th>
                        <th>Nome do Grupo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedGroups.map(group => `
                        <tr data-group-id="${group.id}">
                            <td data-label="Ordenação">${group.ordenacao || 'N/A'}</td>
                            <td data-label="Nome">${group.group_name}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-edit-wpp-group">Editar</button>
                                    <button class="btn-delete-wpp-group btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
        }


        function renderCompaniesTable() {
            const container = document.getElementById('companies-table-container');
            if (!container) return;
            if (state.companies.length === 0) {
                container.innerHTML = '<p>Nenhuma empresa cadastrada.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Nome da Empresa</th>
                        <th>CNPJ/CPF</th>
                        <th>E-mail</th>
                        <th>Módulos Ativos</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.companies.map(company => `
                        <tr data-company-id="${company.id}">
                            <td data-label="Nome">${company.name}</td>
                            <td data-label="CNPJ/CPF">${company.cnpj_cpf || 'N/A'}</td>
                            <td data-label="E-mail">${company.email || 'N/A'}</td>
                            <td data-label="Módulos">${formatCompanyModules(company.modules)}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-primary btn-edit-company-data">Editar Dados</button>
                                    <button class="btn-primary btn-edit-company-modules">Gerenciar Módulos</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>`;
            container.innerHTML = '';
            container.appendChild(table);

            // ADIÇÃO: Registra os eventos de clique para os botões da tabela
            table.querySelectorAll('.btn-edit-company-data').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyId = e.target.closest('tr').dataset.companyId;
                    const company = state.companies.find(c => c.id == companyId);
                    if (company) handleEditCompanyDataModal(company);
                });
            });

            table.querySelectorAll('.btn-edit-company-modules').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyId = e.target.closest('tr').dataset.companyId;
                    const company = state.companies.find(c => c.id == companyId);
                    if (company) handleEditCompanyModulesModal(company);
                });
            });
        }

        function renderUsersTable() {
            const container = document.getElementById('users-table-container');
            if (!container) return;
            if (state.users.length === 0) {
                container.innerHTML = '<p>Nenhum usuário cadastrado.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Ativo</th>
                        <th>Admin</th>
                        <th>Tema Escuro</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.users.map(user => `
                        <tr data-user-id="${user.id}">
                            <td data-label="Nome">${user.name || 'N/A'}</td>
                            <td data-label="Email">${user.email}</td>
                            <td data-label="Ativo">${user.is_active ? '✔️' : '❌'}</td>
                            <td data-label="Admin">${user.admin ? '✔️' : '❌'}</td>
                            <td data-label="Tema Escuro">${user.dark_theme ? '✔️' : '❌'}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-primary btn-edit-user">Editar</button>
                                    <button class="btn-delete-user btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
        }

        function createThreadsFeedCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(item.threads_date_post);
            const mediaElement = createSmartMediaElement(item);
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = `
                <p style="font-size:0.8em; margin-bottom:10px;">ID: ${item.id} | Postado em: ${formattedDateTime}</p>
                <label for="desc-${item.id}">Descrição:</label>
                <textarea id="desc-${item.id}" readonly>${item.description || ''}</textarea>
                <div class="card-buttons">
                    <button class="btn-whatsapp" data-id="${item.id}" data-video-url="${(item.media_urls || []).find(url => url.includes('.mp4')) || ''}">Enviar p/ WhatsApp</button>
                    <button class="btn-copy btn-copy-media-links" data-id="${item.id}">Copiar Links da Mídia</button>
                    <button class="btn-link" data-id="${item.id}" data-type="threads-feed">Incluir Links</button>
                    ${item.conta_clone_url ? `<button onclick="window.open('${item.conta_clone_url}', '_blank')">Ver no Threads Clone</button>` : ''}
                    ${item.threads_permalink ? `<button onclick="window.open('${item.threads_permalink}', '_blank')">Ver no Threads</button>` : ''}
                    <button class="btn-delete btn-delete-threads" data-id="${item.id}">Deletar Threads</button>
                </div>`;
            card.appendChild(contentDiv);
            
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal);
            card.querySelector('.btn-copy-media-links').addEventListener('click', handleOpenMediaLinksModal);
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-delete-threads').addEventListener('click', handleDeleteThreads);
            
            return card;
        }

        function createThreadsBasePostCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(item.created_at);
            const mediaElement = createSmartMediaElement(item);
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = `
                <p style="font-size:0.8em; margin-bottom:10px;">ID: ${item.id} | Criado em: ${formattedDateTime}</p>
                <label for="desc-${item.id}">Descrição:</label>
                <textarea id="desc-${item.id}">${item.description || ''}</textarea>
                <label for="cat-${item.id}" style="margin-top:10px;">Categoria:</label>
                <input type="text" id="cat-${item.id}" value="${item.media_category || ''}" placeholder="Ex: Especial, Normal">
                <div class="card-buttons">
                    <button class="btn-save btn-save-threads" data-id="${item.id}">Salvar Threads</button>
                    <button class="btn-copy btn-copy-media-links" data-id="${item.id}">Copiar Links da Mídia</button> <button class="btn-link" data-id="${item.id}" data-type="threads-base-posts">Incluir Links</button>
                    <button class="btn-instagram-post btn-post-threads-now" data-id="${item.id}">Postar Agora</button> 
                    ${item.conta_clone_url ? `<button onclick="window.open('${item.conta_clone_url}', '_blank')">Ver no Threads Clone</button>` : ''}
                    ${item.threads_permalink ? `<button onclick="window.open('${item.threads_permalink}', '_blank')">Ver no Threads</button>` : ''}
                    <button class="btn-delete btn-delete-threads" data-id="${item.id}">Deletar Threads</button>
                </div>`;
            card.appendChild(contentDiv);

            card.querySelector('.btn-save-threads').addEventListener('click', handleSaveThreads);
            card.querySelector('.btn-copy-media-links').addEventListener('click', handleOpenMediaLinksModal); // Listener adicionado
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-delete-threads').addEventListener('click', handleDeleteThreads);
            card.querySelector('.btn-post-threads-now').addEventListener('click', handlePostThreadsNow);

            return card;
        }

        async function handleSaveThreads(event) {
            const itemId = event.target.dataset.id;
            const cardElement = event.target.closest('.card');
            if (!cardElement) return;

            const isFeed = state.activeMediaType === 'threads-feed';
            const endpoint = isFeed ? API_URLS.THREADS_FEED : API_URLS.THREADS_BASE_POSTS;
            const url = `${url_base}${endpoint}`;

            const payload = {
                id: itemId,
                description: cardElement.querySelector(`#desc-${itemId}`).value,
            };

            // Adiciona a categoria ao payload apenas se estiver na página de Postagens Base
            if (!isFeed) {
                payload.media_category = cardElement.querySelector(`#cat-${itemId}`).value;
            }

            showLoading("Salvando alteração no Threads...");
            try {
                const response = await fetchWithAuth(url, {
                    method: "PUT",
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                showAlert('Post do Threads atualizado com sucesso!');
                await fetchData();
            } catch (error) {
                showAlert(`Erro ao salvar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteThreads(event) {
            const itemId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir este item do Threads (ID: ${itemId})?`);
            if (!confirmed) return;

            // Lógica para escolher o endpoint correto
            const isFeed = state.activeMediaType === 'threads-feed';
            const endpoint = isFeed ? API_URLS.THREADS_FEED : API_URLS.THREADS_BASE_POSTS;
            const url = `${url_base}${endpoint}`;

            showLoading("Excluindo item do Threads...");
            try {
                const response = await fetchWithAuth(url, {
                    method: "DELETE",
                    body: JSON.stringify({ id: itemId })
                });
                if (!response.ok) throw new Error(await response.text());
                showAlert("Item excluído com sucesso.");
                await fetchData();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handlePostThreadsNow(event) {
            const postId = event.target.dataset.id;
            const confirmed = await showConfirm(`Deseja postar este item (ID: ${postId}) no Threads agora?`);
            if (!confirmed) return;

            showLoading("Postando no Threads...");
            try {
                const payload = {
                    id: postId,
                    conta_user: decodeURIComponent(state.activeAccount) 
                };
                const response = await fetchWithAuth(`${url_base}/${API_URLS.POST_THREADS_MANUAL}`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao postar.");
                
                showAlert("Post enviado para o Threads com sucesso!");
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function applyThreadsFilters() {
            const categoryFilter = document.getElementById('filter-threads-category')?.value;
            if (!categoryFilter) {
                state.filteredItems = [...state.items];
            } else {
                state.filteredItems = state.items.filter(item => item.media_category === categoryFilter);
            }
            renderItems(); // Re-renderiza os cards com os itens filtrados
        }


        function handleRecarregarThreads() {
            if (!state.activeAccount) {
                showAlert("Por favor, selecione uma conta no menu lateral primeiro.");
                return;
            }
            showLoading("Solicitando atualização do Threads...");
            const endpoint = `${url_base}/${API_URLS.FORCE_UPDATE_THREADS}?conta_user=${decodeURIComponent(state.activeAccount)}`;
            
            fetchWithAuth(endpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na atualização forçada do Threads.');
                    showAlert("Atualização do Threads solicitada! A lista será atualizada em breve.");
                    setTimeout(fetchData, 5000); // Dá um tempo para o backend processar
                })
                .catch(err => showAlert(`Erro: ${err.message}`))
                .finally(hideLoading);
        }

        // --- Funções para o modal de post agendado ---
        function handleOpenScheduledPostModal(post = null) {
            formScheduledPost.reset();
            document.getElementById('media-preview-container').innerHTML = '';
            state.scheduledPostFiles = [];

            if (post) { // Modo Edição
                document.getElementById('scheduledPostModalTitle').textContent = 'Editar Postagem';
                document.getElementById('scheduledPostId').value = post.id;
                document.getElementById('scheduledPostDescription').value = post.description || '';
                if (post.schedule_time) {
                    const d = new Date(post.schedule_time);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    document.getElementById('scheduledPostDateTime').value = d.toISOString().slice(0, 16);
                }
                if(post.media_urls && Array.isArray(post.media_urls)){
                    post.media_urls.forEach(url => {
                        const previewContainer = document.getElementById('media-preview-container');
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'media-preview-item';
                        if (url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.mov') || url.toLowerCase().includes('video')) {
                            itemDiv.innerHTML = `<video src="${url}"></video>`;
                        } else {
                            itemDiv.innerHTML = `<img src="${url}" alt="Preview">`;
                        }
                        previewContainer.appendChild(itemDiv);
                    });
                }

            } else { // Modo Criação
                document.getElementById('scheduledPostModalTitle').textContent = 'Criar Nova Postagem';
                document.getElementById('scheduledPostId').value = '';
            }

            openModal(modalScheduledPost);
        }

        async function handleScheduledPostFormSubmit(event) {
            event.preventDefault();
            const postId = document.getElementById('scheduledPostId').value;
            const isEditing = !!postId;

            showLoading(isEditing ? "Atualizando postagem..." : "Criando postagem...");

            const mediaBase64Promises = state.scheduledPostFiles.map(file => toBase64(file));
            const media_base64 = await Promise.all(mediaBase64Promises);

            const payload = {
                description: document.getElementById('scheduledPostDescription').value,
                schedule_time: document.getElementById('scheduledPostDateTime').value,
                media_base64: media_base64,
                conta_user: state.activeAccount
            };

            let url = API_URLS.SCHEDULED_POSTS_CRUD;
            let method = isEditing ? 'PUT' : 'POST';

            if(isEditing) {
                payload.id = postId;
            }

            try {
                const response = await fetchWithAuth(url, { method, body: JSON.stringify(payload) });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');
                
                showAlert(isEditing ? 'Postagem atualizada com sucesso!' : 'Postagem criada com sucesso!');
                closeModal(modalScheduledPost);
                await fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // NOVO: Função para gerar anúncio a partir de um link
        async function handleGenerateAdFromLink() {
            const urlInput = document.getElementById('generateFromLinkUrl');
            const url = urlInput.value.trim();
            if (!url) {
                showAlert("Por favor, insira uma URL para gerar o anúncio.");
                return;
            }
            const accountName = decodeURIComponent(state.activeMediaType);

            showLoading("Gerando anúncio...");
            fetchWithAuth(API_URLS.GENERATE_AD_FROM_LINK, { method: "POST", body: JSON.stringify({ url: url, grupo: accountName }) })
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); })
                .then(async () => { showAlert('Anúncio criado com sucesso!'); closeModal(modalGenerateFromLink); await fetchData(); })
                .catch(error => { 
                    if (error.message !== "Sessão expirada.") {
                        console.error("Erro:", error); showAlert(`Erro: ${error.message}`); 
                    }
                })
                .finally(hideLoading);
        }

        // --- Funções do Dashboard ---
        async function showDashboardPage() {
            dashboardContentArea.style.display = 'block';
            await fetchDashboardMetrics();
        }

        async function fetchDashboardMetrics() {
            showLoading("Carregando métricas...");
            try {
                // Simulação de chamada de API
                // const response = await fetchWithAuth(API_URLS.GET_DASHBOARD_METRICS);
                // if (!response.ok) throw new Error("Não foi possível carregar as métricas.");
                // const metrics = await response.json();
                
                // Dados mocados para demonstração
                const mockMetrics = {
                    postsToday: 5,
                    storiesToday: 15,
                    postsWeek: 21,
                    storiesWeek: 95, // Nova métrica
                    reelsWeek: 12,
                    likesWeek: 1250,   // Nova métrica
                    commentsWeek: 180, // Nova métrica
                    sharesWeek: 230,   // Nova métrica
                    savedWeek: 450,    // Nova métrica
                    postsMonth: 89,
                    storiesMonth: 350,
                    reelsMonth: 45
                };
                
                renderDashboard(mockMetrics);

            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar métricas: ${error.message}`);
                }
                dashboardContentArea.innerHTML = '<p>Não foi possível carregar as métricas do dashboard.</p>';
            } finally {
                hideLoading();
            }
        }

        function renderDashboard(metrics) {
            dashboardContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Dashboard</h2>
                </div>

                <h3>Atalhos</h3>
                <div class="shortcuts-grid" style="margin-bottom: 40px;">
                    <div class="card">
                        <button id="btnShortcutGenerateOffer" class="btn-primary" style="width:100%;">Gerar Oferta por Link</button>
                    </div>
                    </div>

                <h3>Métricas da Semana (Instagram)</h3>
                <div class="dashboard-container">
                    <div class="chart-card">
                        <h3>Publicações na Semana</h3>
                        <canvas id="postsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Engajamento na Semana</h3>
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            `;

            // Listener para o botão de atalho
            document.getElementById('btnShortcutGenerateOffer').addEventListener('click', handleCreateOfferModal);

            // --- Lógica para criar os gráficos ---
            
            // Gráfico 1: Posts vs. Stories vs. Reels
            const postsCtx = document.getElementById('postsChart').getContext('2d');
            new Chart(postsCtx, {
                type: 'doughnut', // Tipo de gráfico: rosca
                data: {
                    labels: ['Posts na Semana', 'Stories na Semana', 'Reels na Semana'],
                    datasets: [{
                        label: 'Publicações',
                        data: [metrics.postsWeek, metrics.storiesWeek, metrics.reelsWeek],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Gráfico 2: Engajamento (Likes, Comentários, Salvos)
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            new Chart(engagementCtx, {
                type: 'bar', // Tipo de gráfico: barras
                data: {
                    labels: ['Likes', 'Comentários', 'Compart.', 'Salvos'],
                    datasets: [{
                        label: 'Total na Semana',
                        data: [metrics.likesWeek, metrics.commentsWeek, metrics.sharesWeek, metrics.savedWeek],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function saveSidebarState() {
            const sidebarState = {};
            document.querySelectorAll('.sidebar-menu .menu-parent').forEach(menu => {
                const key = menu.textContent.trim();
                if (key) { // Garante que não salvemos chaves vazias
                    sidebarState[key] = !menu.classList.contains('collapsed');
                }
            });
            localStorage.setItem('sidebarState', JSON.stringify(sidebarState));
        }

        function applySidebarState(menuElement, key) {
            const savedState = JSON.parse(localStorage.getItem('sidebarState'));
            if (savedState && savedState[key] !== undefined) {
                if (savedState[key]) { // Se deve estar aberto
                    menuElement.classList.remove('collapsed');
                    if (menuElement.nextElementSibling) {
                        menuElement.nextElementSibling.classList.remove('collapsed');
                    }
                } else { // Se deve estar fechado
                    menuElement.classList.add('collapsed');
                    if (menuElement.nextElementSibling) {
                        menuElement.nextElementSibling.classList.add('collapsed');
                    }
                }
            }
        }

        function setupEventListeners() {
            const mainContentEl = document.querySelector('.main-content');

            // Bloqueio de Zoom no Mobile
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.body.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });

            // Botão de voltar ao topo
            if (mainContentEl && scrollTopBtn) {
                mainContentEl.addEventListener('scroll', () => {
                    scrollTopBtn.style.display = (mainContentEl.scrollTop > 200) ? "block" : "none";
                });
                scrollTopBtn.addEventListener('click', () => {
                    mainContentEl.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            document.getElementById('btnPasteLink').addEventListener('click', async () => {
                try {
                    // Pede permissão e lê o texto da área de transferência
                    const text = await navigator.clipboard.readText();
                    
                    // Coloca o texto copiado no campo de input
                    document.getElementById('linkFormLinkAnuncio').value = text;
                } catch (err) {
                    console.error('Falha ao colar da área de transferência: ', err);
                    showAlert('Não foi possível ler da área de transferência. Verifique as permissões do navegador ou cole manualmente.');
                }
            });

            // Toggle do menu
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                document.body.classList.toggle('sidebar-collapsed');
            });

            // Fechar sidebar ao clicar fora (no mobile)
            // document.querySelector('.app-body').addEventListener('click', (e) => {
            //     if (window.innerWidth <= 992 && !document.body.classList.contains('sidebar-collapsed') && !sidebar.contains(e.target) && !document.getElementById('menuToggleBtn').contains(e.target)) {
            //         document.body.classList.remove('sidebar-collapsed');
            //     }
            // });

            mainContentEl.addEventListener('click', () => {
                // Verifica se estamos em uma tela de celular e se o menu está aberto
                if (window.innerWidth <= 992 && document.body.classList.contains('sidebar-collapsed')) {
                    // Fecha o menu
                    document.body.classList.remove('sidebar-collapsed');
                }
            });

            // Lógica para o novo menu de Configurações na engrenagem
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsDropdown = document.getElementById('settingsDropdown');
            
            if (settingsBtn && settingsDropdown) {
                settingsDropdown.innerHTML = `
                    <button id="menu-companies">Empresas</button>
                    <button id="menu-users">Usuários</button>
                    <button id="menu-accounts">Redes Sociais</button>
                    <button id="menu-whatsapp-groups-config">Grupos WhatsApp</button>
                    <button id="menu-keyword">Palavra Chave</button>
                    <button id="menu-logout">Logout</button>
                `;

                settingsDropdown.querySelector('#menu-companies').addEventListener('click', () => { navigateTo('settings', ['companies']); });
                settingsDropdown.querySelector('#menu-users').addEventListener('click', () => { navigateTo('settings', ['users']); });
                settingsDropdown.querySelector('#menu-accounts').addEventListener('click', () => { navigateTo('settings', ['accounts']); });
                settingsDropdown.querySelector('#menu-whatsapp-groups-config').addEventListener('click', () => { navigateTo('settings', ['whatsapp-groups']); });
                settingsDropdown.querySelector('#menu-keyword').addEventListener('click', handleIncluirPalavra);
                settingsDropdown.querySelector('#menu-logout').addEventListener('click', handleLogout);

                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('show');
                });
            }

            // Fecha o dropdown se clicar fora
            window.addEventListener('click', (e) => {
                if (settingsDropdown && settingsBtn && !settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) {
                    settingsDropdown.classList.remove('show');
                }
            });

            // O resto dos seus event listeners
            formCreateSocialAccount.addEventListener('submit', handleCreateSocialAccount);
            formEditSocialAccount.addEventListener('submit', handleUpdateSocialAccount);
            
            socialAccountsContentArea.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;

                if (target.classList.contains('btn-edit-account')) {
                    const accountId = row.dataset.accountId;
                    handleEditAccountModal(accountId);
                }
                if (target.classList.contains('btn-delete-account')) {
                    const accountId = row.dataset.accountId;
                    handleDeleteSocialAccount(accountId);
                }
            });

            companiesContentArea.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                const companyId = row.dataset.companyId;
                const company = state.companies.find(c => c.id == companyId);
                if (!company) return;

                if (target.classList.contains('btn-edit-company-data')) {
                    handleEditCompanyDataModal(company);
                }
                if (target.classList.contains('btn-edit-company-modules')) {
                    handleEditCompanyModulesModal(company);
                }
            });

            whatsappGroupsContentArea.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                const groupId = row.dataset.groupId;
                if (target.classList.contains('btn-edit-wpp-group')) {
                    const group = state.whatsappGroups.find(g => g.id == groupId);
                    if (group) handleEditWhatsappGroupModal(group);
                }
                if (target.classList.contains('btn-delete-wpp-group')) {
                    handleDeleteWhatsappGroup(groupId);
                }
            });

            usersContentArea.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                const userId = row.dataset.userId;

                if (target.classList.contains('btn-edit-user')) {
                    const user = state.users.find(u => u.id == userId);
                    if(user) handleEditUserModal(user);
                }
                if (target.classList.contains('btn-delete-user')) {
                    handleDeleteUser(userId);
                }
            });

            formWhatsappGroup.addEventListener('submit', handleWhatsappGroupFormSubmit);
            formEditWhatsappGroup.addEventListener('submit', handleUpdateWhatsappGroup);
            formUser.addEventListener('submit', handleUserFormSubmit);
            
            if (formEditWhatsapp) formEditWhatsapp.addEventListener('submit', handleSaveWhatsappEdit);
            if (formCreateWhatsapp) formCreateWhatsapp.addEventListener('submit', handleCreateOfferSubmit);
            
            document.getElementById('editWppNewImage').addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    state.newImageBase64 = await toBase64(e.target.files[0]);
                    document.getElementById('editWppImagePreview').src = `data:image/jpeg;base64,${state.newImageBase64}`;
                    document.getElementById('btnOpenOriginalImage').style.display = 'none';
                }
            });
            document.getElementById('createWppNewImage').addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    state.newImageBase64 = await toBase64(e.target.files[0]);
                    document.getElementById('createWppImagePreview').src = `data:image/jpeg;base64,${state.newImageBase64}`;
                }
            });
            
            formScheduledPost.addEventListener('submit', handleScheduledPostFormSubmit);
            document.getElementById('scheduledPostMedia').addEventListener('change', (event) => {
                // ... (lógica de preview de mídias)
            });

            document.getElementById('formEditCompanyModules').addEventListener('submit', handleSaveCompanyModules);
            document.getElementById('formEditCompany').addEventListener('submit', handleSaveCompanyData);
            document.getElementById('formUser').addEventListener('submit', handleUserFormSubmit);

            const btnOpenAdUrl = document.getElementById('btnOpenAdUrl');
            if (btnOpenAdUrl) {
                btnOpenAdUrl.addEventListener('click', () => {
                    const url = document.getElementById('createWppUrl').value.trim();
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        showAlert("Nenhuma URL para abrir.");
                    }
                });
            }
        }

        // --- Ponto de Entrada da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            loginContainer = document.getElementById('login-container');
            registerContainer = document.getElementById('register-container');
            appContainer = document.getElementById('app-container');

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegisterCompany);

            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'flex';
            });

            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                loginContainer.style.display = 'flex';
                registerContainer.style.display = 'none';
            });

            document.querySelectorAll('.modal-close-btn, .modal-close-btn-alternative').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const modalId = event.target.dataset.modalId;
                    if (modalId) {
                        const modalToClose = document.getElementById(modalId);
                        if (modalToClose) closeModal(modalToClose);
                    }
                });
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (event) => {
                    if (event.target === overlay) closeModal(overlay);
                });
            });

            existingLinksListDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('btn-delete-link')) {
                    handleDeleteLink(event);
                }
            });

            // Event listeners para os botões do modal de escolha de tipo de oferta
            const btnCreateOfferFromLink = document.getElementById('btnCreateOfferFromLink');
            const btnCreateOfferManually = document.getElementById('btnCreateOfferManually');
            
            if (btnCreateOfferFromLink) {
                btnCreateOfferFromLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão "Gerar por Link" clicado');
                    closeModal(document.getElementById('modalOfferTypeChoice'));
                    openModal(document.getElementById('modalGenerateFromLink'));
                    document.getElementById('formGenerateFromLink').reset();
                });
            } else {
                console.warn('Botão "Gerar por Link" não encontrado');
            }

            if (btnCreateOfferManually) {
                btnCreateOfferManually.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botão "Criar Manualmente" clicado');
                    closeModal(document.getElementById('modalOfferTypeChoice'));
                    // Abre o modal de criação manual que já existe
                    formCreateWhatsapp.reset();
                    state.newImageBase64 = null;
                    document.getElementById('createWppImagePreview').src = 'https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem';
                    openModal(modalCreateWhatsapp);
                });
            } else {
                console.warn('Botão "Criar Manualmente" não encontrado');
            }

            const formGenerateFromLink = document.getElementById('formGenerateFromLink');
            if (formGenerateFromLink) {
                formGenerateFromLink.addEventListener('submit', handleGenerateAdFromLink);
                console.log('Event listener para formGenerateFromLink adicionado');
            } else {
                console.warn('Formulário formGenerateFromLink não encontrado');
            }
            
            document.getElementById('btnPasteAndGenerate').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('generateFromLinkUrl').value = text;
                    // Não submete automaticamente o formulário - deixa o usuário clicar em "Gerar"
                } catch (err) {
                    showAlert('Não foi possível ler da área de transferência.');
                }
            });

            // Event listener para o modal de download de postagens
            document.getElementById('formDownloadPosts').addEventListener('submit', handleDownloadPosts);
            
            // Event listener para mostrar/ocultar campos no modal de download
            document.getElementById('downloadType').addEventListener('change', function() {
                const linkInputGroup = document.getElementById('linkInputGroup');
                const contaInputGroup = document.getElementById('contaInputGroup');
                const downloadLink = document.getElementById('downloadLink');
                const downloadConta = document.getElementById('downloadConta');
                
                if (this.value === 'conta_clone') {
                    linkInputGroup.style.display = 'block';
                    contaInputGroup.style.display = 'none';
                    downloadLink.required = true;
                    downloadConta.required = false;
                } else if (this.value === 'link') {
                    linkInputGroup.style.display = 'none';
                    contaInputGroup.style.display = 'block';
                    downloadLink.required = false;
                    downloadConta.required = true;
                } else {
                    linkInputGroup.style.display = 'none';
                    contaInputGroup.style.display = 'none';
                    downloadLink.required = false;
                    downloadConta.required = false;
                }
            });

            const savedToken = localStorage.getItem('authToken');
            const savedCompanyId = localStorage.getItem('companyId');
            const savedUser = localStorage.getItem('currentUser');

            let isLoggedIn = false;

            if (savedToken && savedCompanyId) {
                state.authToken = savedToken;
                state.companyId = savedCompanyId;

                if (savedUser && savedUser !== 'undefined' && savedUser !== 'null') {
                    try {
                        const user = JSON.parse(savedUser);
                        state.currentUser = user;

                        if (state.currentUser.dark_theme) {
                            document.body.classList.add('dark-theme');
                        } else {
                            document.body.classList.remove('dark-theme');
                        }
                        isLoggedIn = true;
                    } catch (e) {
                        console.error("Erro ao parsear 'currentUser' do localStorage. Limpando dados de login.", e);
                        handleLogout(); // Limpa tudo se os dados estiverem corrompidos
                    }
                }
            }

            if (isLoggedIn) {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                
                window.addEventListener('hashchange', router);

                fetchInitialData(); // <-- Chamando a função com o nome correto
            } else {
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        // Funções para o modal de download de postagens
        function handleOpenDownloadPostsModal(event) {
            console.log('event', event);
            const contaUser = event.target.dataset.contaUser;
            const modal = document.getElementById('modalDownloadPosts');
            
            // Preenche automaticamente o nome da conta
            document.getElementById('downloadConta').value = '';
            
            // Reseta o formulário
            document.getElementById('formDownloadPosts').reset();
            document.getElementById('downloadConta').value = ''; // Mantém o valor da conta
            
            // Esconde os campos dinâmicos
            document.getElementById('linkInputGroup').style.display = 'none';
            document.getElementById('contaInputGroup').style.display = 'none';
            
            openModal(modal);
        }

        async function handleDownloadPosts(event) {
            event.preventDefault();
            
            const form = event.target;
            const downloadType = document.getElementById('downloadType').value;
            const downloadLink = document.getElementById('downloadLink').value;
            const downloadConta = document.getElementById('downloadConta').value;
            const downloadMediaType = document.getElementById('downloadMediaType').value;
            const downloadCategory = document.getElementById('downloadCategory').value;
            
            if (!downloadType || !downloadMediaType) {
                showAlert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (downloadType === 'conta_clone' && !downloadLink) {
                showAlert('Por favor, insira o link.');
                return;
            }
            
            if (downloadType === 'link' && !downloadConta) {
                showAlert('Por favor, insira o nome da conta.');
                return;
            }
            
            showLoading('Baixando novas postagens...');
            
            try {
                let endpoint, payload;
                
                // Determina o tipo da rede social baseado na página atual
                const socialNetworkType = state.activeMediaType.startsWith('threads') ? 'THREADS' : 'INSTAGRAM';

                const conta_user = decodeURIComponent(state.activeAccount);
            
                if (downloadType === 'conta_clone') {
                    endpoint = API_URLS.DOWNLOAD_MEDIA_POSTAGENS;
                    payload = {
                        link: downloadLink,
                        conta_user: conta_user,   
                        media_type: downloadMediaType,
                        tipo: socialNetworkType,
                        company_id: state.companyId
                    };
                } else {
                    endpoint = API_URLS.DOWNLOAD_MEDIA_POSTAGENS;
                    payload = {
                        conta_clone: downloadConta,
                        conta_user: conta_user, 
                        media_type: downloadMediaType,
                        tipo: socialNetworkType,
                        company_id: state.companyId
                    };
                }
                
                // Adiciona categoria se fornecida
                if (downloadCategory) {
                    payload.categoria = downloadCategory;
                }
                
                const response = await fetchWithAuth(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                showAlert('Postagens baixadas com sucesso!');
                closeModal(document.getElementById('modalDownloadPosts'));
                
                // Recarrega os dados da página atual
                await fetchData();
                
            } catch (error) {
                showAlert(`Erro ao baixar postagens: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

    </script>
</body>
</html>
