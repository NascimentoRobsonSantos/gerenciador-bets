<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Posts</title>
    <style>
        /* Reset Básico e Variáveis de Tema */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1c1e21;
            --card-bg-color: #ffffff;
            --header-bg-color: #ffffff;
            --border-color: #ddd;
            --input-bg-color: #ffffff;
            --input-border-color: #ccc;
            --hover-bg-color: #e4e6eb;
            --hover-darker-bg-color: #d8dbdf;
            --sidebar-hover-bg: #f0f2f5;
            --active-menu-bg: #e7f3ff;
            --active-menu-text: #1877f2;
            --stats-bg-color: #f0f2f5;
            --stats-border-color: #e0e0e0;
        }

        body.dark-theme {
            --bg-color: #18191a;
            --text-color: #e4e6eb;
            --card-bg-color: #242526;
            --header-bg-color: #242526;
            --border-color: #3a3b3c;
            --input-bg-color: #3a3b3c;
            --input-border-color: #4d4d4d;
            --hover-bg-color: #3a3b3c;
            --hover-darker-bg-color: #4d4d4d;
            --sidebar-hover-bg: #3a3b3c;
            --active-menu-bg: #3a3b3c;
            --active-menu-text: #2d88ff;
            --stats-bg-color: #3a3b3c;
            --stats-border-color: #4d4d4d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Previne scroll no body */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- TELAS DE LOGIN E REGISTRO --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .auth-box {
            width: 100%;
            max-width: 400px;
            padding: 30px;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .auth-box h2 {
            margin-bottom: 20px;
        }
        .auth-box .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .auth-box input {
            margin-bottom: 0;
        }
        #login-error, #register-error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 10px;
            min-height: 1.2rem;
            display: block;
        }
        .auth-switch {
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .auth-switch a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        .auth-switch a:hover {
            text-decoration: underline;
        }


        /* --- LAYOUT DA APLICAÇÃO --- */
        .app-container {
            display: none; /* Inicia oculto */
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            background-color: var(--header-bg-color);
            color: var(--text-color);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-left a {
            text-decoration: none;
            color: inherit;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .menu-toggle-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .app-body {
            display: flex;
            flex-grow: 1;
            margin-top: 60px; /* Altura do header */
            height: calc(100vh - 60px);
            overflow: hidden; /* Previne scroll duplo */
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background-color: var(--card-bg-color);
            padding: 20px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out, background-color 0.3s, border-color 0.3s;
            z-index: 1002;
        }
        
        body.sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }

        .sidebar-menu .menu-group > .menu-parent {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-color);
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
        }
        .sidebar-menu .menu-group > .menu-parent:hover {
            background-color: var(--sidebar-hover-bg);
        }
        .sidebar-menu .menu-group > .menu-parent::after {
            content: '▼';
            font-size: 0.7rem;
            transition: transform 0.2s ease;
        }
        .sidebar-menu .menu-group > .menu-parent.collapsed::after {
            transform: rotate(-90deg);
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow: hidden;
            max-height: 1000px; /* Altura grande para permitir a animação */
            transition: max-height 0.4s ease-in-out;
        }

        .sidebar-menu ul.collapsed {
            max-height: 0;
        }

        .sidebar-menu .submenu-item {
            padding: 8px 12px 8px 25px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .sidebar-menu .submenu-item:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .sidebar-menu .submenu-item.active {
            background-color: var(--active-menu-bg);
            color: var(--active-menu-text);
            font-weight: 600;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 280px;
            overflow-y: auto;
            height: 100%;
            transition: margin-left 0.3s ease-in-out;
            -webkit-overflow-scrolling: touch; /* Melhora scroll no iOS */
        }
        
        body.sidebar-collapsed .main-content {
            margin-left: 0;
        }
        
        .sidebar-actions {
            display: none;
        }

        @media (max-width: 992px) { 
            .main-content { margin-left: 0; }
            .sidebar { transform: translateX(-100%); }
            body.sidebar-collapsed .sidebar {
                transform: translateX(0); 
            }
            .header-actions, .settings-container { display: none; }
            .sidebar-actions { display: block; }
        }

        button {
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            background-color: var(--hover-bg-color);
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: var(--hover-darker-bg-color);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        textarea { min-height: 100px; resize: vertical; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; }
        #contentDisplayArea, #socialAccountsContentArea, #whatsappGroupsContentArea, #companiesContentArea, #usersContentArea, #dashboardContentArea { min-height: 400px; }
        #socialAccountsContentArea, #whatsappGroupsContentArea, #companiesContentArea, #usersContentArea, #dashboardContentArea { display: none; } /* Oculto por padrão */

        .grid-container, .stats-grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        @media (max-width: 1600px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 1300px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1100px) { .grid-container, .stats-grid-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-container, .stats-grid-container { grid-template-columns: 1fr; } }

        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card .media-content { 
            width: 100%; 
            height: auto; 
            aspect-ratio: 5 / 8;
            border-radius: 6px; 
            margin-bottom: 10px; 
            background-color: var(--bg-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            position: relative;
        }
        .card .media-content span { color: #888; font-size: 0.9rem; }
        .card .media-content img, .card .media-content video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-buttons { margin-top: auto; display: flex; flex-direction: column; gap: 8px; }
        .card-buttons button { width: 100%; }

        .play-button-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .play-button-overlay:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .play-button-overlay svg {
            width: 60px;
            height: 60px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .list-item-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; width: 100%; margin-bottom: 10px; }
        .list-item-stats p { 
            margin: 0; 
            padding: 5px; 
            background-color: var(--stats-bg-color); 
            border-radius: 4px; 
            border: 1px solid var(--stats-border-color);
            color: var(--text-color);
            font-size: 0.75rem; 
            text-align: center; 
            word-break: break-word; 
        }
        
        .btn-save { background-color: #28a745; color: white; }
        .btn-save:hover { background-color: #218838; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-link { background-color: #17a2b8; color: white; }
        .btn-link:hover { background-color: #138496; }
        .btn-instagram-post { background-color: #E1306C; color: white; }
        .btn-instagram-post:hover { background-color: #c12c61; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #1EBE57; }
        .btn-copy { background-color: #6c757d; color: white; }
        .btn-copy:hover { background-color: #5a6268; }
        .btn-youtube-upload { background-color: #FF0000; color: white; } 
        .btn-youtube-upload:hover { background-color: #c40000; } 
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 450px; position: relative; }
        .modal-content.modal-lg { max-width: 800px; }
        @media (max-width: 768px) {
            .modal-content.modal-lg {
                max-height: 85vh;
                overflow-y: auto;
            }
        }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--text-color); }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; background: none; border: none; cursor: pointer; color: #888; }
        .modal-close-btn:hover { color: var(--text-color); }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions .btn-cancel { background-color: #6c757d; color: white; }
        .modal-actions .btn-cancel:hover { background-color: #5a6268; }
        .modal-actions .btn-confirm { background-color: #007bff; color: white; }
        .modal-actions .btn-confirm:hover { background-color: #0056b3; }
        #lista-palavras { margin-bottom: 15px; font-size: 14px; color: var(--text-color); padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; max-height: 100px; overflow-y: auto; }
        #customNumberInputContainer { display: none; margin-top: 10px; }
        .input-container-relative { position: relative; margin-bottom: 10px; }
        #linkFormLinkAnuncio { padding-right: 45px !important; margin-bottom: 0 !important; }
        .paste-btn { position: absolute; top: 50%; right: 5px; transform: translateY(-50%); padding: 4px 8px; height: 28px; font-size: 12px; z-index: 2; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .paste-btn:hover { background-color: #e0e0e0; }

        .loading-overlay-full { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); color: white; font-size: 20px; text-align: center; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
        .loading-overlay-full.active { display: flex; }

        #scrollTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000; background-color: #007bff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        #scrollTopBtn:hover { background-color: #0056b3; }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pagination-controls button {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .pagination-controls span {
            font-size: 1rem;
            font-weight: bold;
        }
        #itemsPerPageSelector {
            width: auto;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            border-radius: 0.25rem;
            cursor: pointer;
        }

        @media (max-width: 520px) {
            .pagination-container {
                flex-direction: column;
                gap: 20px;
            }
            #itemsPerPageSelector {
                order: -1; /* Move o seletor para cima */
                width: 100%;
                max-width: 200px;
                text-align: center;
            }
        }

        /* --- ESTILOS PARA TABELAS (WhatsApp e Contas) --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .filters-container {
            background-color: var(--card-bg-color);
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
        }
        .filters-container label {
            font-size: 0.8rem;
        }
        .filters-container input, .filters-container select {
            margin-bottom: 0;
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .data-table th {
            background-color: var(--bg-color);
            font-weight: 600;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background-color: var(--hover-bg-color);
        }
        .data-table td .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }
        .data-table td .action-buttons button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .data-table td a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        .data-table td a:hover {
            text-decoration: underline;
        }
        .data-table td .wpp-image-container {
            cursor: pointer;
        }
        .data-table td img.table-image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            cursor: pointer;
        }
        .data-table .validated-icon {
            color: #28a745;
            font-weight: bold;
        }
        
        /* Modal de Edição/Criação WhatsApp e Post Agendado */
        .edit-modal-body {
            display: flex;
            gap: 20px;
        }
        .edit-modal-form { flex: 2; }
        .edit-modal-form div { margin-bottom: 5px; }
        .edit-modal-form textarea { margin-bottom: 5px; }
        .edit-modal-preview { flex: 1; text-align: center; }
        .edit-modal-preview img, .edit-modal-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            object-fit: contain;
        }
        @media (max-width: 768px) { /* ATUALIZADO: Aplicado a 768px para melhor responsividade */
            .edit-modal-body { flex-direction: column; }
        }

        /* Estilos responsivos para a tabela do WhatsApp */
        @media (max-width: 768px) {
            .list-item-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            .table-container {
                border: none;
                background-color: transparent;
            }
            .data-table thead {
                display: none;
            }
            .data-table, .data-table tbody, .data-table tr, .data-table td {
                display: block;
                width: 100%;
            }
            .data-table tr {
                margin-bottom: 20px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 15px;
                background-color: var(--card-bg-color);
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .data-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                border-bottom: 1px solid var(--hover-bg-color);
                padding: 10px 5px;
            }
            .data-table td:last-child {
                border-bottom: none;
            }
            .data-table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                padding-right: 15px;
            }
            .data-table td[data-label="Mensagem"], .data-table td[data-label="Webhook"] {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                text-align: left;
            }
             .data-table td[data-label="Mensagem"]::before, .data-table td[data-label="Webhook"]::before {
                margin-bottom: 5px;
            }
            .data-table td .action-buttons {
                width: 100%;
                justify-content: space-around;
                padding-top: 10px;
            }
        }

        /* Theme Toggle & Settings Dropdown */
        .settings-container {
            position: relative;
        }
        #settingsBtn {
            background: none;
            border: none;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1010;
            width: 250px;
            overflow: hidden;
        }
        .settings-dropdown.show {
            display: block;
        }
        .settings-dropdown button {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            border-radius: 0;
            border: none;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent;
        }
        .settings-dropdown button:hover {
            background-color: var(--hover-bg-color);
        }
        .settings-dropdown button:last-child {
            border-bottom: none;
        }
        #themeToggle {
            width: 50px;
            height: 26px;
            border-radius: 13px;
            background-color: var(--hover-bg-color);
            position: relative;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        #themeToggle .toggle-circle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        body.dark-theme #themeToggle .toggle-circle {
            transform: translateX(24px);
        }

        /* Estilos para preview de multiplas imagens */
        #media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            min-height: 80px;
        }
        .media-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .media-preview-item img, .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        .remove-media-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* --- ESTILOS DO DASHBOARD --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--active-menu-text);
        }
        .stat-card .label {
            font-size: 1rem;
            color: var(--text-color);
            margin-top: 5px;
        }

    </style>
</head>

<body>
    <div id="login-container" class="auth-container">
        <div id="login-box" class="auth-box">
            <h2>Login</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="email">E-mail</label>
                    <input type="text" id="email" required>
                </div>
                <div class="input-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Entrar</button>
                <p id="login-error"></p>
                 <p class="auth-switch">Não tem uma conta? <a href="#" id="show-register">Cadastre sua empresa</a></p>
            </form>
        </div>
    </div>

    <div id="register-container" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2>Cadastro de Empresa</h2>
            <form id="register-form">
                <div class="input-group">
                    <label for="reg-name">Nome Completo</label>
                    <input type="text" id="reg-name" required>
                </div>
                <div class="input-group">
                    <label for="reg-email">E-mail</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div class="input-group">
                    <label for="reg-whatsapp">WhatsApp</label>
                    <input type="tel" id="reg-whatsapp" required>
                </div>
                 <div class="input-group">
                    <label for="reg-cnpj-cpf">CNPJ/CPF</label>
                    <input type="text" id="reg-cnpj-cpf" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Cadastrar</button>
                <p id="register-error"></p>
                <p class="auth-switch">Já tem uma conta? <a href="#" id="show-login">Faça login</a></p>
            </form>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <header class="app-header">
            <div class="header-left">
                <button id="menuToggleBtn" class="menu-toggle-btn" title="Alternar menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"></path></svg>
                </button>
                <a href="#/dashboard"><h1>Gerenciador de Posts</h1></a>
            </div>
            <div class="header-right">
                <button id="themeToggle" title="Alterar Tema"><div class="toggle-circle"></div></button>
            </div>
        </header>
        <div class="app-body">
            <aside id="sidebar" class="sidebar">
            </aside>
            <main class="main-content">
                <div id="dashboardContentArea"></div>
                <div id="contentDisplayArea"></div>
                <div id="socialAccountsContentArea"></div>
                <div id="whatsappGroupsContentArea"></div>
                <div id="companiesContentArea"></div>
                <div id="usersContentArea"></div>
                <div id="paginationContainer" class="pagination-container"></div>
            </main>
        </div>
    </div>

    <div id="modalEditCompany" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditCompany">&times;</button>
            <h3>Editar Dados da Empresa</h3>
            <form id="formEditCompany">
                <input type="hidden" id="editCompanyId">
                <div>
                    <label for="editCompanyName">Nome da Empresa:</label>
                    <input type="text" id="editCompanyName" required>
                </div>
                <div>
                    <label for="editCompanyEmail">E-mail:</label>
                    <input type="email" id="editCompanyEmail" required>
                </div>
                <div>
                    <label for="editCompanyWhatsapp">WhatsApp:</label>
                    <input type="tel" id="editCompanyWhatsapp">
                </div>
                <div>
                    <label for="editCompanyCnpjCpf">CNPJ/CPF:</label>
                    <input type="text" id="editCompanyCnpjCpf">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditCompany">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Dados</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditCompanyModules" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditCompanyModules">&times;</button>
            <h3>Gerenciar Módulos da Empresa</h3>
            <form id="formEditCompanyModules">
                <input type="hidden" id="editCompanyModulesId">
                <p>Empresa: <strong id="editCompanyModulesName"></strong></p>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <label>
                        <input type="checkbox" id="moduleInstagram" style="width:auto; margin-right:5px;"> Instagram
                    </label>
                    <label>
                        <input type="checkbox" id="moduleFacebook" style="width:auto; margin-right:5px;"> Facebook
                    </label>
                    <label>
                        <input type="checkbox" id="moduleThreads" style="width:auto; margin-right:5px;"> Threads
                    </label>
                    <label>
                        <input type="checkbox" id="moduleWhatsapp" style="width:auto; margin-right:5px;"> WhatsApp
                    </label>
                    </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditCompanyModules">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Módulos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals de Contas Sociais -->
    <div id="modalCreateSocialAccount" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalCreateSocialAccount">&times;</button>
            <h3>Criar Nova Conta Social</h3>
            <form id="formCreateSocialAccount">
                <div>
                    <label for="accountType">Rede Social:</label>
                    <select id="accountType" required>
                        <option value="Instagram" selected>Instagram</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Threads">Threads</option>
                    </select>
                </div>
                <div>
                    <label for="accountName">Nome da Conta (para exibição):</label>
                    <input type="text" id="accountName" placeholder="Ex: Carla Indica" required>
                </div>
                <div>
                    <label for="accountOrder">Ordenação (Ex: 1, 2, 3...):</label>
                    <input type="number" id="accountOrder" placeholder="Define a ordem no menu">
                </div>
                <div>
                    <label for="accountToken">Token:</label>
                    <input type="text" id="accountToken" required>
                </div>
                <div>
                    <label for="accountWebhook">Webhook:</label>
                    <input type="text" id="accountWebhook">
                </div>
                <div style="margin-top: 15px;">
                    <input type="checkbox" id="accountValidated" style="width:auto; margin-right:5px;">
                    <label for="accountValidated" style="font-weight:normal; display:inline;">Integração Validada</label>
                </div>
                <button type="button" id="btnOpenFbDev" class="btn-link" style="width: 100%; margin-top: 15px;">Abrir Facebook Developers</button>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCreateSocialAccount">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Conta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditSocialAccount" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditSocialAccount">&times;</button>
            <h3>Editar Conta Social</h3>
            <form id="formEditSocialAccount">
                <input type="hidden" id="editAccountId">
                <div>
                    <label for="editAccountType">Rede Social:</label>
                    <select id="editAccountType" required>
                        <option value="Instagram">Instagram</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Threads">Threads</option>
                    </select>
                </div>
                <div>
                    <label for="editAccountName">Nome da Conta (para exibição):</label>
                    <input type="text" id="editAccountName" placeholder="Ex: Carla Indica" required>
                </div>
                <div>
                    <label for="editAccountOrder">Ordenação (Ex: 1, 2, 3...):</label>
                    <input type="number" id="editAccountOrder" placeholder="Define a ordem no menu">
                </div>
                <div>
                    <label for="editAccountToken">Token:</label>
                    <input type="text" id="editAccountToken" required>
                </div>
                <div>
                    <label for="editAccountWebhook">Webhook:</label>
                    <input type="text" id="editAccountWebhook">
                </div>
                <div style="margin-top: 15px;">
                    <input type="checkbox" id="editAccountValidated" style="width:auto; margin-right:5px;">
                    <label for="editAccountValidated" style="font-weight:normal; display:inline;">Integração Validada</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditSocialAccount">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modals de Links -->
    <div id="modalAddLinks" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalAddLinks">&times;</button>
            <h3>Incluir Links</h3>
            <div id="existingLinksListContainer" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h4>Links Existentes para esta Postagem:</h4>
                <div id="existingLinksList" style="max-height: 180px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #fcfcfc;">
                    <p>Carregando links...</p>
                </div>
            </div>
            <form id="formAddLinks">
                <input type="hidden" id="linkFormPostId">
                <div>
                    <label for="linkFormLinkAnuncio">Link do Anúncio:</label>
                    <div class="input-container-relative">
                        <input type="text" id="linkFormLinkAnuncio" required>
                        <button type="button" id="btnPasteLink" class="paste-btn" title="Colar da área de transferência">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1-1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 8 7z"/>
                                <path d="M6.5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="linkFormLoja">Loja:</label>
                    <select id="linkFormLoja" required>
                        <option value="" disabled selected>Selecione uma loja</option>
                        <option value="Shopee">Shopee</option>
                        <option value="Mercado Livre">Mercado Livre</option>
                        <option value="Amazon">Amazon</option>
                    </select>
                </div>
                <div>
                    <label for="linkFormCategoria">Categoria:</label>
                    <input type="text" id="linkFormCategoria">
                </div>
                <div>
                    <label for="linkFormImagem">Imagem do Anúncio (Opcional):</label>
                    <input type="file" id="linkFormImagem" accept="image/*">
                </div>
                <fieldset style="margin-top: 15px; border: 1px solid #eee; padding:10px;">
                    <legend style="font-size:0.9rem; padding:0 5px; width:auto;">Tipo:</legend>
                    <label style="display:inline-block; margin-right:15px; font-weight:normal;"><input type="radio" name="linkFormTipo" value="post" checked> Post</label>
                    <label style="display:inline-block; margin-right:15px; font-weight:normal;"><input type="radio" name="linkFormTipo" value="story"> Story</label>
                    <label style="display:inline-block; font-weight:normal;"><input type="radio" name="linkFormTipo" value="reels"> Reels</label>
                </fieldset>
                <div class="modal-actions">
                    <div style="margin-top: 20px; text-align: center; width:100%; display:flex; justify-content:space-around">
                        <button type="button" id="btnOpenCopyLinkByIdModal" class="btn-copy">Copiar Link por ID</button>
                        <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalAddLinks">Cancelar</button>
                        <button type="submit" class="btn-confirm">Salvar Links</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals Diversos -->
    <div id="modalPalavraComentario" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalPalavraComentario">&times;</button>
            <h3>Nova Palavra para Comentário</h3>
            <div id="lista-palavras-container">
                <strong>Palavras salvas:</strong>
                <div id="lista-palavras">Carregando...</div>
            </div>
            <div>
                <label for="inputNovaPalavra">Digite a nova palavra:</label>
                <input type="text" id="inputNovaPalavra" placeholder="Ex: EU QUERO" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalPalavraComentario">Cancelar</button>
                <button type="button" id="btnSalvarNovaPalavra" class="btn-confirm">Salvar Palavra</button>
            </div>
        </div>
    </div>
    <div id="modalEnviarWhatsApp" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEnviarWhatsApp">&times;</button>
            <h3>Enviar vídeo para WhatsApp</h3>
            <input type="hidden" id="whatsPostId">
            <input type="hidden" id="whatsVideoUrl">
            <div class="whats-options" style="display:flex; flex-direction:column; gap:10px;">
                <button data-number="5511989200952" class="btn-send-direct-whats">Robson</button>
                <button data-number="5511967409954" class="btn-send-direct-whats">Lady</button>
                <button id="btnShowCustomNumberWhats">Outro Número</button>
                <button id="btnCopyVideoLinkWhats">Copiar Link do Vídeo</button>
            </div>
            <div id="customNumberInputContainer">
                <label for="inputCustomNumberWhats">Digite outro número (Ex: 55119...):</label>
                <input type="tel" id="inputCustomNumberWhats" placeholder="55119XXXXXXXX">
                <button id="btnSendCustomNumberWhats" class="btn-confirm" style="width:100%; margin-top:10px;">Enviar</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEnviarWhatsApp">Fechar</button>
            </div>
        </div>
    </div>
    <div id="modalCopyLinkById" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalCopyLinkById">&times;</button>
            <h3>Copiar Link por ID</h3>
            <form id="formCopyLinkById">
                <input type="hidden" id="copyLinkFormPostId">
                <div>
                    <label for="inputCopyLinkId">ID do Link a Copiar:</label>
                    <input type="text" id="inputCopyLinkId" placeholder="Ex: 123" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCopyLinkById">Cancelar</button>
                    <button type="submit" class="btn-confirm">Copiar Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals de Ofertas WhatsApp -->
    <div id="modalEditWhatsapp" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalEditWhatsapp">&times;</button>
            <h3>Editar Oferta WhatsApp</h3>
            <form id="formEditWhatsapp">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <input type="hidden" id="editWppId">
                        <div>
                            <label for="editWppLoja">Loja:</label>
                            <select id="editWppLoja" required>
                                <option value="Shopee">Shopee</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Amazon">Amazon</option>
                            </select>
                        </div>
                        <div>
                            <label for="editWppGrupo">Grupo:</label>
                            <select id="editWppGrupo" required>
                                <option value="">Selecione um grupo</option>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="editWppMessage">Mensagem:</label>
                            <textarea id="editWppMessage" rows="9" required></textarea>
                        </div>
                        <div>
                            <label for="editWppUrl">URL do Anúncio:</label>
                            <input type="url" id="editWppUrl" required>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label>Pré-visualização da Imagem</label>
                        <img id="editWppImagePreview" src="https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem" alt="Preview da Imagem">
                        <button type="button" id="btnOpenOriginalImage" class="btn-link" style="width:100%; margin-bottom: 10px; display:none;">Abrir Imagem Original</button>
                        <label for="editWppNewImage">Subir Nova Imagem:</label>
                        <input type="file" id="editWppNewImage" accept="image/*">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditWhatsapp">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modalCreateWhatsapp" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalCreateWhatsapp">&times;</button>
            <h3>Criar Nova Oferta</h3>
            <form id="formCreateWhatsapp">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <div>
                            <label for="createWppLoja">Loja:</label>
                             <select id="createWppLoja" required>
                                <option value="" disabled selected>Selecione uma loja</option>
                                <option value="Shopee">Shopee</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Amazon">Amazon</option>
                            </select>
                        </div>
                        <div>
                            <label for="createWppMessage">Mensagem:</label>
                            <textarea id="createWppMessage" rows="12" required></textarea>
                        </div>
                        <div>
                            <label for="createWppUrl">URL do Anúncio:</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="url" id="createWppUrl" required style="flex-grow: 1; margin-bottom: 0;">
                                <button type="button" id="btnGenerateAd" class="btn-primary" style="padding: 5px 10px; font-size: 0.8rem; flex-shrink: 0;">Gerar</button>
                                <button type="button" id="btnOpenAdUrl" class="btn-link" style="padding: 5px 10px; font-size: 0.8rem; flex-shrink: 0;">Abrir</button>
                            </div>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label>Pré-visualização da Imagem</label>
                        <img id="createWppImagePreview" src="https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem" alt="Preview da Imagem">
                        <label for="createWppNewImage">Subir Imagem:</label>
                        <input type="file" id="createWppNewImage" accept="image/*">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalCreateWhatsapp">Cancelar</button>
                    <button type="submit" class="btn-confirm">Criar Oferta</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modals de Grupos WhatsApp -->
    <div id="modalWhatsappGroup" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalWhatsappGroup">&times;</button>
            <h3 id="whatsappGroupModalTitle">Criar Novo Grupo</h3>
            <form id="formWhatsappGroup">
                <div>
                    <label for="whatsappGroupName">Nome do Grupo:</label>
                    <input type="text" id="whatsappGroupName" required>
                </div>
                <div>
                    <label for="whatsappGroupOrder">Ordenação:</label>
                    <input type="number" id="whatsappGroupOrder" placeholder="Define a ordem no menu">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalWhatsappGroup">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modalEditWhatsappGroup" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalEditWhatsappGroup">&times;</button>
            <h3>Editar Grupo</h3>
            <form id="formEditWhatsappGroup">
                <input type="hidden" id="editWhatsappGroupId">
                <div>
                    <label for="editWhatsappGroupName">Nome do Grupo:</label>
                    <input type="text" id="editWhatsappGroupName" required>
                </div>
                <div>
                    <label for="editWhatsappGroupOrder">Ordenação:</label>
                    <input type="number" id="editWhatsappGroupOrder" placeholder="Define a ordem no menu">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalEditWhatsappGroup">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal de Usuários -->
    <div id="modalUser" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalUser">&times;</button>
            <h3 id="userModalTitle">Criar Novo Login</h3>
            <form id="formUser">
                <input type="hidden" id="userId">
                <div>
                    <label for="userNameInput">Nome:</label>
                    <input type="text" id="userNameInput" required>
                </div>
                <div>
                    <label for="userEmail">E-mail:</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div id="userPasswordField">
                    <label for="userPassword">Senha:</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userIsActiveCheckbox" style="width:auto; margin-right:5px;"> Usuário Ativo
                    </label>
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userAdminCheckbox" style="width:auto; margin-right:5px;"> Administrador
                    </label>
                    <label style="font-weight:normal;">
                        <input type="checkbox" id="userDarkThemeCheckbox" style="width:auto; margin-right:5px;"> Tema Escuro
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalUser">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modals de Post Agendado -->
    <div id="modalScheduledPost" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn" data-modal-id="modalScheduledPost">&times;</button>
            <h3 id="scheduledPostModalTitle">Criar Nova Postagem</h3>
            <form id="formScheduledPost">
                <input type="hidden" id="scheduledPostId">
                <div class="edit-modal-body">
                    <div class="edit-modal-form">
                        <div>
                            <label for="scheduledPostDescription">Descrição:</label>
                            <textarea id="scheduledPostDescription" rows="9" required></textarea>
                        </div>
                        <div>
                            <label for="scheduledPostDateTime">Horário da Postagem:</label>
                            <input type="datetime-local" id="scheduledPostDateTime" step="300" required>
                        </div>
                    </div>
                    <div class="edit-modal-preview">
                        <label for="scheduledPostMedia">Imagens/Vídeos:</label>
                        <input type="file" id="scheduledPostMedia" accept="image/*,video/*" multiple>
                        <div id="media-preview-container">
                            <!-- Previews das mídias aparecerão aqui -->
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel modal-close-btn-alternative" data-modal-id="modalScheduledPost">Cancelar</button>
                    <button type="submit" class="btn-confirm">Salvar Postagem</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals de Confirmação e Alerta -->
    <div id="modalAlert" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="modalAlert">&times;</button>
            <h3 id="modalAlertTitle">Aviso</h3>
            <p id="modalAlertMessage" style="margin-top: 15px;"></p>
            <div class="modal-actions">
                <button id="modalAlertOk" class="btn-confirm modal-close-btn-alternative" data-modal-id="modalAlert">OK</button>
            </div>
        </div>
    </div>
    <div id="modalConfirm" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalConfirmTitle">Confirmação</h3>
            <p id="modalConfirmMessage" style="margin-top: 15px;"></p>
            <div class="modal-actions">
                <button id="modalConfirmCancel" class="btn-cancel">Cancelar</button>
                <button id="modalConfirmOk" class="btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Overlay de Loading -->
    <div id="loadingOverlayFull" class="loading-overlay-full">
        <svg width="50" height="50" viewBox="0 0 50 50">
            <circle cx="25" cy="25" r="20" fill="none" stroke-width="5" stroke="#fff" stroke-linecap="round" transform="rotate(0 25 25)">
                <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                <animate attributeName="stroke-dasharray" values="1,200;89,200;89,200" dur="1.5s" repeatCount="indefinite" />
                <animate attributeName="stroke-dashoffset" values="0;-35;-124" dur="1.5s" repeatCount="indefinite" />
            </circle>
        </svg>
        <p id="loadingOverlayMessage" style="margin-top:15px;">Carregando...</p>
    </div>

    <button id="scrollTopBtn" title="Voltar ao topo">↑</button>

    <script>
        // --- Configuração e Estado Global ---
        const url_base = "https://webhook.storeprodigital.site/webhook";

        const API_URLS = {
            // Endpoints de Contas
            GET_ACCOUNTS: `${url_base}/social_media_accounts`,
            CREATE_ACCOUNT: `${url_base}/social_media_accounts`,
            UPDATE_ACCOUNT: `${url_base}/social_media_accounts`,
            DELETE_ACCOUNT: `${url_base}/social_media_accounts`,
            
            // Endpoints de Mídia
            SCHEDULED_POSTS: `/posts_scheduled`,
            SCHEDULED_POSTS_CRUD: `${url_base}/posts_scheduled`,
            REELS: `/get-all-reels-base-carla`,
            STORIES: `/get-all-stories-base-carla`,
            STORIES_BASE: `/get-all-storys-base-carla`,
            POSTS: `/get-all-pots-base-carla`,
            WHATSAPP: `/post-group-whatsapp`,

            // Endpoints de Grupos WhatsApp
            WHATSAPP_GROUPS_CRUD: `${url_base}/whatsapp_groups`,

            // Endpoints de Empresa e Usuários
            COMPANIES_CRUD: `${url_base}/companies`,
            COMPANIES_MODULES_CRUD: `${url_base}/companies_modules`,
            USERS_CRUD: `${url_base}/users`,
            
            // Dashboard
            GET_DASHBOARD_METRICS: `${url_base}/dashboard-metrics`,

            // Outros Endpoints
            LOGIN: `${url_base}/login`,
            LOGOUT: `${url_base}/logout`,
            WHATSAPP_ACTION: `${url_base}/post-group-whatsapp`,
            WHATSAPP_CREATE: `${url_base}/criar-post-group-whatsapp`,
            UPDATE_POST: `${url_base}/update-post`,
            REPOST_STORIES: `${url_base}/repost_story_media`,
            DELETE_REEL: `${url_base}/delete-reel`,
            DELETE_POST: `${url_base}/delete-post`,
            DELETE_STORIES: `${url_base}/delete-stories-base`,
            ADD_LINK: `${url_base}/add-links-postagens-unbox`,
            ADD_LINK_BASE64: `${url_base}/add-links-postagens-base64`,
            SEND_WHATS: `${url_base}/send-video-numero-whats-gerenciador`,
            UPLOAD_VIDEO: `${url_base}/add-upload-video-post`,
            POST_INSTAGRAM_MANUAL: `${url_base}/post_schedule_manual`,
            GET_COMMENT_KEY: `${url_base}/get-comment-key-post`,
            ADD_COMMENT_KEY: `${url_base}/add-comment-key-post`,
            FORCE_UPDATE_STORIES: `${url_base}/get_stories_all_instagram_carla`,
            FORCE_UPDATE_REELS: `${url_base}/get_reels_all_instagram_carla`,
            GET_LINKS_POSTAGENS: `${url_base}/get-links-postagens-carla`,
            COPY_LINK_BY_ID: `${url_base}/add-copy-links-postagens-carla`,
            GENERATE_AD_FROM_LINK: `${url_base}/generate-ad-from-link`,
        };

        const MEDIA_TYPES = [
            { key: 'scheduled-posts', label: 'Postar', endpoint: API_URLS.SCHEDULED_POSTS },
            { key: 'reels', label: 'Mídias Reels', endpoint: API_URLS.REELS },
            { key: 'stories', label: 'Mídias Stories', endpoint: API_URLS.STORIES },
            { key: 'posts', label: 'Postagens Base', endpoint: API_URLS.POSTS },
            { key: 'stories-base', label: 'Stories Base', endpoint: API_URLS.STORIES_BASE },
        ];
        
        let state = {
            authToken: null,
            companyId: null,
            socialAccounts: [],
            activeAccount: null, 
            activeMediaType: null, 
            items: [],
            filteredItems: [],
            totalItems: 0,
            isLoading: false,
            palavrasSalvasComentario: '',
            currentPage: 1,
            itemsPerPage: 10,
            whatsappLojas: [],
            whatsappGroups: [],
            companies: [],
            users: [],
            newImageBase64: null,
            scheduledPostFiles: [],
            currentUser: null,
        };

        // --- Seletores de Elementos do DOM ---
        let loginContainer, registerContainer, appContainer, sidebar, contentDisplayArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea, paginationContainer, loadingOverlay, scrollTopBtn, dashboardContentArea;
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const existingLinksListDiv = document.getElementById('existingLinksList');
        const modalAddLinks = document.getElementById('modalAddLinks');
        const formAddLinks = document.getElementById('formAddLinks');
        const linkFormPostId = document.getElementById('linkFormPostId');
        const linkFormLinkAnuncio = document.getElementById('linkFormLinkAnuncio');
        const linkFormLoja = document.getElementById('linkFormLoja');
        const linkFormCategoria = document.getElementById('linkFormCategoria');
        const linkFormImagem = document.getElementById('linkFormImagem');
        const modalPalavraComentario = document.getElementById('modalPalavraComentario');
        const listaPalavrasDiv = document.getElementById('lista-palavras');
        const inputNovaPalavra = document.getElementById('inputNovaPalavra');
        const modalEnviarWhatsApp = document.getElementById('modalEnviarWhatsApp');
        const whatsPostIdInput = document.getElementById('whatsPostId');
        const whatsVideoUrlInput = document.getElementById('whatsVideoUrl');
        const customNumberInputContainer = document.getElementById('customNumberInputContainer');
        const inputCustomNumberWhats = document.getElementById('inputCustomNumberWhats');
        const btnOpenCopyLinkByIdModal = document.getElementById('btnOpenCopyLinkByIdModal');
        const modalCopyLinkById = document.getElementById('modalCopyLinkById');
        const formCopyLinkById = document.getElementById('formCopyLinkById');
        const copyLinkFormPostId = document.getElementById('copyLinkFormPostId');
        const inputCopyLinkId = document.getElementById('inputCopyLinkId');
        const modalEditWhatsapp = document.getElementById('modalEditWhatsapp');
        const formEditWhatsapp = document.getElementById('formEditWhatsapp');
        const modalCreateWhatsapp = document.getElementById('modalCreateWhatsapp');
        const formCreateWhatsapp = document.getElementById('formCreateWhatsapp');
        const modalCreateSocialAccount = document.getElementById('modalCreateSocialAccount');
        const formCreateSocialAccount = document.getElementById('formCreateSocialAccount');
        const modalEditSocialAccount = document.getElementById('modalEditSocialAccount');
        const formEditSocialAccount = document.getElementById('formEditSocialAccount');
        const modalScheduledPost = document.getElementById('modalScheduledPost');
        const formScheduledPost = document.getElementById('formScheduledPost');
        const modalWhatsappGroup = document.getElementById('modalWhatsappGroup');
        const formWhatsappGroup = document.getElementById('formWhatsappGroup');
        const modalEditWhatsappGroup = document.getElementById('modalEditWhatsappGroup');
        const formEditWhatsappGroup = document.getElementById('formEditWhatsappGroup');
        const modalUser = document.getElementById('modalUser');
        const formUser = document.getElementById('formUser');

        // --- Funções Utilitárias ---
        function showLoading(message = "Carregando...") {
            state.isLoading = true;
            if (loadingOverlay) {
                loadingOverlay.querySelector('#loadingOverlayMessage').textContent = message;
                loadingOverlay.classList.add('active');
            }
        }

        function hideLoading() {
            state.isLoading = false;
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        // --- ROTEAMENTO ---
        function navigateTo(path, params = [], query = {}) {
            const hashPath = `#/${path}${params.length > 0 ? '/' + params.map(p => encodeURIComponent(p)).join('/') : ''}`;
            const queryString = new URLSearchParams(query).toString();
            const newHash = queryString ? `${hashPath}?${queryString}` : hashPath;

            if (window.location.hash === newHash) {
                router();
                return;
            }

            window.location.hash = newHash;
        }

        async function router() {
            const [hash, queryString] = (window.location.hash || '#/dashboard').split('?');
            const pathParts = hash.slice(2).split('/').filter(p => p);
            const mainPath = pathParts[0] || 'dashboard';
            const params = pathParts.slice(1);
            const queryParams = new URLSearchParams(queryString || '');
            
            [dashboardContentArea, contentDisplayArea, socialAccountsContentArea, whatsappGroupsContentArea, companiesContentArea, usersContentArea].forEach(el => el.style.display = 'none');
            paginationContainer.style.display = 'none';

            state.currentPage = parseInt(queryParams.get('page') || '1', 10);

            switch (mainPath) {
                case 'dashboard':
                    await showDashboardPage();
                    break;
                case 'media':
                    const [account, type] = params;
                    await showMediaContent(decodeURIComponent(account || ''), type);
                    break;
                case 'settings':
                    const subpage = params[0];
                    switch (subpage) {
                        case 'companies': await showCompaniesPage(); break;
                        case 'users': await showUsersPage(); break;
                        case 'accounts': await showSocialAccountsPage(); break;
                        case 'whatsapp-groups': await showWhatsappGroupsPage(); break;
                        default: navigateTo('dashboard');
                    }
                    break;
                default:
                    navigateTo('dashboard');
            }
            renderSidebarMenu();
        }

        // --- Handlers de Ações Globais ---
        async function handleIncluirPalavra() {
            showLoading("Buscando palavras...");
            try {
                const res = await fetchWithAuth(API_URLS.GET_COMMENT_KEY);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                state.palavrasSalvasComentario = data.text || '';
                listaPalavrasDiv.innerHTML = data.text ? data.text.replace(/\n/g, '<br>') : "Nenhuma palavra salva.";
            } catch (error) {
                console.error("Erro:", error);
                listaPalavrasDiv.innerHTML = "<em>Erro ao carregar.</em>";
            } finally {
                hideLoading();
            }
            inputNovaPalavra.value = '';
            openModal(modalPalavraComentario);
        }

        function handleRecarregarStories() {
            if (!state.activeAccount || state.activeAccount === 'WhatsApp') {
                showAlert("Por favor, selecione uma conta do Instagram no menu lateral primeiro.");
                return;
            }
            showLoading("Atualizando Stories...");
            const updateEndpoint = `${API_URLS.FORCE_UPDATE_STORIES}?conta_user_instagram=${encodeURIComponent(state.activeAccount)}`;
            fetchWithAuth(updateEndpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na atualização forçada de Stories.');
                    showAlert("Atualização de Stories solicitada! A lista será atualizada em breve.");
                    setTimeout(fetchData, 5000);
                })
                .catch(err => showAlert(`Erro: ${err.message}`))
                .finally(hideLoading);
        }

        function handleRecarregarReels() {
            if (!state.activeAccount || state.activeAccount === 'WhatsApp') {
                showAlert("Por favor, selecione uma conta do Instagram no menu lateral primeiro.");
                return;
            }
            showLoading("Atualizando Reels...");
            const updateEndpoint = `${API_URLS.FORCE_UPDATE_REELS}?conta_user_instagram=${encodeURIComponent(state.activeAccount)}`;
            fetchWithAuth(updateEndpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Falha na atualização forçada de Reels.');
                    showAlert("Atualização de Reels solicitada! A lista será atualizada em breve.");
                    setTimeout(fetchData, 5000);
                })
                .catch(err => showAlert(`Erro: ${err.message}`))
                .finally(hideLoading);
        }


        // --- Funções de Renderização ---
        function renderSidebarMenu() {
            if (!sidebar) return;
            sidebar.innerHTML = '';
            const menuContainer = document.createElement('div');
            menuContainer.className = 'sidebar-menu';

            const currentUserCompany = state.companies.find(c => String(c.id) === String(state.companyId));
            const activeCompanyModules = currentUserCompany ? currentUserCompany.modules : {};

            const sortedAccounts = [...state.socialAccounts].sort((a, b) => (a.ordenacao ?? 999) - (b.ordenacao ?? 999));
            
            const groupedAccounts = sortedAccounts.reduce((acc, account) => {
                const media = account.social_media || 'Outros';
                if (!acc[media]) acc[media] = [];
                acc[media].push(account);
                return acc;
            }, {});

            const moduleMap = { Instagram: 'instagram', Facebook: 'facebook', Threads: 'threads' };

            for (const socialMedia in groupedAccounts) {
                const moduleKey = moduleMap[socialMedia];
                if (moduleKey && !activeCompanyModules[moduleKey]) continue;

                const accounts = groupedAccounts[socialMedia];
                const mediaGroup = document.createElement('div');
                mediaGroup.className = 'menu-group';
                const mediaParent = document.createElement('div');
                mediaParent.className = 'menu-parent';
                mediaParent.textContent = socialMedia;
                const mediaSubmenu = document.createElement('ul');

                const isMediaGroupActive = accounts.some(acc => acc.nome_conta === state.activeAccount);
                if (!isMediaGroupActive) {
                    mediaParent.classList.add('collapsed');
                    mediaSubmenu.classList.add('collapsed');
                }

                mediaParent.addEventListener('click', () => {
                    mediaParent.classList.toggle('collapsed');
                    mediaSubmenu.classList.toggle('collapsed');
                });

                mediaGroup.appendChild(mediaParent);
                mediaGroup.appendChild(mediaSubmenu);

                accounts.forEach(account => {
                    const accountParent = document.createElement('div');
                    accountParent.className = 'menu-parent submenu-item';
                    accountParent.textContent = account.nome_conta;
                    accountParent.style.paddingLeft = '15px';
                    const accountSubmenu = document.createElement('ul');

                    if (state.activeAccount !== account.nome_conta) {
                        accountParent.classList.add('collapsed');
                        accountSubmenu.classList.add('collapsed');
                    }

                    accountParent.addEventListener('click', (e) => {
                        e.stopPropagation();
                        accountParent.classList.toggle('collapsed');
                        accountSubmenu.classList.toggle('collapsed');
                    });

                    MEDIA_TYPES.forEach(mediaType => {
                        const li = document.createElement('li');
                        li.className = 'submenu-item';
                        li.textContent = mediaType.label;
                        if (state.activeAccount === account.nome_conta && state.activeMediaType === mediaType.key) {
                            li.classList.add('active');
                        }
                        li.addEventListener('click', (e) => {
                            e.stopPropagation();
                            navigateTo('media', [account.nome_conta, mediaType.key]);
                            if (window.innerWidth <= 992) {
                                document.body.classList.add('sidebar-collapsed');
                            }
                        });
                        accountSubmenu.appendChild(li);
                    });
                    mediaSubmenu.appendChild(accountParent);
                    mediaSubmenu.appendChild(accountSubmenu);
                });
                menuContainer.appendChild(mediaGroup);
            }

            if (activeCompanyModules.whatsapp) {
                const whatsappGroup = document.createElement('div');
                whatsappGroup.className = 'menu-group';
                const whatsappParent = document.createElement('div');
                whatsappParent.className = 'menu-parent';
                whatsappParent.textContent = 'WhatsApp';
                const whatsappSubmenu = document.createElement('ul');
                
                const isWhatsappActive = state.activeAccount === 'WhatsApp';
                if (!isWhatsappActive) {
                    whatsappParent.classList.add('collapsed');
                    whatsappSubmenu.classList.add('collapsed');
                }

                whatsappParent.addEventListener('click', () => {
                    whatsappParent.classList.toggle('collapsed');
                    whatsappSubmenu.classList.toggle('collapsed');
                });

                whatsappGroup.appendChild(whatsappParent);
                whatsappGroup.appendChild(whatsappSubmenu);

                const sortedGroups = [...state.whatsappGroups].sort((a, b) => (a.ordenacao || 999) - (b.ordenacao || 999));

                sortedGroups.forEach(group => {
                    const li = document.createElement('li');
                    li.className = 'submenu-item';
                    li.textContent = `Ofertas - ${group.group_name}`;
                    if (state.activeAccount === 'WhatsApp' && state.activeMediaType === group.group_name) {
                        li.classList.add('active');
                    }
                    li.addEventListener('click', (e) => {
                        e.stopPropagation();
                        navigateTo('media', ['WhatsApp', group.group_name]);
                         if (window.innerWidth <= 992) {
                            document.body.classList.add('sidebar-collapsed');
                        }
                    });
                    whatsappSubmenu.appendChild(li);
                });
                menuContainer.appendChild(whatsappGroup);
            }

            const configGroup = document.createElement('div');
            configGroup.className = 'menu-group';
            const configParent = document.createElement('div');
            configParent.className = 'menu-parent';
            configParent.textContent = 'Configurações';
            const configSubmenu = document.createElement('ul');
            
            const currentHash = window.location.hash;
            const isConfigActive = currentHash.includes('#/settings');
            
            if (!isConfigActive) {
                configParent.classList.add('collapsed');
                configSubmenu.classList.add('collapsed');
            }

            configParent.addEventListener('click', () => {
                configParent.classList.toggle('collapsed');
                configSubmenu.classList.toggle('collapsed');
            });
            
            configSubmenu.innerHTML = `
                <li class="submenu-item ${currentHash.includes('companies') ? 'active' : ''}" onclick="navigateTo('settings', ['companies'])">Empresas</li>
                <li class="submenu-item ${currentHash.includes('users') ? 'active' : ''}" onclick="navigateTo('settings', ['users'])">Usuários</li>
                <li class="submenu-item ${currentHash.includes('accounts') ? 'active' : ''}" onclick="navigateTo('settings', ['accounts'])">Redes Sociais</li>
                <li class="submenu-item ${currentHash.includes('whatsapp-groups') ? 'active' : ''}" onclick="navigateTo('settings', ['whatsapp-groups'])">Grupos WhatsApp</li>
                <li class="submenu-item" id="menu-keyword">Palavra Chave</li>
                <li class="submenu-item" id="menu-logout">Logout</li>
            `;

            configSubmenu.querySelector('#menu-keyword').addEventListener('click', handleIncluirPalavra);
            configSubmenu.querySelector('#menu-logout').addEventListener('click', handleLogout);

            configGroup.appendChild(configParent);
            configGroup.appendChild(configSubmenu);
            menuContainer.appendChild(configGroup);
            
            const actionsGroup = document.createElement('div');
            actionsGroup.className = 'menu-group sidebar-actions';
            const actionsParent = document.createElement('div');
            actionsParent.className = 'menu-parent collapsed';
            actionsParent.textContent = 'Ações Rápidas';
            const actionsSubmenu = document.createElement('ul');
            actionsSubmenu.className = 'submenu collapsed';
            actionsSubmenu.innerHTML = `
                <li class="submenu-item" id="sidebar-action-reload-stories">🔄 Recarregar Mídias Stories</li>
                <li class="submenu-item" id="sidebar-action-reload-reels">🔄 Recarregar Mídias Reels</li>
                <li class="submenu-item" id="sidebar-action-reload-posts">🔄 Recarregar Posts Base</li>
            `;
            
            actionsParent.addEventListener('click', () => {
                actionsParent.classList.toggle('collapsed');
                actionsSubmenu.classList.toggle('collapsed');
            });

            actionsGroup.appendChild(actionsParent);
            actionsGroup.appendChild(actionsSubmenu);
            menuContainer.appendChild(actionsGroup);

            sidebar.appendChild(menuContainer);
        }

        function renderItems() {
            if (!contentDisplayArea) return;
            contentDisplayArea.className = ''; // Reset class
            
            if (state.activeAccount === 'WhatsApp') {
                renderWhatsappContent();
            } else if (state.activeMediaType === 'scheduled-posts') {
                renderScheduledPostsPage();
            } else {
                renderCardContent();
            }
        }

        function renderCardContent() {
             if (state.items.length === 0 && !state.isLoading) {
                 contentDisplayArea.innerHTML = '<p>Nenhum item encontrado para esta visualização.</p>';
                 return;
             }
             
             contentDisplayArea.innerHTML = '';
             const gridContainer = document.createElement('div');
             gridContainer.className = 'grid-container';
             
             state.items.forEach(item => {
                 let card;
                 if (state.activeMediaType === 'reels') card = createReelCard(item);
                 else if (state.activeMediaType === 'posts') card = createPostCard(item);
                 else if (state.activeMediaType === 'stories') card = createStoryCard(item);
                 else if (state.activeMediaType === 'stories-base') card = createStoryBaseCard(item);
                 if (card) gridContainer.appendChild(card);
             });
             contentDisplayArea.appendChild(gridContainer);
        }

        function renderScheduledPostsPage() {
            const displayDiv = document.getElementById('contentDisplayArea');
            displayDiv.innerHTML = ''; // Limpa

            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Posts Agendados</h2>`;

            const createBtn = document.createElement('button');
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Postagem';
            createBtn.addEventListener('click', () => handleOpenScheduledPostModal()); // Abre modal sem dados
            headerDiv.appendChild(createBtn);
            displayDiv.appendChild(headerDiv);

            if (state.items.length === 0 && !state.isLoading) {
                displayDiv.innerHTML += '<p>Nenhum item agendado para postar.</p>';
                return;
            }

            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-container';

            state.items.forEach(item => {
                if (item && item.id) { // VERIFICAÇÃO ADICIONADA
                    const card = createScheduledPostCard(item);
                    if (card) gridContainer.appendChild(card);
                }
            });
            displayDiv.appendChild(gridContainer);
        }


        function renderPaginationControls() {
            if (!paginationContainer) return;
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
            if (totalPages <= 1) return;

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'pagination-controls';

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = state.currentPage === 1;
            prevButton.addEventListener('click', () => changePage(state.currentPage - 1));

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${state.currentPage} de ${totalPages || 1}`;

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Próxima';
            nextButton.disabled = state.currentPage === totalPages || totalPages === 0;
            nextButton.addEventListener('click', () => changePage(state.currentPage + 1));

            controlsDiv.appendChild(prevButton);
            controlsDiv.appendChild(pageInfo);
            controlsDiv.appendChild(nextButton);

            const itemsPerPageSelect = document.createElement('select');
            itemsPerPageSelect.id = 'itemsPerPageSelector';
            [10, 50, 100].forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `${num} por página`;
                if (num === state.itemsPerPage) {
                    option.selected = true;
                }
                itemsPerPageSelect.appendChild(option);
            });
            itemsPerPageSelect.addEventListener('change', (event) => {
                state.itemsPerPage = parseInt(event.target.value, 10);
                changePage(1);
            });

            paginationContainer.appendChild(itemsPerPageSelect);
            paginationContainer.appendChild(controlsDiv);
        }
        
        function createSmartMediaElement(item) {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'media-content';
            const placeholder = 'https://placehold.co/400x640/cccccc/ffffff?text=Indisponível';

            // Lógica para posts agendados que podem ter múltiplas mídias
            if (item.media_urls && Array.isArray(item.media_urls) && item.media_urls.length > 0) {
                const firstMediaUrl = item.media_urls[0];
                if (firstMediaUrl.toLowerCase().includes('.mp4') || firstMediaUrl.toLowerCase().includes('.mov')) {
                     mediaContainer.innerHTML = `<video src="${firstMediaUrl}" controls></video>`;
                } else {
                     mediaContainer.innerHTML = `<img src="${firstMediaUrl}" alt="Mídia do post">`;
                }
                return mediaContainer;
            }

            if (item.media_type === 'IMAGE' || item.media_type === 'CAROUSEL_ALBUM') {
                const primaryImg = item.story_thumbnail || item.media_url;
                 if (primaryImg) {
                     mediaContainer.innerHTML = `<img src="${primaryImg}" onerror="this.onerror=null; this.src='${placeholder}';" alt="Mídia do post">`;
                } else {
                     mediaContainer.innerHTML = `<span>Imagem indisponível</span>`;
                }
            } 
            else if (item.media_type === 'VIDEO') {
                const videoUrl = item.media_url || item.s3_url_video;
                const thumbUrl = item.thumbnail_url || item.story_thumbnail;

                if (videoUrl) {
                    if (thumbUrl) {
                        mediaContainer.innerHTML = `
                            <img src="${thumbUrl}" onerror="this.onerror=null; this.src='${placeholder}';" alt="Thumbnail do vídeo">
                            <div class="play-button-overlay" data-video-url="${videoUrl}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                            </div>
                        `;
                        const playOverlay = mediaContainer.querySelector('.play-button-overlay');
                        playOverlay.addEventListener('click', (e) => {
                            e.stopPropagation();
                            mediaContainer.innerHTML = `<video src="${videoUrl}" controls autoplay></video>`;
                        });
                    } else {
                        mediaContainer.innerHTML = `<video src="${videoUrl}" controls></video>`;
                    }
                } else {
                    mediaContainer.innerHTML = '<span>URL do vídeo indisponível</span>';
                }
            }
            else {
                 const singleUrl = item.s3_url_video || item.media_url;
                  if(singleUrl){
                       if (singleUrl.toLowerCase().includes('.mp4') || singleUrl.toLowerCase().includes('.mov') || singleUrl.toLowerCase().includes('video')) {
                            mediaContainer.innerHTML = `<video src="${singleUrl}" controls></video>`;
                       } else {
                            mediaContainer.innerHTML = `<img src="${singleUrl}" alt="Mídia do post">`;
                       }
                  } else {
                     mediaContainer.innerHTML = '<span>Mídia indisponível</span>';
                  }
            }
            return mediaContainer;
        }


        function getPostDescription(post) {
            let descriptionNew = "";
            const ordenacao = post.ordenacao_postagem == null ? post.id : post.ordenacao_postagem;
            const comenta = post.palavra_comenta || state.palavrasSalvasComentario.split('\n')[0] || "QUERO";
            const contaUser = state.activeAccount; // Usa a conta ativa do estado

            // Mantém a lógica original, mas agora baseada na conta ativa
            if (contaUser && contaUser.toLowerCase().includes("baby")) {
                descriptionNew = `💛 Gostou comenta "${comenta}" para receber o LINK no direct 🔥\n\nAnúncio N.º: ${ordenacao}\nConfira sua aba de ‘solicitações’ no direct, pois a mensagem será enviada automaticamente.\n\n✨ Marque uma mamãe que vai adorar essa novidade!\n🚨 Stories disponíveis por 24 horas\n🎀Siga @carlababyofertas para não perder nenhuma oferta e novidade!\n#dicasmaternidade #maternidadereal #maternidade #amordemãe #maedemenino #maedemenina #brinquedosdebebe #brinquedosdidaticos #brincar #diversao #diversaoemfamília ${post.hashtags || ''}`;
            } else { // Default para "indica" ou qualquer outra conta
                descriptionNew = `💛 Gostou comenta "${comenta}" para LINK no direct 🔥\n\nAnúncio N.º: ${ordenacao}\nNos Stories de hoje 🔥\nNo Grupo de Ofertas-Link na Bio 🔥\nSiga @carlaindicaofertas para mais achadinhos como esse!\n#utilidades #maquiagem #feminina #feminino #mulher #importado #roupa #girl #chique ${post.hashtags || ''}`;
            }
            return descriptionNew;
        }

        function formatMediaDateTime(dateTimeString) {
            if (!dateTimeString) return 'Data indisponível';
            try {
                const date = new Date(dateTimeString);
                if (isNaN(date)) return "Data inválida";
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) { return "Data inválida"; }
        }

        function createReelCard(reel) {
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(reel.media_created_at);
            const mediaElement = createSmartMediaElement(reel);

            card.appendChild(mediaElement);
            
            const formDiv = document.createElement('div');
            formDiv.innerHTML = `
                <label>ID: ${reel.id}</label>
                <div class="list-item-stats">
                    <p><strong>👁️ Views:</strong> ${reel.views || 0}</p>
                    <p><strong>❤️ Likes:</strong> ${reel.likes || 0}</p>
                    <p><strong>💬 Coment.:</strong> ${reel.comments || 0}</p>
                    <p><strong>🎯 Alcance:</strong> ${reel.reach || 0}</p>
                    <p><strong>💾 Salvos:</strong> ${reel.saved || 0}</p>
                    <p><strong>↪️ Compart.:</strong> ${reel.shares || 0}</p>
                </div>
                <label for="caption-${reel.id}">Descrição: <span style="font-weight:normal; font-size:0.8em;">(${formattedDateTime})</span></label>
                <textarea id="caption-${reel.id}">${reel.caption || ''}</textarea>
                <div class="card-buttons">
                    <button class="btn-save" data-id="${reel.id}" data-type="${reel.media_product_type || 'REELS'}">Salvar Edição Reel</button>
                    <button class="btn-whatsapp" data-id="${reel.id}" data-video-url="${reel.media_url || ''}">Enviar p/ WhatsApp</button>
                    <button class="btn-copy" data-url="${reel.media_url || ''}">Copiar Link da Mídia</button>
                    <button class="btn-link" data-id="${reel.id}" data-type="reels">Incluir Links</button>
                    ${reel.permalink ? `<button onclick="window.open('${reel.permalink}', '_blank')">Ver Reel no Instagram</button>` : ''}
                    <button class="btn-delete btn-delete-reel" data-id="${reel.id}">Deletar Reel</button>
                </div>
            `;
            card.appendChild(formDiv);

            card.querySelector('.btn-save').addEventListener('click', handleSalvarEdicaoReel);
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal);
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink);
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-delete-reel').addEventListener('click', handleDeleteReel);
            return card;
        }

        function createPostCard(post) { 
            const card = document.createElement('div'); 
            card.className = 'card'; 
            const descriptionNew = getPostDescription(post); 
            const ordenacaoParaExibir = post.ordenacao_postagem == null ? post.id : post.ordenacao_postagem; 
            const mediaElement = createSmartMediaElement(post);
            
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = ` 
                <label>ID: ${post.id}</label> 
                <label for="desc-${post.id}">Descrição:</label> 
                <textarea id="desc-${post.id}">${descriptionNew}</textarea> 
                <label for="ord-${post.id}">Ordenação:</label> 
                <input type="number" id="ord-${post.id}" value="${ordenacaoParaExibir}"> 
                <label for="cat-${post.id}">Categoria:</label> 
                <input type="text" id="cat-${post.id}" value="${post.categoria || ''}"> 
                <div> 
                    <input type="checkbox" id="rev-${post.id}" ${post.check_reviewed ? 'checked' : ''} style="width:auto; margin-right:5px;">
                    <label for="rev-${post.id}" style="font-weight:normal; display:inline;">Revisado</label> 
                </div> 
                <div class="card-buttons"> 
                    <button class="btn-save" data-id="${post.id}">Salvar Edição</button> 
                    <label for="upload-${post.id}" style="margin-top:5px; margin-bottom:0; font-size:0.8rem;">Trocar Vídeo:</label> 
                    <input type="file" id="upload-${post.id}" accept=".mov,.mp4,video/quicktime" data-id="${post.id}" style="padding:5px; font-size:0.85rem;">
                    <button class="btn-whatsapp" data-id="${post.id}" data-video-url="${post.s3_url_video || ''}">Enviar p/ WhatsApp</button> 
                    <button class="btn-link" data-id="${post.id}" data-type="post">Incluir Links</button> 
                    <button class="btn-instagram-post" data-id="${post.id}" ${!post.check_reviewed ? 'disabled' : ''}>Postar este no Instagram</button> 
                    ${post.conta_clone_url_reels ? `<button onclick="window.open('${post.conta_clone_url_reels}', '_blank')">Ver no Instagram Clone</button>` : ''} 
                    <button class="btn-delete" data-id="${post.id}">Excluir Item</button> 
                </div>`; 
            card.appendChild(contentDiv);
            card.querySelector('.btn-save').addEventListener('click', handleSalvarEdicaoPost); 
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirPost); 
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal); 
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal); 
            card.querySelector('.btn-instagram-post').addEventListener('click', handlePostarUnicoInstagram); 
            card.querySelector('input[type="file"]').addEventListener('change', handleUploadVideo); 
            return card; 
        } 

        function createScheduledPostCard(post) {
            if (!post || !post.id) return null; // Validação para evitar cards vazios

            const card = document.createElement('div');
            card.className = 'card';
            const mediaElement = createSmartMediaElement(post);

            card.appendChild(mediaElement);
            
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <label>ID: ${post.id || 'N/A'}</label>
                <label>Descrição:</label>
                <textarea readonly>${post.description || 'Sem descrição'}</textarea>
                <p><strong>Agendado para:</strong> ${formatMediaDateTime(post.schedule_time) || 'N/A'}</p>
                <div class="card-buttons">
                    <button class="btn-edit-scheduled-post" data-id="${post.id}">Editar</button>
                    <button class="btn-link" data-id="${post.id}" data-type="reels">Incluir Links</button>
                    <button class="btn-instagram-post" data-id="${post.id}">Postar Agora</button>
                    <button class="btn-delete" data-id="${post.id}" data-media_url="${post.media_url || ''}">Excluir</button>
                </div>`;
            
            card.appendChild(infoDiv);

            card.querySelector('.btn-edit-scheduled-post').addEventListener('click', () => handleOpenScheduledPostModal(post));
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            card.querySelector('.btn-instagram-post').addEventListener('click', handlePostarUnicoInstagram);
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirPost);
            return card;
        }
        
        function createStoryCard(story) { 
            const card = document.createElement('div');
            card.className = 'card';
            const formattedDateTime = formatMediaDateTime(story.media_created_at);
            const mediaElement = createSmartMediaElement(story);

            card.appendChild(mediaElement);

            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <label>ID: ${story.id}</label>
                <p style="font-size:0.8em; margin-top:-5px; margin-bottom:10px;">(${formattedDateTime})</p>
                <div class="card-buttons">
                    <button class="btn-save" data-id="${story.id}" data-type="${story.media_product_type || 'STORIES'}" data-conta="${story.conta_user_instagram}">Repostar Story</button>
                    <button class="btn-copy" data-url="${story.media_url || ''}">Copiar Link da Mídia</button>
                    <button class="btn-link" data-id="${story.id}" data-type="story">Incluir Links</button>
                    ${story.permalink ? `<button onclick="window.open('${story.permalink}', '_blank')">Ver Story no Instagram</button>` : ''}
                </div>
            `;
            card.appendChild(infoDiv);

            card.querySelector('.btn-save').addEventListener('click', handleRepostStory);
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink);
            card.querySelector('.btn-link').addEventListener('click', handleOpenLinkModal);
            return card;
        } 
        
        function createStoryBaseCard(item) { 
            const card = document.createElement('div'); 
            card.className = 'card'; 
            const mediaElement = createSmartMediaElement(item);
            card.appendChild(mediaElement);

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = ` 
                <label>ID: ${item.id}</label> 
                <div class="card-buttons"> 
                    ${item.url_product ? `<button onclick="window.open('${item.url_product}', '_blank')">Abrir Anúncio</button>` : ''} 
                    <button class="btn-whatsapp" data-id="${item.id}" data-video-url="${item.url_s3_video || ''}">Enviar p/ WhatsApp</button> 
                    <button class="btn-copy" data-url="${item.url_s3_video || ''}">Copiar Link da Mídia</button> 
                    <button class="btn-delete" data-id="${item.id}">Excluir Story Base</button> 
                </div>`; 
            card.appendChild(contentDiv);
            card.querySelector('.btn-whatsapp').addEventListener('click', handleOpenWhatsAppModal); 
            card.querySelector('.btn-copy').addEventListener('click', handleCopyLink); 
            card.querySelector('.btn-delete').addEventListener('click', handleExcluirStoryBase); 
            return card; 
        } 
        
        function renderExistingLinks(links) { 
            existingLinksListDiv.innerHTML = ''; 
            const validLinks = (links || []).filter(link => link && (link.loja || link.url_production)); 
            if (validLinks.length === 0) { 
                existingLinksListDiv.innerHTML = '<p>Nenhum link existente para esta postagem.</p>'; 
                return; 
            } 
            const ul = document.createElement('ul'); 
            ul.style.listStyleType = 'none'; ul.style.paddingLeft = '0'; 
            validLinks.forEach(link => { 
                const li = document.createElement('li'); 
                li.style.marginBottom = '10px'; li.style.paddingBottom = '10px'; li.style.borderBottom = '1px dashed #eee'; 
                li.innerHTML = ` 
                    <strong>ID do Link:</strong> ${link.id || 'N/A'}<br> 
                    <strong>Loja:</strong> ${link.loja || 'N/A'}<br> 
                    <strong>Descrição:</strong> ${link.descricao || 'N/A'}<br> 
                    <strong>Categoria:</strong> ${link.categoria || 'N/A'}<br> 
                    <strong>URL:</strong> <a href="${link.url_production}" target="_blank">${link.url_production || 'N/A'}</a>`; 
                ul.appendChild(li); 
            }); 
            existingLinksListDiv.appendChild(ul); 
        }

        // --- Funções de API e Handlers ---
        async function fetchWithAuth(url, options = {}) {
            const headers = { ...options.headers };

            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            if (state.authToken) {
                headers['Authorization'] = `Basic ${state.authToken}`;
            }

            if (state.companyId) {
                if (options.body && typeof options.body === 'string' && options.method !== 'GET') {
                    try {
                        const bodyData = JSON.parse(options.body);
                        bodyData.company_id = state.companyId;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) {
                        console.warn("Could not add company_id to non-JSON body");
                    }
                } else {
                    const urlObj = new URL(url.startsWith('http') ? url : window.location.origin + url);
                    if (!urlObj.searchParams.has('company_id')) {
                       urlObj.searchParams.set('company_id', state.companyId);
                    }
                    url = urlObj.toString();
                }
            }

            const fetchOptions = {
                ...options,
                headers
            };

            try {
                const response = await fetch(url, fetchOptions);

                if (response.status === 401) { 
                    showAlert("A sua sessão expirou ou é inválida. Por favor, faça o login novamente.");
                    handleLogout(); 
                    throw new Error("Sessão expirada.");
                }

                return response;

            } catch (error) {
                throw error;
            }
        }

        async function fetchData() {
            if (!state.activeAccount || !state.activeMediaType) {
                console.log("Nenhuma conta ou tipo de mídia ativo. A saltar a busca de dados.");
                return;
            }
            showLoading("A carregar dados...");
            
            let baseUrl = '';
            const params = new URLSearchParams();
            
            if (state.activeAccount === 'WhatsApp') {
                baseUrl = url_base + API_URLS.WHATSAPP;
                params.append('conta_user_instagram', state.activeMediaType);
            } else {
                const mediaTypeConfig = MEDIA_TYPES.find(mt => mt.key === state.activeMediaType);
                if (!mediaTypeConfig) {
                    hideLoading();
                    showAlert("Tipo de mídia inválido.");
                    return;
                }
                baseUrl = url_base + mediaTypeConfig.endpoint;
                params.append('conta_user_instagram', state.activeAccount);
            }

            params.append('page', state.currentPage);
            params.append('limit', state.itemsPerPage);

            let url = `${baseUrl}?${params.toString()}`;

            try {
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status} ao buscar de ${url}`);
                
                const result = await response.json();
                
                if (result && typeof result === 'object' && !Array.isArray(result)) {
                    state.items = Array.isArray(result.data) ? result.data : [];
                    state.totalItems = result.totalItems || 0;
                    if (state.activeAccount === 'WhatsApp') {
                        state.whatsappLojas = result.lojas || [];
                    }
                } else if (Array.isArray(result)) {
                    state.items = result;
                    state.totalItems = result.length; 
                } else {
                    console.warn("Formato de resposta da API inesperado:", result);
                    state.items = [];
                    state.totalItems = 0;
                }
                
                if (['reels', 'stories'].includes(state.activeMediaType)) {
                    state.items.sort((a, b) => (new Date(b.media_created_at).getTime() || 0) - (new Date(a.media_created_at).getTime() || 0));
                }
                
                state.filteredItems = [...state.items];

            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    console.error(`Falha ao buscar dados para ${state.activeMediaType}:`, error);
                    showAlert(`Erro ao carregar dados: ${error.message}`);
                }
                state.items = [];
                state.totalItems = 0;
            } finally {
                hideLoading();
                renderItems();
                renderPaginationControls();
            }
        }
        
        function changePage(page) {
            state.currentPage = page;
            const currentHash = window.location.hash.split('?')[0];
            navigateTo(currentHash.slice(2).split('/')[0], currentHash.slice(2).split('/').slice(1), { page });
        }

        // --- Handlers de Ações (Salvar, Excluir, etc) ---
        async function handleSalvarEdicaoPost(event) { 
            const postId = event.target.dataset.id; 
            const cardElement = event.target.closest('.card'); if (!cardElement) return; 
            const payload = { 
                id: postId, 
                description: cardElement.querySelector(`#desc-${postId}`).value, 
                ordenacao_postagem: parseInt(cardElement.querySelector(`#ord-${postId}`).value), 
                categoria: cardElement.querySelector(`#cat-${postId}`).value, 
                revisado: cardElement.querySelector(`#rev-${postId}`).checked 
            }; 
            showLoading("Salvando post..."); 
            fetchWithAuth(API_URLS.UPDATE_POST, { method: "PUT", body: JSON.stringify(payload) })
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); })
                .then(() => { showAlert('Post atualizado!'); fetchData(); })
                .catch(error => { 
                    if (error.message !== "Sessão expirada.") {
                        console.error("Erro:", error); showAlert(`Erro: ${error.message}`); 
                    }
                })
                .finally(hideLoading);
        } 
        async function handleSalvarEdicaoReel(event) { 
            const reelId = event.target.dataset.id; 
            const cardElement = event.target.closest('.card'); if (!cardElement) return; 
            const payload = { 
                id: reelId, 
                caption: cardElement.querySelector(`#caption-${reelId}`).value, 
                media_product_type: event.target.dataset.type || 'REELS' 
            }; 
            showLoading("Salvando reel..."); 
            fetchWithAuth(API_URLS.UPDATE_POST, { method: "PUT", body: JSON.stringify(payload) }) 
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); }) 
                .then(() => { showAlert('Reel atualizado!'); fetchData(); }) 
                .catch(error => { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); }) 
                .finally(hideLoading); 
        } 
        async function handleRepostStory(event) { 
            const storyId = event.target.dataset.id; 
            const cardElement = event.target.closest('.card'); if (!cardElement) return; 
            const payload = { 
                id_story: storyId, 
                media_product_type: event.target.dataset.type || 'STORIES', 
                conta_user_instagram: event.target.dataset.conta 
            }; 
            showLoading("Repostando story..."); 
            fetchWithAuth(API_URLS.REPOST_STORIES, { method: "POST", body: JSON.stringify(payload) }) 
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); }) 
                .then(() => { showAlert('Story repostado!'); fetchData(); }) 
                .catch(error => { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); }) 
                .finally(hideLoading); 
        } 
        async function handleExcluirPost(event) {
            const postId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o item ID ${postId}?`);
            if (!confirmed) return;

            showLoading("Excluindo item...");
            
            const isScheduled = state.activeMediaType === 'scheduled-posts';
            const url = isScheduled ? API_URLS.SCHEDULED_POSTS_CRUD : API_URLS.DELETE_POST;
            const payload = { id: postId };

            fetchWithAuth(url, { method: "DELETE", body: JSON.stringify(payload) })
                .then(async response => {
                    if (!response.ok) throw new Error(await response.text());
                    try { return response.json(); } catch (e) { return {}; }
                })
                .then(data => {
                    showAlert(data.message || "Item excluído.");
                    fetchData();
                })
                .catch(error => {
                    console.error("Erro:", error);
                    showAlert(`Erro: ${error.message}`);
                })
                .finally(hideLoading);
        }
        async function handleDeleteReel(event) {
            const reelId = event.target.dataset.id;
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o Reel ID ${reelId}?`);
            if (!confirmed) return;
            showLoading("Excluindo Reel...");
            fetchWithAuth(API_URLS.DELETE_REEL, { method: "DELETE", body: JSON.stringify({ id: reelId }) })
                .then(async response => { if (!response.ok) throw new Error(await response.text()); try { return response.json(); } catch(e){ return {};} })
                .then(data => { showAlert(data.message || "Reel excluído."); fetchData(); })
                .catch(error => { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); })
                .finally(hideLoading);
        }
        async function handleExcluirStoryBase(event) { 
            const storyId = event.target.dataset.id; 
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o Story Base ID ${storyId}?`);
            if (!confirmed) return;
            showLoading("Excluindo Story Base..."); 
            fetchWithAuth(API_URLS.DELETE_STORIES, { method: "DELETE", body: JSON.stringify({ id: storyId }) }) 
                .then(async response => {  
                    if (!response.ok) throw new Error(await response.text());  
                    try { return response.json(); } catch(e){ return {}; } 
                }) 
                .then(data => { showAlert(data.message || "Story Base excluído."); fetchData(); }) 
                .catch(error => { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); }) 
                .finally(hideLoading); 
        } 
        function handleUploadVideo(event) { 
            const postId = event.target.dataset.id; const file = event.target.files[0]; if (!file) return; 
            if (!file.type.includes('video')) { showAlert("Envie um arquivo de vídeo (.mp4, .mov)."); event.target.value = null; return; } 
            if (file.size > 50 * 1024 * 1024) { showAlert("Vídeo grande (Max: 50MB)."); event.target.value = null; return; } 
            showLoading("Enviando vídeo..."); 
            const reader = new FileReader(); 
            reader.onload = async () => { 
                const formData = new FormData(); formData.append("video_base64", reader.result.split(',')[1]); formData.append("id", postId); 
                try { 
                    const response = await fetchWithAuth(API_URLS.UPLOAD_VIDEO, { method: 'POST', body: formData, headers: {'Content-Type': undefined} }); 
                    if (!response.ok) throw new Error(await response.text()); 
                    showAlert("✅ Vídeo enviado!"); fetchData(); 
                } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
                finally { hideLoading(); event.target.value = null; } 
            }; 
            reader.readAsDataURL(file); 
        } 
        async function handlePostarUnicoInstagram(event) { 
            const postId = event.target.dataset.id; 
            const post = state.items.find(p => String(p.id) === String(postId)); 
            if (!post) { showAlert("Post não encontrado."); return; } 
            
            if (state.activeMediaType === 'posts' && !post.check_reviewed) { 
                showAlert("Post precisa ser 'Revisado'."); 
                return; 
            } 
            
            const confirmed = await showConfirm(`Postar item ID ${post.id} no Instagram (${state.activeAccount})?`);
            if (!confirmed) return;
            showLoading("Postando no Instagram..."); 
            
            const endpoint = API_URLS.POST_INSTAGRAM_MANUAL;
            
            const payload = {
                id: postId,
                conta_user_instagram: state.activeAccount 
            };

            fetchWithAuth(endpoint, { method: 'POST', body: JSON.stringify(payload) }) 
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); }) 
                .then(data => { showAlert(data.message || "✅ Post enviado!"); fetchData(); }) 
                .catch(error => { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); }) 
                .finally(hideLoading); 
        }
        function handleCopyLink(event) { 
            const url = event.target.dataset.url; 
            if (url && navigator.clipboard) { 
                navigator.clipboard.writeText(url).then(() => showAlert("Link copiado!")).catch(() => legacyCopy(url)); 
            } else if (url) { legacyCopy(url); } else { showAlert("Nenhuma URL para copiar."); } 
        } 
        function legacyCopy(text) { 
            const ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.opacity = "0"; 
            document.body.appendChild(ta); ta.focus(); ta.select(); 
            try { if(document.execCommand('copy')) showAlert("Link copiado! (fallback)"); else showAlert("Falha (fallback).");} 
            catch (err) { showAlert("Falha (fallback).");} 
            document.body.removeChild(ta); 
        }
        
        // --- Funções de Modal ---
        function openModal(modalElement) { modalElement.style.display = 'flex'; }
        function closeModal(modalElement) { modalElement.style.display = 'none'; }
        
        function showAlert(message, title = 'Aviso') {
            document.getElementById('modalAlertTitle').textContent = title;
            document.getElementById('modalAlertMessage').textContent = message;
            openModal(document.getElementById('modalAlert'));
        }

        function showConfirm(message, title = 'Confirmação') {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('modalConfirm');
                const okBtn = document.getElementById('modalConfirmOk');
                const cancelBtn = document.getElementById('modalConfirmCancel');
                const closeBtns = confirmModal.querySelectorAll('.modal-close-btn, .modal-close-btn-alternative');

                document.getElementById('modalConfirmTitle').textContent = title;
                document.getElementById('modalConfirmMessage').textContent = message;

                const newOkBtn = okBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                const closeAndResolve = (value) => {
                    closeModal(confirmModal);
                    resolve(value);
                };

                newOkBtn.addEventListener('click', () => closeAndResolve(true));
                newCancelBtn.addEventListener('click', () => closeAndResolve(false));
                closeBtns.forEach(btn => btn.addEventListener('click', () => closeAndResolve(false)));
                confirmModal.addEventListener('click', e => {
                    if (e.target === confirmModal) closeAndResolve(false);
                }, { once: true });


                openModal(confirmModal);
            });
        }

        async function handleOpenLinkModal(event) { 
            const itemId = event.target.dataset.id; const type = event.target.dataset.type || 'post'; 
            linkFormPostId.value = itemId; formAddLinks.reset(); 
            const radio = formAddLinks.querySelector(`input[name="linkFormTipo"][value="${type}"]`) || formAddLinks.querySelector(`input[name="linkFormTipo"][value="post"]`); 
            if(radio) radio.checked = true; 
            existingLinksListDiv.innerHTML = '<p>Carregando...</p>'; openModal(modalAddLinks); 
            try { 
                const url = `${API_URLS.GET_LINKS_POSTAGENS}?id_post=${encodeURIComponent(itemId)}&type=${encodeURIComponent(type)}`; 
                const response = await fetchWithAuth(url); 
                if (!response.ok) throw new Error(await response.text()); 
                const links = await response.json(); 
                renderExistingLinks(Array.isArray(links) ? links : []); 
            } catch (error) { console.error("Erro:", error); existingLinksListDiv.innerHTML = `<p style="color:red;">Erro: ${error.message}</p>`; } 
        } 

        formAddLinks.addEventListener('submit', async (event) => { 
            event.preventDefault(); 
            const imageFile = linkFormImagem.files[0]; 
            let url_add_link = API_URLS.ADD_LINK;
            let imageBase64 = null; 
            if (imageFile) { 
                try { 
                    imageBase64 = await toBase64(imageFile); 
                    url_add_link = API_URLS.ADD_LINK_BASE64
                } catch (error) { 
                    console.error("Erro ao converter imagem para Base64:", error); 
                    showAlert("Houve um erro ao processar a imagem."); 
                    return; 
                } 
            } 
            const tipoSel = formAddLinks.querySelector('input[name="linkFormTipo"]:checked'); 
            if (!tipoSel) { 
                showAlert("Por favor, selecione o tipo (Post, Story ou Reels)."); 
                return; 
            } 
            const payload = { 
                id: linkFormPostId.value, 
                link_anuncio: linkFormLinkAnuncio.value.trim(), 
                loja_anuncio: linkFormLoja.value, 
                categoria_anuncio: linkFormCategoria.value.trim(), 
                tipo: tipoSel.value, 
                imagem_anuncio_base64: imageBase64 
            }; 
            if (!payload.link_anuncio || !payload.loja_anuncio) { 
                showAlert("Os campos 'Link do Anúncio' e 'Loja' são obrigatórios."); 
                return; 
            } 
            showLoading("Adicionando link..."); 
            try { 
                const response = await fetchWithAuth(url_add_link, { 
                    method: "POST", 
                    body: JSON.stringify(payload) 
                }); 
                const resText = await response.text(); 
                if (!response.ok) throw new Error(resText); 
                showAlert("Link incluído com sucesso: " + resText); 
                formAddLinks.reset(); 
                handleOpenLinkModal({ target: { dataset: { id: payload.id, type: payload.tipo } } }); 
            } catch (error) { 
                console.error("Erro ao adicionar link:", error); 
                showAlert(`Erro: ${error.message}`); 
            } finally { 
                hideLoading(); 
            } 
        }); 
        document.getElementById('btnSalvarNovaPalavra').addEventListener('click', async () => { 
            const palavra = inputNovaPalavra.value.trim(); if (!palavra) { showAlert("Digite uma palavra."); return; } 
            showLoading("Salvando palavra..."); 
            try { 
                const response = await fetchWithAuth(API_URLS.ADD_COMMENT_KEY, { method: "POST", body: JSON.stringify({ palavra }) }); 
                if (!response.ok) throw new Error(await response.text()); 
                showAlert("Palavra salva!"); state.palavrasSalvasComentario = palavra; 
                listaPalavrasDiv.innerHTML = palavra.replace(/\n/g, '<br>'); closeModal(modalPalavraComentario); fetchData(); 
            } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
            finally { hideLoading(); } 
        }); 
        function handleOpenWhatsAppModal(event) { 
            const videoUrl = event.target.dataset.videoUrl; 
            if (!videoUrl || videoUrl === "null" || videoUrl === "undefined") { showAlert("URL de vídeo indisponível."); return; } 
            whatsPostIdInput.value = event.target.dataset.id; whatsVideoUrlInput.value = videoUrl; 
            inputCustomNumberWhats.value = ''; customNumberInputContainer.style.display = 'none'; 
            openModal(modalEnviarWhatsApp); 
        } 
        document.querySelectorAll('.btn-send-direct-whats').forEach(b => b.addEventListener('click', e => enviarVideoWhatsApp(e.target.dataset.number))); 
        document.getElementById('btnShowCustomNumberWhats').addEventListener('click', () => { customNumberInputContainer.style.display = customNumberInputContainer.style.display === 'none' ? 'block' : 'none'; }); 
        document.getElementById('btnCopyVideoLinkWhats').addEventListener('click', () => { 
            const url = whatsVideoUrlInput.value; 
            if (url && url !== "null" && url !== "undefined") handleCopyLink({target: {dataset: {url: url}}}); else showAlert("URL de vídeo indisponível."); 
        }); 
        document.getElementById('btnSendCustomNumberWhats').addEventListener('click', () => { 
            const num = inputCustomNumberWhats.value.trim(); 
            if (num && /^\d+$/.test(num)) enviarVideoWhatsApp(num); else showAlert("Número inválido."); 
        }); 
        async function enviarVideoWhatsApp(numero) { 
            if (!numero) { showAlert("Número não fornecido."); return; } 
            const videoUrl = whatsVideoUrlInput.value; 
            if (!videoUrl || videoUrl === "null" || videoUrl === "undefined") { showAlert("URL do vídeo inválida."); return; } 
            const itemId = whatsPostIdInput.value; 
            const payload = {  
                numero,  
                id: itemId, 
                link: videoUrl,  
                type: "video", 
                tab: state.activeMediaType  
            }; 
            if(state.activeMediaType === 'carla-baby-stories-base'){ 
                const item = state.items.find(i => String(i.id) === String(itemId)); 
                if(item) { 
                    payload.url_production = item.url_product; 
                } 
            } 
            showLoading("Enviando para WhatsApp..."); 
            try { 
                const response = await fetchWithAuth(API_URLS.SEND_WHATS, { method: "POST", body: JSON.stringify(payload) }); 
                const resText = await response.text(); if (!response.ok) throw new Error(resText); 
                showAlert("Enviado para WhatsApp com sucesso!"); closeModal(modalEnviarWhatsApp); 
            } catch (error) { console.error("Erro:", error); showAlert(`Erro: ${error.message}`); } 
            finally { hideLoading(); } 
        }
        btnOpenCopyLinkByIdModal.addEventListener('click', () => { 
            copyLinkFormPostId.value = linkFormPostId.value; inputCopyLinkId.value = ''; openModal(modalCopyLinkById); 
        }); 
        formCopyLinkById.addEventListener('submit', async (event) => { 
            event.preventDefault(); 
            const id_post_original = copyLinkFormPostId.value; 
            const id_copy = inputCopyLinkId.value.trim(); 
            const tipoDoLinkOriginal = formAddLinks.querySelector('input[name="linkFormTipo"]:checked')?.value || 'post'; 
            if (!id_post_original || !id_copy) { 
                showAlert("Preencha o ID da postagem de destino e o ID do link a ser copiado."); 
                return; 
            } 
            if (id_post_original === id_copy) {  
                showAlert("O ID da postagem de destino não pode ser o mesmo do ID do link a copiar."); 
                return; 
            } 
            const payload = { 
                id_post: id_post_original,  
                id_copy: id_copy, 
                type: tipoDoLinkOriginal 
            }; 
            showLoading("Copiando link por ID..."); 
                 try { 
                     const response = await fetchWithAuth(API_URLS.COPY_LINK_BY_ID, { 
                         method: "POST", 
                         body: JSON.stringify(payload) 
                     }); 
                     const responseText = await response.text(); 
                     if (!response.ok) { 
                         throw new Error(`Erro HTTP ao copiar link: ${response.status} - ${responseText}`); 
                     } 
                     let resultMessage = responseText; 
                     try { 
                         const jsonResult = JSON.parse(responseText); 
                         resultMessage = jsonResult.message || responseText; 
                     } catch (e) { 
                         // Deixar resultMessage como responseText 
                     } 
                     showAlert(resultMessage || "✅ Link copiado com sucesso!"); 
                     closeModal(modalCopyLinkById); 
                     if (modalAddLinks.style.display === 'flex' && linkFormPostId.value) { 
                         handleOpenLinkModal({ target: { dataset: { id: linkFormPostId.value, type: tipoDoLinkOriginal } } }); 
                     } 
                 } catch (error) { 
                     console.error("Erro ao copiar link por ID:", error); 
                     showAlert(`Erro ao copiar link: ${error.message}`); 
                 } finally { 
                     hideLoading(); 
                 } 
            });

        // --- Funções para Ofertas WhatsApp ---

        function renderWhatsappContent() {
            const displayDiv = document.getElementById('contentDisplayArea');
            displayDiv.innerHTML = ''; // Limpa o conteúdo anterior
            displayDiv.className = ''; 

            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';

            const filtersDiv = document.createElement('div');
            filtersDiv.className = 'filters-container';
            
            const lojasOptions = state.whatsappLojas.map(loja => `<option value="${loja}">${loja}</option>`).join('');
            
            filtersDiv.innerHTML = `
                <div>
                    <label for="filter-loja">Filtrar por Loja:</label>
                    <select id="filter-loja">
                        <option value="">Todas as Lojas</option>
                        ${lojasOptions}
                    </select>
                </div>
            `;
            headerDiv.appendChild(filtersDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'header-actions';

            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn-primary';
            refreshBtn.textContent = 'Atualizar Lista';
            refreshBtn.addEventListener('click', fetchData);
            actionsDiv.appendChild(refreshBtn);

            const createBtn = document.createElement('button');
            createBtn.id = 'btn-create-offer';
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Oferta';
            createBtn.addEventListener('click', handleCreateOfferModal);
            actionsDiv.appendChild(createBtn);

            headerDiv.appendChild(actionsDiv);

            displayDiv.appendChild(headerDiv);

            filtersDiv.querySelectorAll('select').forEach(el => {
                el.addEventListener('change', applyWhatsappFilters);
            });

            const tableContainer = document.createElement('div');
            tableContainer.id = 'whatsapp-table-container';
            tableContainer.className = 'table-container';
            displayDiv.appendChild(tableContainer);

            applyWhatsappFilters();
        }

        function applyWhatsappFilters() {
            const filterLoja = document.getElementById('filter-loja')?.value || '';

            state.filteredItems = state.items.filter(item => {
                const matchesLoja = !filterLoja || item.loja === filterLoja;
                return matchesLoja;
            });

            renderWhatsappTable();
        }

        function renderWhatsappTable() {
            const container = document.getElementById('whatsapp-table-container');
            if (!container) return;

            if (state.filteredItems.length === 0 && !state.isLoading) {
                container.innerHTML = '<p style="padding: 20px; text-align: center;">Nenhum item encontrado com os filtros aplicados.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Loja</th>
                        <th>Grupo</th>
                        <th>Mensagem</th>
                        <th>URL</th>
                        <th>Imagem</th>
                        <th>Criado em</th>
                        <th>Modificado em</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.filteredItems.map(createWhatsappTableRow).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);

            table.querySelectorAll('.btn-edit-wpp, .wpp-image-container').forEach(el => el.addEventListener('click', handleEditWhatsappPost));
            table.querySelectorAll('.btn-delete-wpp').forEach(btn => btn.addEventListener('click', handleDeleteWhatsappPost));
            table.querySelectorAll('.btn-post-wpp').forEach(btn => btn.addEventListener('click', handlePostWhatsappAd));
        }
        
        function createWhatsappTableRow(item) {
            const imageUrl = item.image_base64 || '';
            let imageHtml = 'N/A';
            if (imageUrl) {
                const src = imageUrl.startsWith('http') ? imageUrl : `data:image/jpeg;base64,${imageUrl}`;
                imageHtml = `<div class="wpp-image-container" data-id="${item.id}" title="Ver/Editar Imagem">
                                     <img src="${src}" class="table-image-preview" alt="Preview">
                                   </div>`;
            }

            return `
                <tr id="wpp-row-${item.id}" data-item='${JSON.stringify(item)}'>
                    <td data-label="Loja">${item.loja || 'N/A'}</td>
                    <td data-label="Grupo">${item.grupo || 'N/A'}</td>
                    <td data-label="Mensagem" style="max-width: 250px; white-space: pre-wrap; word-break: break-word;">${item.message_parte1 || 'N/A'}</td>
                    <td data-label="URL"><a href="${item.url_production}" target="_blank">Link</a></td>
                    <td data-label="Imagem">${imageHtml}</td>
                    <td data-label="Criado em">${formatMediaDateTime(item["Created on"])}</td>
                    <td data-label="Modificado em">${formatMediaDateTime(item["Last modified"])}</td>
                    <td data-label="Ação">
                        <div class="action-buttons">
                            <button class="btn-edit-wpp" data-id="${item.id}">Editar</button>
                            <button class="btn-delete-wpp btn-delete" data-id="${item.id}">Excluir</button>
                            <button class="btn-post-wpp btn-whatsapp" data-id="${item.id}">Postar</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        async function handleEditWhatsappPost(event) {
            const id = event.currentTarget.dataset.id;
            const itemData = state.filteredItems.find(item => item.id == id);
            if (!itemData) return;
            state.newImageBase64 = null; // Limpa a imagem anterior

            await fetchWhatsappGroups(); // Garante que os grupos estão carregados

            document.getElementById('editWppId').value = itemData.id;
            document.getElementById('editWppLoja').value = itemData.loja || '';
            
            const grupoSelect = document.getElementById('editWppGrupo');
            populateGroupSelect(grupoSelect, state.whatsappGroups, itemData.grupo);
            
            document.getElementById('editWppMessage').value = itemData.message_parte1 || '';
            document.getElementById('editWppUrl').value = itemData.url_production || '';
            
            const preview = document.getElementById('editWppImagePreview');
            const btnOpenOriginal = document.getElementById('btnOpenOriginalImage');
            let originalImageUrl = '';

            if (itemData.image_base64 && itemData.image_base64.startsWith('http')) {
                 originalImageUrl = itemData.image_base64;
                 preview.src = originalImageUrl;
            } else if (itemData.image_base64) {
                 originalImageUrl = `data:image/jpeg;base64,${itemData.image_base64}`;
                 preview.src = originalImageUrl;
            } else {
                 preview.src = 'https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem';
            }

            if (originalImageUrl) {
                btnOpenOriginal.style.display = 'block';
                btnOpenOriginal.onclick = () => window.open(originalImageUrl, '_blank');
            } else {
                btnOpenOriginal.style.display = 'none';
            }
            
            document.getElementById('editWppNewImage').value = '';

            openModal(modalEditWhatsapp);
        }

        async function handleSaveWhatsappEdit(event) {
            event.preventDefault();
            
            const id = document.getElementById('editWppId').value;
            const accountName = state.activeMediaType; // CORREÇÃO
            
            const payload = {
                id: id,
                loja: document.getElementById('editWppLoja').value,
                grupo: document.getElementById('editWppGrupo').value,
                message_parte1: document.getElementById('editWppMessage').value,
                url_production: document.getElementById('editWppUrl').value,
                conta_user_instagram: accountName
            };

            if (state.newImageBase64) {
                payload.new_image_base64 = state.newImageBase64;
            }

            showLoading("Salvando alterações...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');

                showAlert('Oferta atualizada com sucesso!');
                closeModal(modalEditWhatsapp);
                fetchData();
            } catch (error) {
                console.error("Erro ao salvar oferta:", error);
                showAlert(`Erro ao salvar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteWhatsappPost(event) {
            const id = event.currentTarget.dataset.id;
            const itemData = state.filteredItems.find(item => item.id == id);
            if (!itemData) return;

            const confirmed = await showConfirm(`Tem certeza que deseja excluir a oferta de WhatsApp ID ${id}?`);
            if (!confirmed) return;

            const accountName = state.activeMediaType; // CORREÇÃO

            showLoading("Excluindo oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'DELETE',
                    body: JSON.stringify({ 
                        id: id, 
                        image_base64: itemData.image_base64,
                        conta_user_instagram: accountName 
                    })
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');

                showAlert('Oferta excluída com sucesso!');
                fetchData();
            } catch (error) {
                console.error("Erro ao excluir oferta:", error);
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handlePostWhatsappAd(event) {
            const id = event.currentTarget.dataset.id;
            const itemData = state.filteredItems.find(item => item.id == id);
            if (!itemData) return;

            const confirmed = await showConfirm(`Tem certeza que deseja POSTAR a oferta de WhatsApp ID ${id}?`);
            if (!confirmed) return;
            
            const accountName = state.activeMediaType; // CORREÇÃO
            
            const payload = {
                id: itemData.id,
                loja: itemData.loja,
                grupo: itemData.grupo,
                message_parte1: itemData.message_parte1,
                url_production: itemData.url_production,
                image_base64: itemData.image_base64,
                conta_user_instagram: accountName
            };

            showLoading("Postando oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_ACTION, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');

                showAlert('Oferta postada com sucesso!');
                fetchData();
            } catch (error) {
                console.error("Erro ao postar oferta:", error);
                showAlert(`Erro ao postar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleCreateOfferModal() {
            formCreateWhatsapp.reset();
            state.newImageBase64 = null;
            document.getElementById('createWppImagePreview').src = 'https://placehold.co/200x200/cccccc/ffffff?text=Sem+Imagem';
            
            await fetchWhatsappGroups(); // Garante que os grupos estão carregados
            
            openModal(modalCreateWhatsapp);
        }

        async function handleCreateOfferSubmit(event) {
            event.preventDefault();

            const accountName = state.activeMediaType; // CORREÇÃO

            const payload = {
                loja: document.getElementById('createWppLoja').value,
                message_parte1: document.getElementById('createWppMessage').value,
                url_production: document.getElementById('createWppUrl').value,
                image_base64: state.newImageBase64,
                conta_user_instagram: accountName
            };

            showLoading("Criando nova oferta...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_CREATE, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');

                showAlert('Nova oferta criada com sucesso!');
                closeModal(modalCreateWhatsapp);
                fetchData();
            } catch (error) {
                console.error("Erro ao criar oferta:", error);
                showAlert(`Erro ao criar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function populateGroupSelect(selectElement, groups, selectedValue = '') {
            selectElement.innerHTML = '<option value="">Selecione um grupo</option>';
            if (groups && groups.length > 0) {
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.group_name;
                    option.textContent = group.group_name;
                    if (group.group_name === selectedValue) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            }
        }

        // --- Funções de Gerenciamento de Contas ---
        async function showMediaContent(account, type) {
            state.activeAccount = account;
            state.activeMediaType = type;
            
            contentDisplayArea.style.display = 'block';
            paginationContainer.style.display = 'flex';

            await fetchData();
        }
        
        async function showSocialAccountsPage() {
            socialAccountsContentArea.style.display = 'block';
            await fetchSocialAccounts();
            renderSocialAccountsPage();
        }

        function renderSocialAccountsPage() {
            socialAccountsContentArea.innerHTML = '';
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Contas de Redes Sociais</h2>`;
            
            const createBtn = document.createElement('button');
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Rede Social';
            createBtn.addEventListener('click', () => {
                formCreateSocialAccount.reset();
                openModal(modalCreateSocialAccount);
            });
            headerDiv.appendChild(createBtn);
            socialAccountsContentArea.appendChild(headerDiv);
            
            const sortedAccounts = [...state.socialAccounts].sort((a, b) => {
                const orderA = a.ordenacao !== null && a.ordenacao !== undefined ? a.ordenacao : 999;
                const orderB = b.ordenacao !== null && b.ordenacao !== undefined ? b.ordenacao : 999;
                return orderA - orderB;
            });

            if (sortedAccounts.length === 0) {
                const noAccountsMessage = document.createElement('p');
                noAccountsMessage.textContent = 'Nenhuma conta social cadastrada.';
                socialAccountsContentArea.appendChild(noAccountsMessage);
                return;
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ordenação</th>
                        <th>Nome da Conta</th>
                        <th>Rede Social</th>
                        <th>Webhook</th>
                        <th>Validada</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedAccounts.map(acc => `
                        <tr data-account-id="${acc.id || acc.nome_conta}">
                            <td data-label="Ordenação">${acc.ordenacao || 'N/A'}</td>
                            <td data-label="Nome">${acc.nome_conta}</td>
                            <td data-label="Rede Social">${acc.social_media}</td>
                            <td data-label="Webhook" style="word-break: break-all;">${acc.webhook || 'N/A'}</td>
                            <td data-label="Validada" class="validated-icon">${acc.validated ? '✔️' : '❌'}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-edit-account">Editar</button>
                                    <button class="btn-delete-account btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            tableContainer.appendChild(table);
            socialAccountsContentArea.appendChild(tableContainer);
        }

        async function fetchSocialAccounts() {
            showLoading("Carregando contas...");
            try {
                const response = await fetchWithAuth(API_URLS.GET_ACCOUNTS);
                if (!response.ok) throw new Error("Não foi possível carregar as contas.");
                const result = await response.json();
                state.socialAccounts = result && Array.isArray(result.data) ? result.data : [];
            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar contas: ${error.message}`);
                }
                state.socialAccounts = [];
            } finally {
                hideLoading();
            }
        }

        async function handleCreateSocialAccount(event) {
            event.preventDefault();
            const payload = {
                social_media: document.getElementById('accountType').value,
                nome_conta: document.getElementById('accountName').value.trim(),
                ordenacao: parseInt(document.getElementById('accountOrder').value, 10) || null,
                token: document.getElementById('accountToken').value.trim(),
                webhook: document.getElementById('accountWebhook').value.trim(),
                validated: document.getElementById('accountValidated').checked
            };

            if (!payload.nome_conta || !payload.token) {
                showAlert("Nome da conta e Token são obrigatórios.");
                return;
            }

            showLoading("Salvando conta...");
            try {
                const response = await fetchWithAuth(API_URLS.CREATE_ACCOUNT, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar a conta.");

                showAlert("Conta salva com sucesso!");
                closeModal(modalCreateSocialAccount);
                await fetchSocialAccounts(); // Recarrega as contas
                renderSocialAccountsPage(); // Atualiza a tabela de contas
                renderSidebarMenu(); // Atualiza o menu
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function handleEditAccountModal(accountId) {
            const account = state.socialAccounts.find(acc => (acc.id || acc.nome_conta) == accountId);
            if (!account) {
                showAlert("Conta não encontrada.");
                return;
            }

            document.getElementById('editAccountId').value = account.id || account.nome_conta;
            document.getElementById('editAccountType').value = account.social_media;
            document.getElementById('editAccountName').value = account.nome_conta;
            document.getElementById('editAccountOrder').value = account.ordenacao || '';
            document.getElementById('editAccountToken').value = account.token;
            document.getElementById('editAccountWebhook').value = account.webhook || '';
            document.getElementById('editAccountValidated').checked = account.validated;

            openModal(modalEditSocialAccount);
        }

        async function handleUpdateSocialAccount(event) {
            event.preventDefault();
            const accountId = document.getElementById('editAccountId').value;
            const payload = {
                id: accountId,
                social_media: document.getElementById('editAccountType').value,
                nome_conta: document.getElementById('editAccountName').value.trim(),
                ordenacao: parseInt(document.getElementById('editAccountOrder').value, 10) || null,
                token: document.getElementById('editAccountToken').value.trim(),
                webhook: document.getElementById('editAccountWebhook').value.trim(),
                validated: document.getElementById('editAccountValidated').checked
            };

            showLoading("Atualizando conta...");
            try {
                const response = await fetchWithAuth(API_URLS.UPDATE_ACCOUNT, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Conta atualizada com sucesso!");
                closeModal(modalEditSocialAccount);
                await fetchSocialAccounts();
                renderSocialAccountsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao atualizar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteSocialAccount(accountId) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir a conta? Esta ação não pode ser desfeita.`);
            if (!confirmed) return;

            showLoading("Excluindo conta...");
            try {
                const response = await fetchWithAuth(API_URLS.DELETE_ACCOUNT, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: accountId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Conta excluída com sucesso!");
                await fetchSocialAccounts();
                renderSocialAccountsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // --- Funções para Gerenciamento de Grupos WhatsApp ---
        async function showWhatsappGroupsPage() {
            whatsappGroupsContentArea.style.display = 'block';
            await fetchWhatsappGroups();
            renderWhatsappGroupsPage();
        }

        async function fetchWhatsappGroups() {
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD);
                if (!response.ok) throw new Error("Não foi possível carregar os grupos.");
                const result = await response.json();
                state.whatsappGroups = result && Array.isArray(result.data) ? result.data : [];
            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar grupos do WhatsApp: ${error.message}`);
                }
                state.whatsappGroups = [];
            }
        }

        function renderWhatsappGroupsPage() {
            whatsappGroupsContentArea.innerHTML = '';
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Grupos do WhatsApp</h2>`;
            
            const createBtn = document.createElement('button');
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Grupo';
            createBtn.addEventListener('click', () => {
                formWhatsappGroup.reset();
                document.getElementById('whatsappGroupModalTitle').textContent = 'Criar Novo Grupo';
                openModal(modalWhatsappGroup);
            });
            headerDiv.appendChild(createBtn);
            whatsappGroupsContentArea.appendChild(headerDiv);

            if (state.whatsappGroups.length === 0) {
                whatsappGroupsContentArea.innerHTML += '<p>Nenhum grupo cadastrado.</p>';
                return;
            }
            
            const sortedGroups = [...state.whatsappGroups].sort((a, b) => (a.ordenacao || 999) - (b.ordenacao || 999));

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ordenação</th>
                        <th>Nome do Grupo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedGroups.map(group => `
                        <tr data-group-id="${group.id}">
                            <td data-label="Ordenação">${group.ordenacao || 'N/A'}</td>
                            <td data-label="Nome">${group.group_name}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-edit-wpp-group">Editar</button>
                                    <button class="btn-delete-wpp-group btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            tableContainer.appendChild(table);
            whatsappGroupsContentArea.appendChild(tableContainer);
        }

        async function handleWhatsappGroupFormSubmit(event) {
            event.preventDefault();
            const payload = {
                name: document.getElementById('whatsappGroupName').value.trim(),
                ordenacao: parseInt(document.getElementById('whatsappGroupOrder').value, 10) || null,
            };
            if (!payload.name) {
                showAlert("O nome do grupo é obrigatório.");
                return;
            }
            
            showLoading("Salvando grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar o grupo.");

                showAlert("Grupo salvo com sucesso!");
                closeModal(modalWhatsappGroup);
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function handleEditWhatsappGroupModal(group) {
            if (!group) return;
            document.getElementById('editWhatsappGroupId').value = group.id;
            document.getElementById('editWhatsappGroupName').value = group.group_name;
            document.getElementById('editWhatsappGroupOrder').value = group.ordenacao || '';
            openModal(modalEditWhatsappGroup);
        }
        
        async function handleUpdateWhatsappGroup(event) {
            event.preventDefault();
            const groupId = document.getElementById('editWhatsappGroupId').value;
            const payload = {
                id: groupId,
                name: document.getElementById('editWhatsappGroupName').value.trim(),
                ordenacao: parseInt(document.getElementById('editWhatsappGroupOrder').value, 10) || null,
            };

            showLoading("Atualizando grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Grupo atualizado com sucesso!");
                closeModal(modalEditWhatsappGroup);
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao atualizar: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleDeleteWhatsappGroup(groupId) {
             const confirmed = await showConfirm(`Tem certeza que deseja excluir este grupo?`);
            if (!confirmed) return;

            showLoading("Excluindo grupo...");
            try {
                const response = await fetchWithAuth(API_URLS.WHATSAPP_GROUPS_CRUD, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: groupId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Grupo excluído com sucesso!");
                await fetchWhatsappGroups();
                renderWhatsappGroupsPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // --- Funções de Admin (Empresas e Usuários) ---
        async function showCompaniesPage() {
            companiesContentArea.style.display = 'block';
            await fetchCompanies();
            renderCompaniesPage();
        }

        function handleEditCompanyDataModal(company) {
            document.getElementById('editCompanyId').value = company.id;
            document.getElementById('editCompanyName').value = company.name || '';
            document.getElementById('editCompanyEmail').value = company.email || '';
            document.getElementById('editCompanyWhatsapp').value = company.whatsapp || '';
            document.getElementById('editCompanyCnpjCpf').value = company.cnpj_cpf || '';

            openModal(document.getElementById('modalEditCompany'));
        }

        async function handleSaveCompanyData(event) {
            event.preventDefault();
            const companyId = document.getElementById('editCompanyId').value;
            const payload = {
                id: companyId,
                name: document.getElementById('editCompanyName').value.trim(),
                email: document.getElementById('editCompanyEmail').value.trim(),
                whatsapp: document.getElementById('editCompanyWhatsapp').value.trim(),
                cnpj_cpf: document.getElementById('editCompanyCnpjCpf').value.trim()
            };

            showLoading("Salvando dados da empresa...");
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar dados da empresa.");

                showAlert("Dados da empresa atualizados com sucesso!");
                closeModal(document.getElementById('modalEditCompany'));
                await fetchCompanies();
                renderCompaniesPage();
            } catch (error) {
                showAlert(`Erro ao salvar dados da empresa: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function fetchCompanies() {
            showLoading("Carregando empresas...");
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_CRUD);
                if (!response.ok) throw new Error("Não foi possível carregar as empresas.");
                const result = await response.json();
                state.companies = Array.isArray(result.data) ? result.data : [];
            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar empresas: ${error.message}`);
                }
                state.companies = [];
            } finally {
                hideLoading();
            }
        }

        function renderCompaniesPage() {
            companiesContentArea.innerHTML = '';
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Gerenciamento de Empresas</h2>`;
            companiesContentArea.appendChild(headerDiv);

            if (state.companies.length === 0) {
                companiesContentArea.innerHTML += '<p>Nenhuma empresa cadastrada ou disponível para gerenciamento.</p>';
                return;
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Nome da Empresa</th>
                        <th>CNPJ/CPF</th>
                        <th>E-mail</th>
                        <th>Módulos Ativos</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.companies.map(company => `
                        <tr data-company-id="${company.id}">
                            <td data-label="Nome">${company.name}</td>
                            <td data-label="CNPJ/CPF">${company.cnpj_cpf || 'N/A'}</td>
                            <td data-label="E-mail">${company.email || 'N/A'}</td>
                            <td data-label="Módulos">${formatCompanyModules(company.modules)}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-primary btn-edit-company-data">Editar Dados</button>
                                    <button class="btn-primary btn-edit-company-modules">Gerenciar Módulos</button>
                                    </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            tableContainer.appendChild(table);
            companiesContentArea.appendChild(tableContainer);

            table.querySelectorAll('.btn-edit-company-data').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyId = e.target.closest('tr').dataset.companyId;
                    const company = state.companies.find(c => c.id == companyId);
                    if (company) {
                        handleEditCompanyDataModal(company);
                    } else {
                        showAlert("Empresa não encontrada para edição.");
                    }
                });
            });

            table.querySelectorAll('.btn-edit-company-modules').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyId = e.target.closest('tr').dataset.companyId;
                    const company = state.companies.find(c => c.id == companyId);
                    if (company) {
                        handleEditCompanyModulesModal(company);
                    } else {
                        showAlert("Empresa não encontrada para edição.");
                    }
                });
            });
        }

        function formatCompanyModules(modules) {
            if (!modules) return 'N/A';
            const activeModules = [];
            for (const key in modules) {
                if (modules[key]) {
                    activeModules.push(key.charAt(0).toUpperCase() + key.slice(1)); // Capitaliza a primeira letra
                }
            }
            return activeModules.length > 0 ? activeModules.join(', ') : 'Nenhum';
        }

        function handleEditCompanyModulesModal(company) {
            document.getElementById('editCompanyModulesId').value = company.id;
            document.getElementById('editCompanyModulesName').textContent = company.name;

            document.getElementById('moduleInstagram').checked = company.modules?.instagram || false;
            document.getElementById('moduleFacebook').checked = company.modules?.facebook || false;
            document.getElementById('moduleThreads').checked = company.modules?.threads || false;
            document.getElementById('moduleWhatsapp').checked = company.modules?.whatsapp || false;

            openModal(document.getElementById('modalEditCompanyModules'));
        }

        async function handleSaveCompanyModules(event) {
            event.preventDefault();
            const companyId = document.getElementById('editCompanyModulesId').value;
            const payload = {
                id: companyId,
                modules: {
                    instagram: document.getElementById('moduleInstagram').checked,
                    facebook: document.getElementById('moduleFacebook').checked,
                    threads: document.getElementById('moduleThreads').checked,
                    whatsapp: document.getElementById('moduleWhatsapp').checked,
                }
            };

            showLoading("Salvando módulos...");
            try {
                const response = await fetchWithAuth(API_URLS.COMPANIES_MODULES_CRUD, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || "Erro ao salvar módulos.");

                showAlert("Módulos da empresa atualizados com sucesso!");
                closeModal(document.getElementById('modalEditCompanyModules'));
                await fetchCompanies();
                renderCompaniesPage();
                renderSidebarMenu();
            } catch (error) {
                showAlert(`Erro ao salvar módulos: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function showUsersPage() {
            usersContentArea.style.display = 'block';
            await fetchUsers();
            renderUsersPage();
        }

        async function fetchUsers() {
             showLoading("Carregando usuários...");
            try {
                const response = await fetchWithAuth(API_URLS.USERS_CRUD);
                if (!response.ok) throw new Error("Não foi possível carregar os usuários.");
                const result = await response.json();
                state.users = result && Array.isArray(result.data) ? result.data : [];
            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar usuários: ${error.message}`);
                }
                state.users = [];
            } finally {
                hideLoading();
            }
        }

        function renderUsersPage() {
            usersContentArea.innerHTML = '';
            const headerDiv = document.createElement('div');
            headerDiv.className = 'page-header';
            headerDiv.innerHTML = `<h2>Logins de Usuários</h2>`;

            const createBtn = document.createElement('button');
            createBtn.className = 'btn-primary';
            createBtn.textContent = 'Criar Login';
            createBtn.addEventListener('click', () => {
                formUser.reset();
                document.getElementById('userId').value = ''; // Limpa o ID para criação
                document.getElementById('userModalTitle').textContent = 'Criar Novo Login';
                userPasswordField.style.display = 'block'; // Mostra o campo de senha na criação
                userNameInput.value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userPassword').value = '';
                userIsActiveCheckbox.checked = true;
                userAdminCheckbox.checked = false;
                userDarkThemeCheckbox.checked = false;
                openModal(modalUser);
            });
            headerDiv.appendChild(createBtn);
            usersContentArea.appendChild(headerDiv);

            if (state.users.length === 0) {
                usersContentArea.innerHTML += '<p>Nenhum login cadastrado.</p>';
                return;
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Ativo</th>
                        <th>Admin</th>
                        <th>Tema Escuro</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${state.users.map(user => `
                        <tr data-user-id="${user.id}">
                            <td data-label="Nome">${user.name || 'N/A'}</td>
                            <td data-label="Email">${user.email}</td>
                            <td data-label="Ativo">${user.is_active ? '✔️' : '❌'}</td>
                            <td data-label="Admin">${user.admin ? '✔️' : '❌'}</td>
                            <td data-label="Tema Escuro">${user.dark_theme ? '✔️' : '❌'}</td>
                            <td data-label="Ações">
                                <div class="action-buttons">
                                    <button class="btn-primary btn-edit-user">Editar</button>
                                    <button class="btn-delete-user btn-delete">Excluir</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            tableContainer.appendChild(table);
            usersContentArea.appendChild(tableContainer);

            table.querySelectorAll('.btn-edit-user').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.target.closest('tr').dataset.userId;
                    const user = state.users.find(u => u.id == userId);
                    if (user) {
                        handleEditUserModal(user);
                    } else {
                        showAlert("Usuário não encontrado para edição.");
                    }
                });
            });
        }

        function handleEditUserModal(user) {
            document.getElementById('userModalTitle').textContent = 'Editar Login';
            document.getElementById('userId').value = user.id;
            userNameInput.value = user.name || '';
            document.getElementById('userEmail').value = user.email || '';
            userPasswordField.style.display = 'none';
            document.getElementById('userPassword').removeAttribute('required');
            userIsActiveCheckbox.checked = user.is_active || false;
            userAdminCheckbox.checked = user.admin || false;
            userDarkThemeCheckbox.checked = user.dark_theme || false;

            openModal(modalUser);
        }
        
        async function handleUserFormSubmit(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const isEditing = !!userId;

            const payload = {
                name: userNameInput.value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                is_active: userIsActiveCheckbox.checked,
                admin: userAdminCheckbox.checked,
                dark_theme: userDarkThemeCheckbox.checked,
                company_id: state.companyId
            };

            let method = 'POST';
            let url = API_URLS.USERS_CRUD;

            if (isEditing) {
                payload.id = userId;
                method = 'PUT';
            } else {
                payload.password = document.getElementById('userPassword').value;
                if (!payload.password) {
                    showAlert("A senha é obrigatória para novos logins.");
                    return;
                }
            }

            showLoading(isEditing ? "Salvando alterações do login..." : "Criando login...");
            try {
                const response = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || (isEditing ? "Erro ao salvar o login." : "Erro ao criar o login."));

                showAlert(isEditing ? "Login atualizado com sucesso!" : "Login criado com sucesso!");
                closeModal(modalUser);
                await fetchUsers();
                renderUsersPage();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
                document.getElementById('userPassword').setAttribute('required', 'true');
            }
        }

        async function handleDeleteUser(userId) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir este login?`);
            if (!confirmed) return;

            showLoading("Excluindo login...");
            try {
                const response = await fetchWithAuth(API_URLS.USERS_CRUD, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: userId })
                });
                if (!response.ok) throw new Error(await response.text());
                
                showAlert("Login excluído com sucesso!");
                await fetchUsers();
                renderUsersPage();
            } catch (error) {
                showAlert(`Erro ao excluir: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        // --- Funções de Login e Inicialização ---

        function handleLogout() {
            if(state.authToken) {
                fetchWithAuth(API_URLS.LOGOUT, { method: 'POST' }).catch(err => console.error("Falha ao notificar backend sobre logout:", err));
            }

            state.authToken = null;
            state.companyId = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('companyId');
            localStorage.removeItem('currentUser');
            
            window.location.hash = ''; // Limpa o hash para voltar à página de login
            window.location.reload();
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            showLoading("Autenticando...");

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const payload = {
                email: email,
                password: password
            };

            try {
                const response = await fetch(API_URLS.LOGIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json().catch(() => ({
                    message: `Erro no servidor: ${response.statusText}`
                }));

                if (response.ok && responseData.token && responseData.company_id && responseData.user) {
                    localStorage.setItem('authToken', responseData.token);
                    localStorage.setItem('companyId', responseData.company_id);
                    localStorage.setItem('currentUser', JSON.stringify(responseData.user));

                    window.location.hash = '#/dashboard'; // Redireciona para o dashboard
                    window.location.reload();
                } else {
                    loginError.textContent = responseData.message || 'E-mail ou senha inválidos.';
                }
            } catch (error) {
                console.error("Erro de rede durante o login:", error);
                loginError.textContent = 'Erro de conexão. Tente novamente.';
            } finally {
                hideLoading();
            }
}

        
        async function handleRegisterCompany(event) {
            event.preventDefault();
            registerError.textContent = '';
            showLoading("Cadastrando empresa...");
            
            const payload = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                whatsapp: document.getElementById('reg-whatsapp').value,
                cnpj_cpf: document.getElementById('reg-cnpj-cpf').value
            };

            try {
                const response = await fetch(API_URLS.COMPANIES_CRUD, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(responseData.message || "Erro ao cadastrar empresa.");
                }
                showAlert("Empresa cadastrada com sucesso! Você será redirecionado para o login.", "Sucesso");
                setTimeout(() => {
                    loginContainer.style.display = 'flex';
                    registerContainer.style.display = 'none';
                }, 2000);

            } catch (error) {
                registerError.textContent = error.message;
            } finally {
                hideLoading();
            }
        }

        async function initMainApp() {
            sidebar = document.getElementById('sidebar');
            dashboardContentArea = document.getElementById('dashboardContentArea');
            contentDisplayArea = document.getElementById('contentDisplayArea');
            socialAccountsContentArea = document.getElementById('socialAccountsContentArea');
            whatsappGroupsContentArea = document.getElementById('whatsappGroupsContentArea');
            companiesContentArea = document.getElementById('companiesContentArea');
            usersContentArea = document.getElementById('usersContentArea');
            paginationContainer = document.getElementById('paginationContainer');
            loadingOverlay = document.getElementById('loadingOverlayFull');
            scrollTopBtn = document.getElementById('scrollTopBtn');

            await Promise.all([
                fetchSocialAccounts(),
                fetchWhatsappGroups(),
                fetchCompanies()
            ]);
            
            setupEventListeners();
            await router(); // Chama o roteador para carregar a view inicial
        }

        // --- Funções para o modal de post agendado ---
        function handleOpenScheduledPostModal(post = null) {
            formScheduledPost.reset();
            document.getElementById('media-preview-container').innerHTML = '';
            state.scheduledPostFiles = [];

            if (post) { // Modo Edição
                document.getElementById('scheduledPostModalTitle').textContent = 'Editar Postagem';
                document.getElementById('scheduledPostId').value = post.id;
                document.getElementById('scheduledPostDescription').value = post.description || '';
                if (post.schedule_time) {
                    const d = new Date(post.schedule_time);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    document.getElementById('scheduledPostDateTime').value = d.toISOString().slice(0, 16);
                }
                if(post.media_urls && Array.isArray(post.media_urls)){
                    post.media_urls.forEach(url => {
                        const previewContainer = document.getElementById('media-preview-container');
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'media-preview-item';
                        if (url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.mov') || url.toLowerCase().includes('video')) {
                            itemDiv.innerHTML = `<video src="${url}"></video>`;
                        } else {
                            itemDiv.innerHTML = `<img src="${url}" alt="Preview">`;
                        }
                        previewContainer.appendChild(itemDiv);
                    });
                }

            } else { // Modo Criação
                document.getElementById('scheduledPostModalTitle').textContent = 'Criar Nova Postagem';
                document.getElementById('scheduledPostId').value = '';
            }

            openModal(modalScheduledPost);
        }

        async function handleScheduledPostFormSubmit(event) {
            event.preventDefault();
            const postId = document.getElementById('scheduledPostId').value;
            const isEditing = !!postId;

            showLoading(isEditing ? "Atualizando postagem..." : "Criando postagem...");

            const mediaBase64Promises = state.scheduledPostFiles.map(file => toBase64(file));
            const media_base64 = await Promise.all(mediaBase64Promises);

            const payload = {
                description: document.getElementById('scheduledPostDescription').value,
                schedule_time: document.getElementById('scheduledPostDateTime').value,
                media_base64: media_base64,
                conta_user_instagram: state.activeAccount
            };

            let url = API_URLS.SCHEDULED_POSTS_CRUD;
            let method = isEditing ? 'PUT' : 'POST';

            if(isEditing) {
                payload.id = postId;
            }

            try {
                const response = await fetchWithAuth(url, { method, body: JSON.stringify(payload) });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Erro no servidor');
                
                showAlert(isEditing ? 'Postagem atualizada com sucesso!' : 'Postagem criada com sucesso!');
                closeModal(modalScheduledPost);
                fetchData();
            } catch (error) {
                showAlert(`Erro: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // NOVO: Função para gerar anúncio a partir de um link
        async function handleGenerateAdFromLink() {
            const urlInput = document.getElementById('createWppUrl');
            const url = urlInput.value.trim();
            if (!url) {
                showAlert("Por favor, insira uma URL para gerar o anúncio.");
                return;
            }

            showLoading("Gerando dados do anúncio...");
            // try {
            //     const response = await fetchWithAuth(API_URLS.GENERATE_AD_FROM_LINK, {
            //         method: 'POST',
            //         body: JSON.stringify({ url: url })
            //     });
            //     const data = await response.json();
            //     if (!response.ok) throw new Error(data.message || "Não foi possível buscar os dados do link.");

            //     // Popula os campos com os dados retornados
            //     if (data.message) {
            //         document.getElementById('createWppMessage').value = data.message;
            //     }
            //     if (data.image_base64) {
            //         state.newImageBase64 = data.image_base64;
            //         document.getElementById('createWppImagePreview').src = `data:image/jpeg;base64,${data.image_base64}`;
            //     }
            //      if (data.loja) {
            //         document.getElementById('createWppLoja').value = data.loja;
            //     }

            //     showAlert("Dados do anúncio gerados com sucesso!");
            //     closeModal(btnGenerateAd); 
            // } catch (error) {
            //     console.error("Erro ao gerar anúncio do link:", error);
            //     showAlert(`Erro: ${error.message}`);
            // } finally {
            //     hideLoading();
            // }
            fetchWithAuth(API_URLS.GENERATE_AD_FROM_LINK, { method: "POST", body: JSON.stringify({ url: url }) })
                .then(async response => { if (!response.ok) throw new Error(await response.text()); return response.json(); })
                .then(() => { showAlert('Dados do anúncio gerados com sucesso!'); fetchData(); })
                .catch(error => { 
                    if (error.message !== "Sessão expirada.") {
                        console.error("Erro:", error); showAlert(`Erro: ${error.message}`); 
                    }
                })
                .finally(hideLoading);
            
        }

        // --- Funções do Dashboard ---
        async function showDashboardPage() {
            dashboardContentArea.style.display = 'block';
            await fetchDashboardMetrics();
        }

        async function fetchDashboardMetrics() {
            showLoading("Carregando métricas...");
            try {
                // Simulação de chamada de API
                // const response = await fetchWithAuth(API_URLS.GET_DASHBOARD_METRICS);
                // if (!response.ok) throw new Error("Não foi possível carregar as métricas.");
                // const metrics = await response.json();
                
                // Dados mocados para demonstração
                const mockMetrics = {
                    postsToday: 5,
                    reelsWeek: 12,
                    storiesMonth: 89,
                    postsWeek: 21,
                    reelsMonth: 45,
                    storiesToday: 15
                };
                
                renderDashboard(mockMetrics);

            } catch (error) {
                if (error.message !== "Sessão expirada.") {
                    showAlert(`Erro ao carregar métricas: ${error.message}`);
                }
                dashboardContentArea.innerHTML = '<p>Não foi possível carregar as métricas do dashboard.</p>';
            } finally {
                hideLoading();
            }
        }

        function renderDashboard(metrics) {
            dashboardContentArea.innerHTML = `
                <div class="page-header">
                    <h2>Dashboard de Métricas (Instagram)</h2>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="value">${metrics.postsToday}</div>
                        <div class="label">Posts Hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${metrics.storiesToday}</div>
                        <div class="label">Stories Hoje</div>
                    </div>
                     <div class="stat-card">
                        <div class="value">${metrics.reelsWeek}</div>
                        <div class="label">Reels na Semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${metrics.postsWeek}</div>
                        <div class="label">Posts na Semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${metrics.storiesMonth}</div>
                        <div class="label">Stories no Mês</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${metrics.reelsMonth}</div>
                        <div class="label">Reels no Mês</div>
                    </div>
                </div>
            `;
        }


        function setupEventListeners() {
             if (contentDisplayArea && scrollTopBtn) {
                 contentDisplayArea.addEventListener('scroll', () => {
                     if (contentDisplayArea.scrollTop > 200) {
                         scrollTopBtn.style.display = "block";
                     } else {
                         scrollTopBtn.style.display = "none";
                     }
                 });
                 scrollTopBtn.addEventListener('click', () => {
                     contentDisplayArea.scrollTo({ top: 0, behavior: 'smooth' });
                 });
             }

            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                document.body.classList.toggle('sidebar-collapsed');
            });

            document.getElementById('themeToggle').addEventListener('click', async () => {
                const isDark = document.body.classList.toggle('dark-theme');
                document.getElementById('themeToggle').querySelector('.toggle-circle').style.transform = isDark ? 'translateX(24px)' : 'translateX(2px)';

                if (state.authToken && state.currentUser && state.currentUser.id) {
                    try {
                        const payload = {
                            id: state.currentUser.id,
                            dark_theme: isDark
                        };
                        const response = await fetchWithAuth(API_URLS.USERS_CRUD, {
                            method: 'PUT',
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(await response.text());

                        state.currentUser.dark_theme = isDark;
                        localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                    } catch (error) {
                        console.error("Erro ao salvar tema:", error);
                        showAlert(`Erro ao salvar tema: ${error.message}`);
                        document.body.classList.toggle('dark-theme');
                        document.getElementById('themeToggle').querySelector('.toggle-circle').style.transform = isDark ? 'translateX(2px)' : 'translateX(24px)';
                    }
                }
            });
            
            formCreateSocialAccount.addEventListener('submit', handleCreateSocialAccount);
            formEditSocialAccount.addEventListener('submit', handleUpdateSocialAccount);

            socialAccountsContentArea.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-edit-account')) {
                    const accountId = e.target.closest('tr').dataset.accountId;
                    handleEditAccountModal(accountId);
                }
                if (e.target.classList.contains('btn-delete-account')) {
                    const accountId = e.target.closest('tr').dataset.accountId;
                    handleDeleteSocialAccount(accountId);
                }
            });

            whatsappGroupsContentArea.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('btn-edit-wpp-group')) {
                    const row = target.closest('tr');
                    const groupId = row.dataset.groupId;
                    const group = state.whatsappGroups.find(g => g.id == groupId);
                    handleEditWhatsappGroupModal(group);
                }
                if (target.classList.contains('btn-delete-wpp-group')) {
                    const groupId = target.closest('tr').dataset.groupId;
                    handleDeleteWhatsappGroup(groupId);
                }
            });
            formWhatsappGroup.addEventListener('submit', handleWhatsappGroupFormSubmit);
            formEditWhatsappGroup.addEventListener('submit', handleUpdateWhatsappGroup);
            
            usersContentArea.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-user')) {
                    const userId = e.target.closest('tr').dataset.userId;
                    handleDeleteUser(userId);
                }
            });
            formUser.addEventListener('submit', handleUserFormSubmit);

            sidebar.addEventListener('click', (e) => {
                if (!e.target.matches('.sidebar-actions .submenu-item')) return;
                
                switch (e.target.id) {
                    case 'sidebar-action-reload-stories': handleRecarregarStories(); break;
                    case 'sidebar-action-reload-reels': handleRecarregarReels(); break;
                    case 'sidebar-action-reload-posts': fetchData(); break;
                }
                // CORREÇÃO: Fecha o menu no mobile após a ação
                if (window.innerWidth <= 992) {
                    document.body.classList.add('sidebar-collapsed');
                }
            });


            document.getElementById('btnPasteLink').addEventListener('click', async () => {
                try {
                    if (!navigator.clipboard?.readText) {
                        throw new Error("A API de área de transferência não é suportada por este navegador.");
                    }
                    const text = await navigator.clipboard.readText();
                    document.getElementById('linkFormLinkAnuncio').value = text;
                } catch (err) {
                    console.error('Falha ao colar da área de transferência: ', err);
                    showAlert('Não foi possível ler da área de transferência. Verifique as permissões do navegador ou cole manualmente.');
                }
            });
            
             if (formEditWhatsapp) {
                 formEditWhatsapp.addEventListener('submit', handleSaveWhatsappEdit);
                 document.getElementById('editWppNewImage').addEventListener('change', async (e) => {
                     if (e.target.files && e.target.files[0]) {
                         state.newImageBase64 = await toBase64(e.target.files[0]);
                         document.getElementById('editWppImagePreview').src = `data:image/jpeg;base64,${state.newImageBase64}`;
                         document.getElementById('btnOpenOriginalImage').style.display = 'none';
                     }
                 });
             }
              if (formCreateWhatsapp) {
                 formCreateWhatsapp.addEventListener('submit', handleCreateOfferSubmit);
                 document.getElementById('createWppNewImage').addEventListener('change', async (e) => {
                     if (e.target.files && e.target.files[0]) {
                         state.newImageBase64 = await toBase64(e.target.files[0]);
                         document.getElementById('createWppImagePreview').src = `data:image/jpeg;base64,${state.newImageBase64}`;
                     }
                 });
             }
            
            formScheduledPost.addEventListener('submit', handleScheduledPostFormSubmit);
            document.getElementById('scheduledPostMedia').addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                state.scheduledPostFiles = files;
                const previewContainer = document.getElementById('media-preview-container');
                previewContainer.innerHTML = ''; // Limpa previews antigos
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'media-preview-item';
                        if (file.type.startsWith('image/')) {
                            itemDiv.innerHTML = `<img src="${e.target.result}" alt="${file.name}">`;
                        } else if (file.type.startsWith('video/')) {
                            itemDiv.innerHTML = `<video src="${e.target.result}"></video>`;
                        }
                        previewContainer.appendChild(itemDiv);
                    };
                    reader.readAsDataURL(file);
                });
            });

            document.getElementById('formEditCompanyModules').addEventListener('submit', handleSaveCompanyModules);
            document.getElementById('formEditCompany').addEventListener('submit', handleSaveCompanyData);
            document.getElementById('formUser').addEventListener('submit', handleUserFormSubmit);

            // Listeners para os novos botões no modal de criar oferta
            const btnGenerateAd = document.getElementById('btnGenerateAd');
            if (btnGenerateAd) {
                btnGenerateAd.addEventListener('click', handleGenerateAdFromLink);
            }

            const btnOpenAdUrl = document.getElementById('btnOpenAdUrl');
            if (btnOpenAdUrl) {
                btnOpenAdUrl.addEventListener('click', () => {
                    const url = document.getElementById('createWppUrl').value.trim();
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        showAlert("Nenhuma URL para abrir.");
                    }
                });
            }
        }

        // --- Ponto de Entrada da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            loginContainer = document.getElementById('login-container');
            registerContainer = document.getElementById('register-container');
            appContainer = document.getElementById('app-container');

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegisterCompany);

            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'flex';
            });

            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                loginContainer.style.display = 'flex';
                registerContainer.style.display = 'none';
            });

            document.querySelectorAll('.modal-close-btn, .modal-close-btn-alternative').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const modalId = event.target.dataset.modalId;
                    if (modalId) {
                        const modalToClose = document.getElementById(modalId);
                        if (modalToClose) closeModal(modalToClose);
                    }
                });
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (event) => {
                    if (event.target === overlay) closeModal(overlay);
                });
            });

            const savedToken = localStorage.getItem('authToken');
            const savedCompanyId = localStorage.getItem('companyId');
            const savedUser = localStorage.getItem('currentUser');

            let isLoggedIn = false;

            if (savedToken && savedCompanyId) {
                state.authToken = savedToken;
                state.companyId = savedCompanyId;

                if (savedUser && savedUser !== 'undefined' && savedUser !== 'null') {
                    try {
                        const user = JSON.parse(savedUser);
                        state.currentUser = user;

                        if (state.currentUser.dark_theme) {
                            document.body.classList.add('dark-theme');
                        } else {
                            document.body.classList.remove('dark-theme');
                        }
                        isLoggedIn = true;
                    } catch (e) {
                        console.error("Erro ao parsear 'currentUser' do localStorage. Limpando dados de login.", e);
                        handleLogout(); // Limpa tudo se os dados estiverem corrompidos
                    }
                }
            }

            if (isLoggedIn) {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                
                // Adiciona o listener para mudanças no hash (botões de voltar/avançar do navegador)
                window.addEventListener('hashchange', router);

                initMainApp();
            } else {
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

    </script>
</body>
</html>
